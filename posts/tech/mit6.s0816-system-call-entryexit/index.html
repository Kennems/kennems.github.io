<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">

<meta name="msvalidate.01" content="DF5FE493CC759E62BFE073BEA8EFD472" />
<title>MIT6.S081(6)-System Call Entry/Exit | Kennem&#39;s Blog</title>
<meta name="keywords" content="MIT6.S081">
<meta name="description" content="MIT6.S081(6)">
<meta name="author" content="ShowGuan">
<link rel="canonical" href="https://kennems.github.io/posts/tech/mit6.s0816-system-call-entryexit/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.915c20762c304dbee6179b74c308e69b9b1fbc661fecb4d1d1007529d55ca598.css" integrity="sha256-kVwgdiwwTb7mF5t0wwjmm5sfvGYf7LTR0QB1KdVcpZg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kennems.github.io/img/sun.png">
<link rel="apple-touch-icon" href="https://kennems.github.io/img/sun.png">
<link rel="mask-icon" href="https://kennems.github.io/img/sun.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://kennems.github.io/posts/tech/mit6.s0816-system-call-entryexit/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>


<link rel="stylesheet" href="https://fonts.cdnfonts.com/css/code-new-roman">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

<meta property="og:url" content="https://kennems.github.io/posts/tech/mit6.s0816-system-call-entryexit/">
  <meta property="og:site_name" content="Kennem&#39;s Blog">
  <meta property="og:title" content="MIT6.S081(6)-System Call Entry/Exit">
  <meta property="og:description" content="MIT6.S081(6)">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-10T19:30:13+08:00">
    <meta property="article:modified_time" content="2024-09-10T19:20:13+08:00">
    <meta property="article:tag" content="MIT6.S081">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT6.S081(6)-System Call Entry/Exit">
<meta name="twitter:description" content="MIT6.S081(6)">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "üìöÊñáÁ´†",
      "item": "https://kennems.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "üíªÊäÄÊúØ",
      "item": "https://kennems.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MIT6.S081(6)-System Call Entry/Exit",
      "item": "https://kennems.github.io/posts/tech/mit6.s0816-system-call-entryexit/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MIT6.S081(6)-System Call Entry/Exit",
  "name": "MIT6.S081(6)-System Call Entry\/Exit",
  "description": "MIT6.S081(6)",
  "keywords": [
    "MIT6.S081"
  ],
  "articleBody": "MIT6.S081(6)-System Call Entry/Exit Today: user -\u003e kernel transition system calls, faults, interrupts enter the kernel in the same way important for isolation and performance lots of careful design and important detail\nWhat needs to happen when a program makes a system call, e.g. write()? [CPU | user/kernel diagram] CPU resources are set up for user execution (not kernel) 32 registers, sp, pc, privilege mode, satp, stvec, sepc, ‚Ä¶ what needs to happen? save 32 user registers and pc switch to supervisor mode switch to kernel page table switch to kernel stack jump to kernel C code high-level goals don‚Äôt let user code interfere with user-\u003ekernel transition e.g. don‚Äôt execute user code in supervisor mode! transparent to user code ‚Äì resume without disturbing\nToday we‚Äôre focusing on the user/kernel transition and ignoring what the system call implemenation does once in the kernel but the sys call impl has to be careful and secure also!\nWhat does the CPU‚Äôs ‚Äúmode‚Äù protect? i.e. what does switching mode from user to supervisor allow? supervisor can use CPU control registers: satp ‚Äì page table physical address stvec ‚Äì ecall jumps here in kernel; points to trampoline sepc ‚Äì ecall saves user pc here sscratch ‚Äì address of trapframe supervisor can use PTEs that have no PTE_U flag but supervisor has no other powers! e.g. can‚Äôt use addresses that aren‚Äôt the in page table so kernel has to carefully set things up so it can work\npreview: write() write() returns User uservec() in trampoline.S userret() in trampoline.S Kernel usertrap() in trap.c usertrapret() in trap.c syscall() in syscall.c ^ sys_write() in sysfile.c ‚Äî|\nlet‚Äôs watch an xv6 system call entering/leaving the kernel xv6 shell writing its $ prompt sh.c line 137: write(2, ‚Äú$ ‚Äú, 2); user/usys.S line 29 this is the write() function, still in user space a7 tells the kernel what system call we want ‚Äì SYS_write = 16 ecall ‚Äì triggers the user/kernel transition\nlet‚Äôs start by putting a breakpoint on the ecall user/sh.asm says write()‚Äôs ecall is at address 0xde6\n$ make qemu-gdb (gdb) b *0xde6 (gdb) c (gdb) delete 1 (gdb) x/3i 0xde4\nlet‚Äôs look at the registers (gdb) print $pc (gdb) info reg\n$pc and $sp are at low addresses ‚Äì user memory starts at zero C on RISC-V puts function arguments in a0, a1, a2, \u0026c write() arguments: a0 is fd, a1 is buf, a2 is n\n(gdb) x/2c $a1\nthe shell is printing the $ prompt\nwhat page table is in use? (gdb) print/x $satp not very useful qemu: control-a c, info mem there are mappings for six pages instructions, data, stack guard (no PTE_U), stack, then two high mystery pages: trapframe and trampoline there are no mappings for kernel memory, devices, physical mem\nlet‚Äôs execute the ecall\n(gdb) stepi\nwhere are we? (gdb) print $pc we‚Äôre executing at a very high virtual address (gdb) x/6i 0x3ffffff000 these are the instructions we‚Äôre about to execute see uservec in kernel/trampoline.S it‚Äôs the start of the kernel‚Äôs trap handling code (gdb) info reg the registers hold user values (except $pc) qemu: info mem we‚Äôre still using the user page table note that $pc is in the trampoline page, the very last page\nwe‚Äôre executing in the ‚Äútrampoline‚Äù page, which contains the start of the kernel‚Äôs trap handling code. ecall doesn‚Äôt switch page tables, so these kernel instructions have to exist somewhere in the user page table. the trampoline page is the answer: the kernel maps it at the top of every user page table. the kernel sets $stvec to the trampoline page‚Äôs virtual address. the trampoline is protected: no PTE_U flag.\n(gdb) print/x $stvec\ncan we tell that we‚Äôre in supervisor mode? I don‚Äôt know a way to find the mode directly but observe $pc is executing in a page with no PTE_U flag lack of crash implies we are in supervisor mode\nhow did we get here? ecall did three things: change mode from user to supervisor save $pc in $sepc (gdb) print/x $sepc jump to $stvec (i.e. set $pc to $stvec) the kernel previously set $stvec, before jumping to user space\nnote: ecall lets user code switch to supervisor mode but the kernel immediately gains control via $stvec so the user program itself can‚Äôt execute as supervisor\nwhat needs to happen now? save the 32 user register values (for later transparent resume) switch to kernel page table set up stack for kernel C code jump to kernel C code\nwhy didn‚Äôt the RISC-V designers have ecall do these things for us? ecall does as little as possible: to give O/S designers scope for very fast syscalls / faults / intrs maybe O/S can handle some traps w/o switching page tables maybe we can map BOTH user and kernel into a single page table so no page table switch required maybe some registers do not have to be saved maybe no stack is required for simple system calls\nthere have been many clever schemes invented for kernel entry! different amounts of work by CPU different strategies for handler s/w performance here is often super important\nwhat are our options at this point for saving user registers? can we just write them somewhere convenient in physical memory? no, even supervisor mode is constrained to use the page table can we first set satp to the kernel page table? supervisor mode is allowed to set satp‚Ä¶ but we don‚Äôt know the address of the kernel page table at this point! and we need a free register to even execute csrw satp, $xx\ntwo parts to the solution for where to save the 32 user registers:\nxv6 maps a 2nd kernel page, the trapframe, into every user page table it has space to hold the saved registers the kernel gives each process a different trapframe page the page at 0x3fffffe000 is the trapframe page see struct trapframe in kernel/proc.h (but we still need a register holding the trapframe‚Äôs address‚Ä¶) RISC-V provides the sscratch register the kernel puts a pointer to the trapframe in sscratch before entering user space supervisor code can swap any register with sscratch thus both getting hold of the value in sscratch, and simultaneously saving the register‚Äôs user value see this at the start of uservec in trapframe.S: csrrw a0, sscratch, a0\nthe csrrw has already been executed due to some gdb quirk‚Ä¶\n(gdb) print/x $a0 address of the trapframe (gdb\u003e print/x $sscratch 0x2, the old first argument (fd)\nnow uservec() has 32 saves of user registers to the trapframe, via a0 so they can be restored later, when the system call returns let‚Äôs skip them\n(gdb) b *0x3ffffff076 (gdb) c\nnow we‚Äôre setting up to be able to run C code in the kernel first a stack previously, kernel put a pointer to top of this process‚Äôs kernel stack in trapframe look at struct trapframe in kernel/proc.h ‚Äúld sp, 8(a0)‚Äù fetches the kernel stack pointer remember a0 points to the trapframe at this point the only kernel data the code can get at is the trapframe, so everything has to be loaded from there.\n(gdb) stepi\nretrieve hart ID into tp\n(gdb) stepi\nwe want to jump to the kernel C function usertrap(), which the kernel previously saved in the trapframe. ‚Äúld t0, 16(a0)‚Äù fetches it into t0, we‚Äôll use it in a moment, after switching to the kernel page table\n(gdb) stepi\nload a pointer to the kernel pagetable from the trapframe, and load it into satp, and issue an sfence to clear the TLB.\n(gdb) stepi (gdb) stepi (gdb) stepi\nwhy isn‚Äôt there a crash at this point? after all we just switched page tables while executing! answer: the trampoline page is mapped at the same virtual address in the kernel page table as well as every user page table\n(gdb) print $pc qemu: info mem\nwith the kernel page table we can now use kernel functions and data\nthe jr t0 is a jump to usertrap() (using t0 retrieved from trapframe)\n(gdb) print/x $t0 (gdb) x/4i $t0 (gdb) stepi (gdb) tui enable\nwe‚Äôre now in usertrap() in kernel/trap.c various traps come here, e.g. errors, device interrupts, and system calls usertrap() looks in the scause register to see the trap cause see Figure 10.3 on page 102 of The RISC-V Reader scause = 8 is a system call\n(gdb) next ‚Ä¶ until syscall() (gdb) step (gdb) next\nnow we‚Äôre in syscall() kernel/syscall.c myproc() uses tp to retrieve current struct proc * p-\u003exxx is usually a slot in the current process‚Äôs struct proc\nsyscall() retrieves the system call number from saved register a7 p-\u003etrapframe points to the trapframe, with saved registers p-\u003etrapframe-\u003ea7 holds 16, SYS_write p-\u003etrapframe-\u003ea0 holds write() first argument ‚Äì fd p-\u003etrapframe-\u003ea1 holds buf p-\u003etrapframe-\u003ea2 holds n\n(gdb) next ‚Ä¶ (gdb) print num\nthen dispatches through syscall[num], a table of functions\n(gdb) next ‚Ä¶ (gdb) step\naha, we‚Äôre in sys_write. at this point system call implementations are fairly ordinary C code. let‚Äôs skip to the end, to see how a system call returns to user space.\n(gdb) finish\nnotice that write() produced console output (the shell‚Äôs $ prompt) back to syscall() the p-\u003etf-\u003ea0 assignment causes (eventually) a0 to hold the return value the C calling convention on RISC-V puts return values in a0\n(gdb) next\nback to usertrap()\n(gdb) print p-\u003etrapframe-\u003ea0\nwrite() returned 2 ‚Äì two characters ‚Äì $ and space\n(gdb) next (gdb) step\nnow we‚Äôre in usertrapret(), which starts the process of returning to the user program\nwe need to prepare for the next user-\u003ekernel transition stvec = uservec (the trampoline), for the next ecall traframe satp = kernel page table, for next uservec traframe sp = top of kernel stack trapframe trap = usertrap trapframe hartid = hartid (in tp)\nat the end, we‚Äôll use the RISC-V sret instruction we need to prepare a few registers that sret uses sstatus ‚Äì set the ‚Äúprevious mode‚Äù bit to user sepc ‚Äì the saved user program counter (from trap entry)\nwe‚Äôre going to switch to the user page table while executing not OK in usertrapret(), since it‚Äôs not mapped in the user page table. need a page that‚Äôs mapped in both user and kernel page table ‚Äì the trampoline. jump to userret in trampoline.S\n(gdb) tui disable (gdb) step (gdb) x/8i 0x3ffffff090\na0 holds TRAPFRAME a1 holds user page table address the csrw satp switches to the user address space\n(gdb) stepi (gdb) stepi (gdb) stepi\nthe csrw scratch puts the user a0 into sscratch just before sret we‚Äôll do a swap, so that a0 holds the user a0 and sscratch holds trapframe pointer. which is what uservec expects.\nnow 32 loads from the trapframe into registers these restore the user registers let‚Äôs skip over them\n(gdb) b *0x3ffffff10a (gdb) c\nhere‚Äôs the csrw that swaps a0 with sscratch\n(gdb) stepi (gdb) print/x $a0 ‚Äì the return value from write() (gdb) print/x $sscratch ‚Äì trapframe address for uservec\nnow we‚Äôre at the sret instruction\n(gdb) print $pc (gdb) stepi (gdb) print $pc\nnow we‚Äôre back in the user program ($pc = 0x0xdea) returning 2 from the write() function\n(gdb) print/x $a0\nand we‚Äôre done with a system call!\nsummary system call entry/exit is far more complex than function call much of the complexity is due to the requirement for isolation and the desire for simple and fast hardware mechanisms a few design questions to ponder: can an evil program abuse the entry mechanism? can you think of ways to make the hardware or software simpler? can you think of ways to make traps faster?\nLab: traps RISC-V assembly (easy) Which registers contain arguments to functions? For example, which register holds 13 in main‚Äôs call to printf? 13 -\u003e a2\n12 -\u003e a1\nÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞-\u003e a0 Âú®printf‰∏≠‰ª£Ë°®Ê†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤ÁöÑÂú∞ÂùÄÔºåÂú®exit(0)‰∏≠‰ª£Ë°®ÂèÇÊï∞0\nra(ËøîÂõûÂú∞ÂùÄ)\ns0(‰øùÂ≠òÂ∏ßÊåáÈíà)\nauipc xx, 0x0 ÈÄöËøáÂ∞ÜÂΩìÂâçPCÁöÑÈ´ò20‰ΩçÂä†‰∏ä‰∏Ä‰∏™Á´ãÂç≥Êï∞ÔºàÂú®Ëøô‰∏™‰æãÂ≠ê‰∏≠ÊòØ0x0ÔºåË°®Á§∫Ê≤°ÊúâÂÅèÁßªÔºâÊù•ÂΩ¢Êàê‰∏Ä‰∏™È´òÂú∞ÂùÄÈÉ®ÂàÜ„ÄÇËøô‰∏™ÁªìÊûú‰ºöÂ≠òÂÇ®Âú®ÁõÆÊ†áÂØÑÂ≠òÂô® xx ‰∏≠„ÄÇ\nWhere is the call to function f in the assembly code for main? Where is the call to g? (Hint: the compiler may inline functions.) printf(\"%d %d\\n\", f(8)+1, 13); 24:\t4635 li\ta2,13 26:\t45b1 li\ta1,12 ËøôÈáåÁõ¥Êé•Â∞ÜËÆ°ÁÆóÂêéÁöÑÂÄºÂÜôÂÖ•Âà∞ÂØÑÂ≠òÂô®‰∏≠ÔºåÈÄöËøáÂÜÖËÅîÁöÑÊñπÂºèË∞ÉÁî®ÂáΩÊï∞„ÄÇ\nAt what address is the function printf located? 34:\t600080e7 jalr\t1536(ra) # 630 $0x630$ ‰ΩçÁΩÆ\nWhat value is in the register ra just after the jalr to printf in main? 30:\t00000097 auipc\tra,0x0 34:\t600080e7 jalr\t1536(ra) # 630 \u003cprintf\u003e $0x630 = 0x30(ra) + 1536, ra = 0x30$\nRun the following code. unsigned int i = 0x00646c72; printf(\"H%x Wo%s\", 57616, \u0026i); ËæìÂá∫ Ôºö He110 World\nÂÖ∂‰∏≠57616ÂçÅÂÖ≠ËøõÂà∂Êï∞ÁªÑÁöÑasciiÁ†Å‰∏∫110\nÂõ†‰∏∫ RISC-V ÊòØ little-endian. ÂÜÖÂ≠ò‰∏≠Â≠òÂÇ®i‰∏∫ÈÄÜÂ∫èÁöÑÔºåÊâÄ‰ª•‰ºöÂÄíÂ∫è Ôºö\n0x72 (ASCII ‚Äòr‚Äô)\n0x6c (ASCII ‚Äôl')\n0x64 (ASCII ‚Äôd')\n0x00 (null terminator)\nIn the following code, what is going to be printed after 'y='? (note: the answer is not a specific value.) Why does this happen? printf(\"x=%d y=%d\", 3); Âõ†‰∏∫printf‰ºöÂ∞ùËØï‰ªéÊ†àÊàñËÄÖÂÜÖÂ≠ò‰∏äËØªÂèñËøô‰∏™Áº∫Â§±ÁöÑÂèÇÊï∞ÔºåËøô‰ºöÂØºËá¥Êú™ÂÆö‰πâÁöÑË°å‰∏∫ÔºåÂèØËÉΩ‰ºöËé∑ÂèñÂà∞‰ªªÊÑèÁöÑÂÜÖÂ≠ò‰∫ßÁîüÊú™Áü•ÁöÑÂÄºÔºåÂÖ∑‰ΩìÂèñÂÜ≥‰∫éÊ†àÂíåÂÜÖÂ≠òÁöÑÁöÑÁä∂ÊÄÅÔºåÁºñËØëË°å‰∏∫Âíå‰ºòÂåñÔºåËøêË°åÁéØÂ¢ÉÂíåÂÜÖÂ≠òÁöÑÁÆ°ÁêÜ„ÄÇ\nBacktrace (moderate) defs.h void backtrace(void); printf.c void backtrace(void) { uint64 p = r_fp(); while (p != PGROUNDUP(p)) { uint64 ra = *(uint64 *)(p - 8); uint64 fp = *(uint64 *)(p - 16); printf(\"%p\\n\", ra); p = fp; } } riscv.h Alarm (hard) proc.c p-\u003ealarm_interval = 0; p-\u003ealarm_handler = 0; p-\u003ealarm_tick_count = 0; p-\u003ealarm_handling = 0; if ((p-\u003ealarm_trapframe = (struct trapframe *)kalloc()) == 0) { release(\u0026p-\u003elock); return 0; } p-\u003ealarm_interval = 0; p-\u003ealarm_handler = 0; p-\u003ealarm_tick_count = 0; p-\u003ealarm_handling = 0; if (p-\u003ealarm_trapframe) kfree((void *)p-\u003ealarm_trapframe); // sys_sigalarm - Á≥ªÁªüË∞ÉÁî®ÔºåÁî®‰∫éËÆæÁΩÆ‰∏Ä‰∏™ËøõÁ®ãÁöÑÂÆöÊó∂ÈóπÈíü‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫è // // ÂèÇÊï∞Ôºö // Êó†Áõ¥Êé•ÂèÇÊï∞„ÄÇ‰ΩøÁî®‰∫Üargint()Âíåargaddr()Êù•‰ªéÁ≥ªÁªüË∞ÉÁî®ÂèÇÊï∞‰∏≠ÊèêÂèñÂÄº„ÄÇ // ËøîÂõûÂÄºÔºö // ÊàêÂäüËøîÂõû0ÔºåÂ§±Ë¥•ËøîÂõû-1„ÄÇ // // ÂäüËÉΩÔºö // ËØ•ÂáΩÊï∞ËÆæÁΩÆ‰∏Ä‰∏™ËøõÁ®ãÁöÑÂÆöÊó∂ÈóπÈíüÔºåÂΩìËÆ°Êó∂Âô®ËææÂà∞ÊåáÂÆöÁöÑtickÊï∞Êó∂ÔºåËß¶Âèë // Áî®Êà∑ÂÆö‰πâÁöÑ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÔºàhandlerÔºâ„ÄÇ // // ÂÖ∑‰ΩìÊù•ËØ¥Ôºö // 1. ‰ªéÁ≥ªÁªüË∞ÉÁî®ÂèÇÊï∞‰∏≠Ëé∑ÂèñÊåáÂÆöÁöÑtickÊï∞Âíå‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÁöÑÂú∞ÂùÄ„ÄÇ // 2. Âú®Â§±Ë¥•ÁöÑÊÉÖÂÜµ‰∏ãËøîÂõû-1„ÄÇ // 3. Â¶ÇÊûúÊàêÂäüËé∑ÂèñÂà∞Ëøô‰∫õÂèÇÊï∞ÔºåÊõ¥Êñ∞ÂΩìÂâçËøõÁ®ãÁöÑalarm_intervalÔºàÈóπÈíüÈó¥ÈöîÔºâ // Âíåalarm_handlerÔºàÈóπÈíüÂ§ÑÁêÜÁ®ãÂ∫èÔºâÔºåÂπ∂ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô®ÂíåÁä∂ÊÄÅ„ÄÇ uint64 sys_sigalarm(void) { int ticks; // Áî®‰∫éÂ≠òÂÇ®Áî®Êà∑‰º†ÂÖ•ÁöÑtickÊï∞ÔºàÈó¥ÈöîÊó∂Èó¥Ôºâ void (*handler)(); // Áî®‰∫éÂ≠òÂÇ®Áî®Êà∑‰º†ÂÖ•ÁöÑ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÁöÑÊåáÈíà // ‰ªéÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞Ëé∑ÂèñtickÊï∞ÔºåargintÁî®‰∫éËé∑ÂèñÊï¥Êï∞Á±ªÂûãÁöÑÂèÇÊï∞„ÄÇ if (argint(0, \u0026ticks) \u003c 0) return -1; // Ëé∑ÂèñÂ§±Ë¥•ÔºåËøîÂõû-1 // ‰ªéÁ¨¨‰∫å‰∏™ÂèÇÊï∞Ëé∑Âèñ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÁöÑÂú∞ÂùÄÔºåargaddrÁî®‰∫éËé∑ÂèñÊåáÈíàÁ±ªÂûãÁöÑÂèÇÊï∞„ÄÇ if (argaddr(1, (uint64 *)\u0026handler) \u003c 0) return -1; // Ëé∑ÂèñÂ§±Ë¥•ÔºåËøîÂõû-1 // Ëé∑ÂèñÂΩìÂâçÁöÑËøõÁ®ãÁªìÊûÑ‰ΩìÊåáÈíà struct proc *p = myproc(); // ËÆæÁΩÆËøõÁ®ãÁöÑÈóπÈíüÈó¥Èöî p-\u003ealarm_interval = ticks; // ËÆæÁΩÆËøõÁ®ãÁöÑ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫è p-\u003ealarm_handler = handler; // ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô® p-\u003ealarm_tick_count = 0; // ÂàùÂßãÂåñÈóπÈíüÂ§ÑÁêÜÁä∂ÊÄÅ‰∏∫Êú™Â§ÑÁêÜ p-\u003ealarm_handling = 0; // ËÆæÁΩÆÊàêÂäüÔºåËøîÂõû0 return 0; } // sys_sigreturn - Á≥ªÁªüË∞ÉÁî®ÔºåÁî®‰∫é‰ªé‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èËøîÂõûÂà∞‰∏ªÁ®ãÂ∫è // // ÂèÇÊï∞Ôºö // Êó†Áõ¥Êé•ÂèÇÊï∞„ÄÇ // ËøîÂõûÂÄºÔºö // ÊàêÂäüËøîÂõû0„ÄÇ // // ÂäüËÉΩÔºö // ËØ•ÂáΩÊï∞Áî®‰∫éÂΩì‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÔºàÂ¶ÇÈÄöËøásys_sigalarmËÆæÁΩÆÁöÑÂ§ÑÁêÜÁ®ãÂ∫èÔºâÊâßË°åÂÆåÊØïÊó∂Ôºå // ÊÅ¢Â§çËøõÁ®ãÁöÑ‰∏ä‰∏ãÊñáÁä∂ÊÄÅÔºå‰ΩøÂÖ∂ËøîÂõûÂà∞Â§ÑÁêÜ‰ø°Âè∑ÂâçÁöÑÊâßË°åÁä∂ÊÄÅ„ÄÇÂÖ∑‰ΩìÊ≠•È™§ÂåÖÊã¨Ôºö // 1. ÊÅ¢Â§çÈô∑Èò±Â∏ßÔºàtrapframeÔºâÔºåÂ∞Ü‰øùÂ≠òÁöÑalarm_trapframeÂÜÖÂÆπÊÅ¢Â§çÂà∞ÂΩìÂâçÁöÑtrapframe‰∏≠„ÄÇ // 2. ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô®ÂíåÂ§ÑÁêÜÁä∂ÊÄÅÔºåË°®Á§∫‰ø°Âè∑Â§ÑÁêÜÂ∑≤ÁªèÂÆåÊàê„ÄÇ uint64 sys_sigreturn(void) { struct proc *p = myproc(); // Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁöÑÊåáÈíà // ÊÅ¢Â§çËøõÁ®ãÁöÑtrapframeÔºåÂ∞Ü‰øùÂ≠òÁöÑalarm_trapframeÂÜÖÂÆπÂ§çÂà∂ÂõûÂΩìÂâçtrapframe„ÄÇ // trapframe‰øùÂ≠ò‰∫ÜËøõÁ®ãÂú®Â§ÑÁêÜ‰ø°Âè∑‰πãÂâçÁöÑCPUÂØÑÂ≠òÂô®Áä∂ÊÄÅ„ÄÇ *(p-\u003etrapframe) = *(p-\u003ealarm_trapframe); // ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô®ÔºåË°®Á§∫ÈóπÈíü‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÂ∑≤ÁªèÊâßË°åÂÆåÊØï„ÄÇ p-\u003ealarm_tick_count = 0; // ÈáçÁΩÆÈóπÈíüÁöÑÂ§ÑÁêÜÁä∂ÊÄÅÔºåË°®Á§∫ÂΩìÂâç‰∏çÂú®‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫è‰∏≠„ÄÇ p-\u003ealarm_handling = 0; // ÊàêÂäüËøîÂõû return 0; } proc.h int alarm_interval; void (*alarm_handler)(); int alarm_tick_count; int alarm_handling; struct trapframe *alarm_trapframe; riscv.h static inline uint64 r_fp() { uint64 x; asm volatile(\"mv %0, s0\" : \"=r\"(x)); return x; } syscall.c syscall.h trap.c // ok if (which_dev == 2) { if (p-\u003ealarm_interval != 0 \u0026\u0026 !p-\u003ealarm_handling) { ++p-\u003ealarm_tick_count; if (p-\u003ealarm_tick_count == p-\u003ealarm_interval) { *(p-\u003ealarm_trapframe) = *(p-\u003etrapframe); p-\u003etrapframe-\u003eepc = (uint64)(p-\u003ealarm_handler); p-\u003ealarm_handling = 1; } } } user.h usys.pl ",
  "wordCount" : "3445",
  "inLanguage": "zh",
  "datePublished": "2024-09-10T19:30:13+08:00",
  "dateModified": "2024-09-10T19:20:13+08:00",
  "author":{
    "@type": "Person",
    "name": "ShowGuan"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kennems.github.io/posts/tech/mit6.s0816-system-call-entryexit/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Kennem's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kennems.github.io/img/sun.png"
    }
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>




</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kennems.github.io/" accesskey="h" title="Kennem&#39;s Blog (Alt + H)">
                <img src="https://kennems.github.io/img/sun.png" alt="" aria-label="logo"
                    height="35">Kennem&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://kennems.github.io/" title="üè†‰∏ªÈ°µ">
                    <span>üè†‰∏ªÈ°µ</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/search" title="üîçÊêúÁ¥¢ (Alt &#43; /)" accesskey=/>
                    <span>üîçÊêúÁ¥¢</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/posts" title="üìöÊñáÁ´†">
                    <span>üìöÊñáÁ´†</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/archives" title="‚è±Êó∂Èó¥ËΩ¥">
                    <span>‚è±Êó∂Èó¥ËΩ¥</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/tags" title="üîñÊ†áÁ≠æ">
                    <span>üîñÊ†áÁ≠æ</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/categories" title="üóÇÔ∏èÂàÜÁ±ª">
                    <span>üóÇÔ∏èÂàÜÁ±ª</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/about" title="üôãüèª‚Äç‚ôÇÔ∏èÂÖ≥‰∫é">
                    <span>üôãüèª‚Äç‚ôÇÔ∏èÂÖ≥‰∫é</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://kennems.github.io/">‰∏ªÈ°µ</a>&nbsp;¬ª&nbsp;<a href="https://kennems.github.io/posts/">üìöÊñáÁ´†</a>&nbsp;¬ª&nbsp;<a href="https://kennems.github.io/posts/tech/">üíªÊäÄÊúØ</a></div>
    <h1 class="post-title entry-hint-parent">
      MIT6.S081(6)-System Call Entry/Exit
    </h1>
    <div class="post-description">
      MIT6.S081(6)
    </div>
    <div class="post-meta"><span title='2024-09-10 19:30:13 +0800 CST'>2024-09-10</span>&nbsp;¬∑&nbsp;7 ÂàÜÈíü&nbsp;¬∑&nbsp;3445 Â≠ó&nbsp;¬∑&nbsp;updated:&nbsp;2024-09-10&nbsp;¬∑&nbsp;ShowGuan

</div>
    
     <div class="post-password">
        
    </div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ÁõÆÂΩï</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#mit6s0816-system-call-entryexit" aria-label="MIT6.S081(6)-System Call Entry/Exit">MIT6.S081(6)-System Call Entry/Exit</a></li>
                    <li>
                        <a href="#lab-trapshttpspdoscsailmitedu6s0812020labstrapshtml" aria-label="Lab: traps"><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/traps.html">Lab: traps</a></a><ul>
                            
                    <li>
                        <a href="#risc-v-assembly-easyhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="RISC-V assembly (easy)">RISC-V assembly (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)</a><ul>
                            
                    <li>
                        <a href="#which-registers-contain-arguments-to-functions-for-example-which-register-holds-13-in-mains-call-to-printf" aria-label="Which registers contain arguments to functions? For example, which register holds 13 in main&rsquo;s call to printf?">Which registers contain arguments to functions? For example, which register holds 13 in main&rsquo;s call to <code>printf</code>?</a></li>
                    <li>
                        <a href="#where-is-the-call-to-function-f-in-the-assembly-code-for-main-where-is-the-call-to-g-hint-the-compiler-may-inline-functions" aria-label="Where is the call to function f in the assembly code for main? Where is the call to g? (Hint: the compiler may inline functions.)">Where is the call to function <code>f</code> in the assembly code for main? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)</a></li>
                    <li>
                        <a href="#at-what-address-is-the-function-printf-located" aria-label="At what address is the function printf located?">At what address is the function <code>printf</code> located?</a></li>
                    <li>
                        <a href="#what-value-is-in-the-register-ra-just-after-the-jalr-to-printf-in-main" aria-label="What value is in the register ra just after the jalr to printf in main?">What value is in the register <code>ra</code> just after the <code>jalr</code> to <code>printf</code> in <code>main</code>?</a></li>
                    <li>
                        <a href="#run-the-following-code" aria-label="Run the following code.">Run the following code.</a></li>
                    <li>
                        <a href="#in-the-following-code-what-is-going-to-be-printed-after-y-note-the-answer-is-not-a-specific-value-why-does-this-happen" aria-label="In the following code, what is going to be printed after &#39;y=&#39;? (note: the answer is not a specific value.) Why does this happen?">In the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?</a></li></ul>
                    </li>
                    <li>
                        <a href="#backtrace-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="Backtrace (moderate)">Backtrace (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)</a><ul>
                            
                    <li>
                        <a href="#defsh" aria-label="defs.h">defs.h</a></li>
                    <li>
                        <a href="#printfc" aria-label="printf.c">printf.c</a></li>
                    <li>
                        <a href="#riscvh" aria-label="riscv.h">riscv.h</a></li></ul>
                    </li>
                    <li>
                        <a href="#alarm-hardhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="Alarm (hard)">Alarm (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)</a><ul>
                            
                    <li>
                        <a href="#procc" aria-label="proc.c">proc.c</a></li>
                    <li>
                        <a href="#proch" aria-label="proc.h">proc.h</a></li>
                    <li>
                        <a href="#riscvh-1" aria-label="riscv.h">riscv.h</a></li>
                    <li>
                        <a href="#syscallc" aria-label="syscall.c">syscall.c</a></li>
                    <li>
                        <a href="#syscallh" aria-label="syscall.h">syscall.h</a></li>
                    <li>
                        <a href="#trapc" aria-label="trap.c">trap.c</a></li>
                    <li>
                        <a href="#userh" aria-label="user.h">user.h</a></li>
                    <li>
                        <a href="#usyspl" aria-label="usys.pl">usys.pl</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h1 id="mit6s0816-system-call-entryexit">MIT6.S081(6)-System Call Entry/Exit<a hidden class="anchor" aria-hidden="true" href="#mit6s0816-system-call-entryexit">#</a></h1>
<p>Today: user -&gt; kernel transition
system calls, faults, interrupts enter the kernel in the same way
important for isolation and performance
lots of careful design and important detail</p>
<p>What needs to happen when a program makes a system call, e.g. write()?
[CPU | user/kernel diagram]
CPU resources are set up for user execution (not kernel)
32 registers, sp, pc, privilege mode, satp, stvec, sepc, &hellip;
what needs to happen?
save 32 user registers and pc
switch to supervisor mode
switch to kernel page table
switch to kernel stack
jump to kernel C code
high-level goals
don&rsquo;t let user code interfere with user-&gt;kernel transition
e.g. don&rsquo;t execute user code in supervisor mode!
transparent to user code &ndash; resume without disturbing</p>
<p>Today we&rsquo;re focusing on the user/kernel transition
and ignoring what the system call implemenation does once in the kernel
but the sys call impl has to be careful and secure also!</p>
<p>What does the CPU&rsquo;s &ldquo;mode&rdquo; protect?
i.e. what does switching mode from user to supervisor allow?
supervisor can use CPU control registers:
satp &ndash; page table physical address
stvec &ndash; ecall jumps here in kernel; points to trampoline
sepc &ndash; ecall saves user pc here
sscratch &ndash; address of trapframe
supervisor can use PTEs that have no PTE_U flag
but supervisor has no other powers!
e.g. can&rsquo;t use addresses that aren&rsquo;t the in page table
so kernel has to carefully set things up so it can work</p>
<h2 id="write------------------------write-returns--------------user">preview:
write()                        write() returns              User</h2>
<p>uservec() in trampoline.S      userret() in trampoline.S   Kernel
usertrap() in trap.c           usertrapret() in trap.c
syscall() in syscall.c           ^
sys_write() in sysfile.c      &mdash;|</p>
<p>let&rsquo;s watch an xv6 system call entering/leaving the kernel
xv6 shell writing its $ prompt
sh.c line 137: write(2, &ldquo;$ &ldquo;, 2);
user/usys.S line 29
this is the write() function, still in user space
a7 tells the kernel what system call we want &ndash; SYS_write = 16
ecall &ndash; triggers the user/kernel transition</p>
<p>let&rsquo;s start by putting a breakpoint on the ecall
user/sh.asm says write()&rsquo;s ecall is at address 0xde6</p>
<p>$ make qemu-gdb
(gdb) b *0xde6
(gdb) c
(gdb) delete 1
(gdb) x/3i 0xde4</p>
<p>let&rsquo;s look at the registers
(gdb) print $pc
(gdb) info reg</p>
<p>$pc and $sp are at low addresses &ndash; user memory starts at zero
C on RISC-V puts function arguments in a0, a1, a2, &amp;c
write() arguments: a0 is fd, a1 is buf, a2 is n</p>
<p>(gdb) x/2c $a1</p>
<p>the shell is printing the $ prompt</p>
<p>what page table is in use?
(gdb) print/x $satp
not very useful
qemu: control-a c, info mem
there are mappings for six pages
instructions, data, stack guard (no PTE_U), stack,
then two high mystery pages: trapframe and trampoline
there are no mappings for kernel memory, devices, physical mem</p>
<p>let&rsquo;s execute the ecall</p>
<p>(gdb) stepi</p>
<p>where are we?
(gdb) print $pc
we&rsquo;re executing at a very high virtual address
(gdb) x/6i 0x3ffffff000
these are the instructions we&rsquo;re about to execute
see uservec in kernel/trampoline.S
it&rsquo;s the start of the kernel&rsquo;s trap handling code
(gdb) info reg
the registers hold user values (except $pc)
qemu: info mem
we&rsquo;re still using the user page table
note that $pc is in the trampoline page, the very last page</p>
<p>we&rsquo;re executing in the &ldquo;trampoline&rdquo; page, which contains the start of
the kernel&rsquo;s trap handling code. ecall doesn&rsquo;t switch page tables, so
these kernel instructions have to exist somewhere in the user page
table. the trampoline page is the answer: the kernel maps it at the
top of every user page table. the kernel sets $stvec to the trampoline
page&rsquo;s virtual address. the trampoline is protected: no PTE_U flag.</p>
<p>(gdb) print/x $stvec</p>
<p>can we tell that we&rsquo;re in supervisor mode?
I don&rsquo;t know a way to find the mode directly
but observe $pc is executing in a page with no PTE_U flag
lack of crash implies we are in supervisor mode</p>
<p>how did we get here?
ecall did three things:
change mode from user to supervisor
save $pc in $sepc
(gdb) print/x $sepc
jump to $stvec (i.e. set $pc to $stvec)
the kernel previously set $stvec, before jumping to user space</p>
<p>note: ecall lets user code switch to supervisor mode
but the kernel immediately gains control via $stvec
so the user program itself can&rsquo;t execute as supervisor</p>
<p>what needs to happen now?
save the 32 user register values (for later transparent resume)
switch to kernel page table
set up stack for kernel C code
jump to kernel C code</p>
<p>why didn&rsquo;t the RISC-V designers have ecall do these things for us?
ecall does as little as possible:
to give O/S designers scope for very fast syscalls / faults / intrs
maybe O/S can handle some traps w/o switching page tables
maybe we can map BOTH user and kernel into a single page table
so no page table switch required
maybe some registers do not have to be saved
maybe no stack is required for simple system calls</p>
<p>there have been many clever schemes invented for kernel entry!
different amounts of work by CPU
different strategies for handler s/w
performance here is often super important</p>
<p>what are our options at this point for saving user registers?
can we just write them somewhere convenient in physical memory?
no, even supervisor mode is constrained to use the page table
can we first set satp to the kernel page table?
supervisor mode is allowed to set satp&hellip;
but we don&rsquo;t know the address of the kernel page table at this point!
and we need a free register to even execute csrw satp, $xx</p>
<p>two parts to the solution for where to save the 32 user registers:</p>
<ol>
<li>xv6 maps a 2nd kernel page, the trapframe, into every user page table
it has space to hold the saved registers
the kernel gives each process a different trapframe page
the page at 0x3fffffe000 is the trapframe page
see struct trapframe in kernel/proc.h
(but we still need a register holding the trapframe&rsquo;s address&hellip;)</li>
<li>RISC-V provides the sscratch register
the kernel puts a pointer to the trapframe in sscratch
before entering user space
supervisor code can swap any register with sscratch
thus both getting hold of the value in sscratch,
and simultaneously saving the register&rsquo;s user value</li>
</ol>
<p>see this at the start of uservec in trapframe.S:
csrrw a0, sscratch, a0</p>
<p>the csrrw has already been executed due to some gdb quirk&hellip;</p>
<p>(gdb) print/x $a0
address of the trapframe
(gdb&gt; print/x $sscratch
0x2, the old first argument (fd)</p>
<p>now uservec() has 32 saves of user registers to the trapframe, via a0
so they can be restored later, when the system call returns
let&rsquo;s skip them</p>
<p>(gdb) b *0x3ffffff076
(gdb) c</p>
<p>now we&rsquo;re setting up to be able to run C code in the kernel
first a stack
previously, kernel put a pointer to top of this process&rsquo;s
kernel stack in trapframe
look at struct trapframe in kernel/proc.h
&ldquo;ld sp, 8(a0)&rdquo; fetches the kernel stack pointer
remember a0 points to the trapframe
at this point the only kernel data the code can
get at is the trapframe, so everything has to be loaded from there.</p>
<p>(gdb) stepi</p>
<p>retrieve hart ID into tp</p>
<p>(gdb) stepi</p>
<p>we want to jump to the kernel C function usertrap(), which
the kernel previously saved in the trapframe.
&ldquo;ld t0, 16(a0)&rdquo; fetches it into t0, we&rsquo;ll use it in a moment,
after switching to the kernel page table</p>
<p>(gdb) stepi</p>
<p>load a pointer to the kernel pagetable from the trapframe,
and load it into satp, and issue an sfence to clear the TLB.</p>
<p>(gdb) stepi
(gdb) stepi
(gdb) stepi</p>
<p>why isn&rsquo;t there a crash at this point?
after all we just switched page tables while executing!
answer: the trampoline page is mapped at the same virtual address
in the kernel page table as well as every user page table</p>
<p>(gdb) print $pc
qemu: info mem</p>
<p>with the kernel page table we can now use kernel functions and data</p>
<p>the jr t0 is a jump to usertrap() (using t0 retrieved from trapframe)</p>
<p>(gdb) print/x $t0
(gdb) x/4i $t0
(gdb) stepi
(gdb) tui enable</p>
<p>we&rsquo;re now in usertrap() in kernel/trap.c
various traps come here, e.g. errors, device interrupts, and system calls
usertrap() looks in the scause register to see the trap cause
see Figure 10.3 on page 102 of The RISC-V Reader
scause = 8 is a system call</p>
<p>(gdb) next &hellip; until syscall()
(gdb) step
(gdb) next</p>
<p>now we&rsquo;re in syscall() kernel/syscall.c
myproc() uses tp to retrieve current struct proc *
p-&gt;xxx is usually a slot in the current process&rsquo;s struct proc</p>
<p>syscall() retrieves the system call number from saved register a7
p-&gt;trapframe points to the trapframe, with saved registers
p-&gt;trapframe-&gt;a7 holds 16, SYS_write
p-&gt;trapframe-&gt;a0 holds write() first argument &ndash; fd
p-&gt;trapframe-&gt;a1 holds buf
p-&gt;trapframe-&gt;a2 holds n</p>
<p>(gdb) next &hellip;
(gdb) print num</p>
<p>then dispatches through syscall[num], a table of functions</p>
<p>(gdb) next &hellip;
(gdb) step</p>
<p>aha, we&rsquo;re in sys_write.
at this point system call implementations are fairly ordinary C code.
let&rsquo;s skip to the end, to see how a system call returns to user space.</p>
<p>(gdb) finish</p>
<p>notice that write() produced console output (the shell&rsquo;s $ prompt)
back to syscall()
the p-&gt;tf-&gt;a0 assignment causes (eventually) a0 to hold the return value
the C calling convention on RISC-V puts return values in a0</p>
<p>(gdb) next</p>
<p>back to usertrap()</p>
<p>(gdb) print p-&gt;trapframe-&gt;a0</p>
<p>write() returned 2 &ndash; two characters &ndash; $ and space</p>
<p>(gdb) next
(gdb) step</p>
<p>now we&rsquo;re in usertrapret(), which starts the process of returning
to the user program</p>
<p>we need to prepare for the next user-&gt;kernel transition
stvec = uservec (the trampoline), for the next ecall
traframe satp = kernel page table, for next uservec
traframe sp = top of kernel stack
trapframe trap = usertrap
trapframe hartid = hartid (in tp)</p>
<p>at the end, we&rsquo;ll use the RISC-V sret instruction
we need to prepare a few registers that sret uses
sstatus &ndash; set the &ldquo;previous mode&rdquo; bit to user
sepc &ndash; the saved user program counter (from trap entry)</p>
<p>we&rsquo;re going to switch to the user page table while executing
not OK in usertrapret(), since it&rsquo;s not mapped in the user page table.
need a page that&rsquo;s mapped in both user and kernel page table &ndash; the trampoline.
jump to userret in trampoline.S</p>
<p>(gdb) tui disable
(gdb) step
(gdb) x/8i 0x3ffffff090</p>
<p>a0 holds TRAPFRAME
a1 holds user page table address
the csrw satp switches to the user address space</p>
<p>(gdb) stepi
(gdb) stepi
(gdb) stepi</p>
<p>the csrw scratch puts the user a0 into sscratch
just before sret we&rsquo;ll do a swap,
so that a0 holds the user a0 and sscratch holds trapframe pointer.
which is what uservec expects.</p>
<p>now 32 loads from the trapframe into registers
these restore the user registers
let&rsquo;s skip over them</p>
<p>(gdb) b *0x3ffffff10a
(gdb) c</p>
<p>here&rsquo;s the csrw that swaps a0 with sscratch</p>
<p>(gdb) stepi
(gdb) print/x $a0 &ndash; the return value from write()
(gdb) print/x $sscratch &ndash; trapframe address for uservec</p>
<p>now we&rsquo;re at the sret instruction</p>
<p>(gdb) print $pc
(gdb) stepi
(gdb) print $pc</p>
<p>now we&rsquo;re back in the user program ($pc = 0x0xdea)
returning 2 from the write() function</p>
<p>(gdb) print/x $a0</p>
<p>and we&rsquo;re done with a system call!</p>
<p>summary
system call entry/exit is far more complex than function call
much of the complexity is due to the requirement for isolation
and the desire for simple and fast hardware mechanisms
a few design questions to ponder:
can an evil program abuse the entry mechanism?
can you think of ways to make the hardware or software simpler?
can you think of ways to make traps faster?</p>
<h1 id="lab-trapshttpspdoscsailmitedu6s0812020labstrapshtml"><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/traps.html">Lab: traps</a><a hidden class="anchor" aria-hidden="true" href="#lab-trapshttpspdoscsailmitedu6s0812020labstrapshtml">#</a></h1>
<h2 id="risc-v-assembly-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">RISC-V assembly (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)<a hidden class="anchor" aria-hidden="true" href="#risc-v-assembly-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h2>
<h3 id="which-registers-contain-arguments-to-functions-for-example-which-register-holds-13-in-mains-call-to-printf">Which registers contain arguments to functions? For example, which register holds 13 in main&rsquo;s call to <code>printf</code>?<a hidden class="anchor" aria-hidden="true" href="#which-registers-contain-arguments-to-functions-for-example-which-register-holds-13-in-mains-call-to-printf">#</a></h3>
<p>13 <code>-&gt;</code> a2</p>
<p>12 <code>-&gt;</code> a1</p>
<p>Á¨¨‰∏Ä‰∏™ÂèÇÊï∞<code>-&gt;</code> a0 Âú®printf‰∏≠‰ª£Ë°®Ê†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤ÁöÑÂú∞ÂùÄÔºåÂú®exit(0)‰∏≠‰ª£Ë°®ÂèÇÊï∞0</p>
<p><code>ra</code>(ËøîÂõûÂú∞ÂùÄ)</p>
<p><code>s0</code>(‰øùÂ≠òÂ∏ßÊåáÈíà)</p>
<p><code>auipc xx, 0x0</code> ÈÄöËøáÂ∞ÜÂΩìÂâçPCÁöÑÈ´ò20‰ΩçÂä†‰∏ä‰∏Ä‰∏™Á´ãÂç≥Êï∞ÔºàÂú®Ëøô‰∏™‰æãÂ≠ê‰∏≠ÊòØ0x0ÔºåË°®Á§∫Ê≤°ÊúâÂÅèÁßªÔºâÊù•ÂΩ¢Êàê‰∏Ä‰∏™È´òÂú∞ÂùÄÈÉ®ÂàÜ„ÄÇËøô‰∏™ÁªìÊûú‰ºöÂ≠òÂÇ®Âú®ÁõÆÊ†áÂØÑÂ≠òÂô® <code>x</code>x ‰∏≠„ÄÇ</p>
<h3 id="where-is-the-call-to-function-f-in-the-assembly-code-for-main-where-is-the-call-to-g-hint-the-compiler-may-inline-functions">Where is the call to function <code>f</code> in the assembly code for main? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)<a hidden class="anchor" aria-hidden="true" href="#where-is-the-call-to-function-f-in-the-assembly-code-for-main-where-is-the-call-to-g-hint-the-compiler-may-inline-functions">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">24</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">4635</span>                	li	a2,<span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">26</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">45</span>b1                	li	a1,<span style="color:#ae81ff">12</span>
</span></span></code></pre></div><p>ËøôÈáåÁõ¥Êé•Â∞ÜËÆ°ÁÆóÂêéÁöÑÂÄºÂÜôÂÖ•Âà∞ÂØÑÂ≠òÂô®‰∏≠ÔºåÈÄöËøáÂÜÖËÅîÁöÑÊñπÂºèË∞ÉÁî®ÂáΩÊï∞„ÄÇ</p>
<h3 id="at-what-address-is-the-function-printf-located">At what address is the function <code>printf</code> located?<a hidden class="anchor" aria-hidden="true" href="#at-what-address-is-the-function-printf-located">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">34:</span>	<span style="color:#960050;background-color:#1e0010">600080</span><span style="color:#a6e22e">e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">1536</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 630 &lt;printf&gt;
</span></span></span></code></pre></div><p>$0x630$ ‰ΩçÁΩÆ</p>
<h3 id="what-value-is-in-the-register-ra-just-after-the-jalr-to-printf-in-main">What value is in the register <code>ra</code> just after the <code>jalr</code> to <code>printf</code> in <code>main</code>?<a hidden class="anchor" aria-hidden="true" href="#what-value-is-in-the-register-ra-just-after-the-jalr-to-printf-in-main">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#ae81ff">30</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">000000</span><span style="color:#ae81ff">97</span>          	auipc	ra,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">34</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">600080e7</span>          	jalr	<span style="color:#ae81ff">1536</span>(ra) <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">630</span> <span style="color:#f92672">&lt;</span>printf<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>$0x630 = 0x30(ra) + 1536, ra = 0x30$</p>
<h3 id="run-the-following-code">Run the following code.<a hidden class="anchor" aria-hidden="true" href="#run-the-following-code">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00646c72</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;H%x Wo%s&#34;</span>, <span style="color:#ae81ff">57616</span>, <span style="color:#f92672">&amp;</span>i);
</span></span></code></pre></div><p>ËæìÂá∫ Ôºö He110 World</p>
<p>ÂÖ∂‰∏≠57616ÂçÅÂÖ≠ËøõÂà∂Êï∞ÁªÑÁöÑasciiÁ†Å‰∏∫110</p>
<p>Âõ†‰∏∫ RISC-V ÊòØ little-endian. ÂÜÖÂ≠ò‰∏≠Â≠òÂÇ®i‰∏∫ÈÄÜÂ∫èÁöÑÔºåÊâÄ‰ª•‰ºöÂÄíÂ∫è Ôºö</p>
<ul>
<li>
<p><code>0x72</code> (ASCII &lsquo;r&rsquo;)</p>
</li>
<li>
<p><code>0x6c</code> (ASCII &rsquo;l')</p>
</li>
<li>
<p><code>0x64</code> (ASCII &rsquo;d')</p>
</li>
<li>
<p><code>0x00</code> (null terminator)</p>
</li>
</ul>
<h3 id="in-the-following-code-what-is-going-to-be-printed-after-y-note-the-answer-is-not-a-specific-value-why-does-this-happen">In the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?<a hidden class="anchor" aria-hidden="true" href="#in-the-following-code-what-is-going-to-be-printed-after-y-note-the-answer-is-not-a-specific-value-why-does-this-happen">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x=%d y=%d&#34;</span>, <span style="color:#ae81ff">3</span>);
</span></span></code></pre></div><p>Âõ†‰∏∫<code>printf</code>‰ºöÂ∞ùËØï‰ªéÊ†àÊàñËÄÖÂÜÖÂ≠ò‰∏äËØªÂèñËøô‰∏™Áº∫Â§±ÁöÑÂèÇÊï∞ÔºåËøô‰ºöÂØºËá¥Êú™ÂÆö‰πâÁöÑË°å‰∏∫ÔºåÂèØËÉΩ‰ºöËé∑ÂèñÂà∞‰ªªÊÑèÁöÑÂÜÖÂ≠ò‰∫ßÁîüÊú™Áü•ÁöÑÂÄºÔºåÂÖ∑‰ΩìÂèñÂÜ≥‰∫éÊ†àÂíåÂÜÖÂ≠òÁöÑÁöÑÁä∂ÊÄÅÔºåÁºñËØëË°å‰∏∫Âíå‰ºòÂåñÔºåËøêË°åÁéØÂ¢ÉÂíåÂÜÖÂ≠òÁöÑÁÆ°ÁêÜ„ÄÇ</p>
<h2 id="backtrace-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml">Backtrace (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)<a hidden class="anchor" aria-hidden="true" href="#backtrace-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h2>
<h3 id="defsh">defs.h<a hidden class="anchor" aria-hidden="true" href="#defsh">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>            <span style="color:#a6e22e">backtrace</span>(<span style="color:#66d9ef">void</span>);
</span></span></code></pre></div><h3 id="printfc">printf.c<a hidden class="anchor" aria-hidden="true" href="#printfc">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240918143751681.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240918143751681.png" alt="image-20240918143751681"  />
        </a>
    </div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">backtrace</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 p <span style="color:#f92672">=</span> <span style="color:#a6e22e">r_fp</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (p <span style="color:#f92672">!=</span> <span style="color:#a6e22e">PGROUNDUP</span>(p))
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    uint64 ra <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint64 <span style="color:#f92672">*</span>)(p <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    uint64 fp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(uint64 <span style="color:#f92672">*</span>)(p <span style="color:#f92672">-</span> <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ra);
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> fp;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174643360.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174643360.png" alt="image-20240911174643360"  />
        </a>
    </div>
</p>
<h3 id="riscvh">riscv.h<a hidden class="anchor" aria-hidden="true" href="#riscvh">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174713519.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174713519.png" alt="image-20240911174713519"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174745719.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174745719.png" alt="image-20240911174745719"  />
        </a>
    </div>
</p>
<h2 id="alarm-hardhttpspdoscsailmitedu6s0812020labsguidancehtml">Alarm (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)<a hidden class="anchor" aria-hidden="true" href="#alarm-hardhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h2>
<h3 id="procc">proc.c<a hidden class="anchor" aria-hidden="true" href="#procc">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174828163.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174828163.png" alt="image-20240911174828163"  />
        </a>
    </div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_tick_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_handling <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((p<span style="color:#f92672">-&gt;</span>alarm_trapframe <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174852761.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174852761.png" alt="image-20240911174852761"  />
        </a>
    </div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_tick_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_handling <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>alarm_trapframe)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)p<span style="color:#f92672">-&gt;</span>alarm_trapframe);
</span></span></code></pre></div><p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174918091.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174918091.png" alt="image-20240911174918091"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174935724.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911174935724.png" alt="image-20240911174935724"  />
        </a>
    </div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// sys_sigalarm - Á≥ªÁªüË∞ÉÁî®ÔºåÁî®‰∫éËÆæÁΩÆ‰∏Ä‰∏™ËøõÁ®ãÁöÑÂÆöÊó∂ÈóπÈíü‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÂèÇÊï∞Ôºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   Êó†Áõ¥Êé•ÂèÇÊï∞„ÄÇ‰ΩøÁî®‰∫Üargint()Âíåargaddr()Êù•‰ªéÁ≥ªÁªüË∞ÉÁî®ÂèÇÊï∞‰∏≠ÊèêÂèñÂÄº„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ËøîÂõûÂÄºÔºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   ÊàêÂäüËøîÂõû0ÔºåÂ§±Ë¥•ËøîÂõû-1„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÂäüËÉΩÔºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   ËØ•ÂáΩÊï∞ËÆæÁΩÆ‰∏Ä‰∏™ËøõÁ®ãÁöÑÂÆöÊó∂ÈóπÈíüÔºåÂΩìËÆ°Êó∂Âô®ËææÂà∞ÊåáÂÆöÁöÑtickÊï∞Êó∂ÔºåËß¶Âèë
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   Áî®Êà∑ÂÆö‰πâÁöÑ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÔºàhandlerÔºâ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   ÂÖ∑‰ΩìÊù•ËØ¥Ôºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   1. ‰ªéÁ≥ªÁªüË∞ÉÁî®ÂèÇÊï∞‰∏≠Ëé∑ÂèñÊåáÂÆöÁöÑtickÊï∞Âíå‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÁöÑÂú∞ÂùÄ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   2. Âú®Â§±Ë¥•ÁöÑÊÉÖÂÜµ‰∏ãËøîÂõû-1„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   3. Â¶ÇÊûúÊàêÂäüËé∑ÂèñÂà∞Ëøô‰∫õÂèÇÊï∞ÔºåÊõ¥Êñ∞ÂΩìÂâçËøõÁ®ãÁöÑalarm_intervalÔºàÈóπÈíüÈó¥ÈöîÔºâ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      Âíåalarm_handlerÔºàÈóπÈíüÂ§ÑÁêÜÁ®ãÂ∫èÔºâÔºåÂπ∂ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô®ÂíåÁä∂ÊÄÅ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>uint64 <span style="color:#a6e22e">sys_sigalarm</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> ticks;         <span style="color:#75715e">// Áî®‰∫éÂ≠òÂÇ®Áî®Êà∑‰º†ÂÖ•ÁöÑtickÊï∞ÔºàÈó¥ÈöîÊó∂Èó¥Ôºâ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>handler)(); <span style="color:#75715e">// Áî®‰∫éÂ≠òÂÇ®Áî®Êà∑‰º†ÂÖ•ÁöÑ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÁöÑÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ‰ªéÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞Ëé∑ÂèñtickÊï∞ÔºåargintÁî®‰∫éËé∑ÂèñÊï¥Êï∞Á±ªÂûãÁöÑÂèÇÊï∞„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>ticks) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// Ëé∑ÂèñÂ§±Ë¥•ÔºåËøîÂõû-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ‰ªéÁ¨¨‰∫å‰∏™ÂèÇÊï∞Ëé∑Âèñ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÁöÑÂú∞ÂùÄÔºåargaddrÁî®‰∫éËé∑ÂèñÊåáÈíàÁ±ªÂûãÁöÑÂèÇÊï∞„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">argaddr</span>(<span style="color:#ae81ff">1</span>, (uint64 <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>handler) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// Ëé∑ÂèñÂ§±Ë¥•ÔºåËøîÂõû-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçÁöÑËøõÁ®ãÁªìÊûÑ‰ΩìÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ËÆæÁΩÆËøõÁ®ãÁöÑÈóπÈíüÈó¥Èöî
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>alarm_interval <span style="color:#f92672">=</span> ticks;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ËÆæÁΩÆËøõÁ®ãÁöÑ‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>alarm_handler <span style="color:#f92672">=</span> handler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>alarm_tick_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÂàùÂßãÂåñÈóπÈíüÂ§ÑÁêÜÁä∂ÊÄÅ‰∏∫Êú™Â§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>alarm_handling <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ËÆæÁΩÆÊàêÂäüÔºåËøîÂõû0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sys_sigreturn - Á≥ªÁªüË∞ÉÁî®ÔºåÁî®‰∫é‰ªé‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èËøîÂõûÂà∞‰∏ªÁ®ãÂ∫è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÂèÇÊï∞Ôºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   Êó†Áõ¥Êé•ÂèÇÊï∞„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ËøîÂõûÂÄºÔºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   ÊàêÂäüËøîÂõû0„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÂäüËÉΩÔºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   ËØ•ÂáΩÊï∞Áî®‰∫éÂΩì‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÔºàÂ¶ÇÈÄöËøásys_sigalarmËÆæÁΩÆÁöÑÂ§ÑÁêÜÁ®ãÂ∫èÔºâÊâßË°åÂÆåÊØïÊó∂Ôºå
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   ÊÅ¢Â§çËøõÁ®ãÁöÑ‰∏ä‰∏ãÊñáÁä∂ÊÄÅÔºå‰ΩøÂÖ∂ËøîÂõûÂà∞Â§ÑÁêÜ‰ø°Âè∑ÂâçÁöÑÊâßË°åÁä∂ÊÄÅ„ÄÇÂÖ∑‰ΩìÊ≠•È™§ÂåÖÊã¨Ôºö
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   1. ÊÅ¢Â§çÈô∑Èò±Â∏ßÔºàtrapframeÔºâÔºåÂ∞Ü‰øùÂ≠òÁöÑalarm_trapframeÂÜÖÂÆπÊÅ¢Â§çÂà∞ÂΩìÂâçÁöÑtrapframe‰∏≠„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   2. ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô®ÂíåÂ§ÑÁêÜÁä∂ÊÄÅÔºåË°®Á§∫‰ø°Âè∑Â§ÑÁêÜÂ∑≤ÁªèÂÆåÊàê„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>uint64 <span style="color:#a6e22e">sys_sigreturn</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>(); <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁöÑÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÊÅ¢Â§çËøõÁ®ãÁöÑtrapframeÔºåÂ∞Ü‰øùÂ≠òÁöÑalarm_trapframeÂÜÖÂÆπÂ§çÂà∂ÂõûÂΩìÂâçtrapframe„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// trapframe‰øùÂ≠ò‰∫ÜËøõÁ®ãÂú®Â§ÑÁêÜ‰ø°Âè∑‰πãÂâçÁöÑCPUÂØÑÂ≠òÂô®Áä∂ÊÄÅ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">*</span>(p<span style="color:#f92672">-&gt;</span>trapframe) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(p<span style="color:#f92672">-&gt;</span>alarm_trapframe);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈáçÁΩÆÈóπÈíüÁöÑËÆ°Êï∞Âô®ÔºåË°®Á§∫ÈóπÈíü‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫èÂ∑≤ÁªèÊâßË°åÂÆåÊØï„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>alarm_tick_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈáçÁΩÆÈóπÈíüÁöÑÂ§ÑÁêÜÁä∂ÊÄÅÔºåË°®Á§∫ÂΩìÂâç‰∏çÂú®‰ø°Âè∑Â§ÑÁêÜÁ®ãÂ∫è‰∏≠„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>alarm_handling <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÊàêÂäüËøîÂõû
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="proch">proc.h<a hidden class="anchor" aria-hidden="true" href="#proch">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175018175.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175018175.png" alt="image-20240911175018175"  />
        </a>
    </div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> alarm_interval;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>alarm_handler)();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> alarm_tick_count;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> alarm_handling;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>alarm_trapframe;
</span></span></code></pre></div><h3 id="riscvh-1">riscv.h<a hidden class="anchor" aria-hidden="true" href="#riscvh-1">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175042873.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175042873.png" alt="image-20240911175042873"  />
        </a>
    </div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">r_fp</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 x;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;mv %0, s0&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;=r&#34;</span>(x));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> x;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="syscallc">syscall.c<a hidden class="anchor" aria-hidden="true" href="#syscallc">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175143670.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175143670.png" alt="image-20240911175143670"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175120740.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175120740.png" alt="image-20240911175120740"  />
        </a>
    </div>
</p>
<h3 id="syscallh">syscall.h<a hidden class="anchor" aria-hidden="true" href="#syscallh">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175157747.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175157747.png" alt="image-20240911175157747"  />
        </a>
    </div>
</p>
<h3 id="trapc">trap.c<a hidden class="anchor" aria-hidden="true" href="#trapc">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175236189.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175236189.png" alt="image-20240911175236189"  />
        </a>
    </div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#75715e">// ok
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (which_dev <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>alarm_interval <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>p<span style="color:#f92672">-&gt;</span>alarm_handling)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>p<span style="color:#f92672">-&gt;</span>alarm_tick_count;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>alarm_tick_count <span style="color:#f92672">==</span> p<span style="color:#f92672">-&gt;</span>alarm_interval)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span>(p<span style="color:#f92672">-&gt;</span>alarm_trapframe) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(p<span style="color:#f92672">-&gt;</span>trapframe);
</span></span><span style="display:flex;"><span>          p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>epc <span style="color:#f92672">=</span> (uint64)(p<span style="color:#f92672">-&gt;</span>alarm_handler);
</span></span><span style="display:flex;"><span>          p<span style="color:#f92672">-&gt;</span>alarm_handling <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h3 id="userh">user.h<a hidden class="anchor" aria-hidden="true" href="#userh">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175252234.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175252234.png" alt="image-20240911175252234"  />
        </a>
    </div>
</p>
<h3 id="usyspl">usys.pl<a hidden class="anchor" aria-hidden="true" href="#usyspl">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175321847.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240911175321847.png" alt="image-20240911175321847"  />
        </a>
    </div>
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kennems.github.io/tags/mit6.s081/">MIT6.S081</a></li>
    </ul>
        
    
    <ul id="categories">
      
        <li><a href="https://kennems.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">Êìç‰ΩúÁ≥ªÁªü</a> </li>
      
    </ul>
    
    
<nav class="paginav">
  <a class="prev" href="https://kennems.github.io/posts/tech/mit6.s0817-qa/">
    <span class="title">¬´ ‰∏ä‰∏ÄÈ°µ</span>
    <br>
    <span>MIT6.S081(7)-Q&amp;A</span>
  </a>
  <a class="next" href="https://kennems.github.io/posts/tech/mit6.s0815-risc-v-calling-convention-stack-frames-and-gdb/">
    <span class="title">‰∏ã‰∏ÄÈ°µ ¬ª</span>
    <br>
    <span>MIT6.S081(5)-RISC-V calling convention, stack frames, and gdb</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://kennems.github.io/">Kennem&#39;s Blog</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Â§çÂà∂';

        function copyingDone() {
            copybutton.innerHTML = 'Â∑≤Â§çÂà∂ÔºÅ';
            setTimeout(() => {
                copybutton.innerHTML = 'Â§çÂà∂';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
<footer class="footer">
    <script async src="https://busuanzi.sukap.cn/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        Visitors: <span id="busuanzi_value_page_uv"></span>
        Views: <span id="busuanzi_value_page_pv"></span>

        
    </span>
</footer>



</body>

</html>
