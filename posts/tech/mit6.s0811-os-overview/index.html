<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">

<meta name="msvalidate.01" content="DF5FE493CC759E62BFE073BEA8EFD472" />
<title>MIT6.S081(1)-O/S overview | Kennem&#39;s Blog</title>
<meta name="keywords" content="MIT6.S081">
<meta name="description" content="MIT6.S081(1)">
<meta name="author" content="ShowGuan">
<link rel="canonical" href="https://kennems.github.io/posts/tech/mit6.s0811-os-overview/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6fdd1949bc615fbdbd83115b51397fd1d48449cdd9f5e872a98212bb78d466ea.css" integrity="sha256-b90ZSbxhX729gxFbUTl/0dSESc3Z9ehyqYISu3jUZuo=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kennems.github.io/img/sun.png">
<link rel="apple-touch-icon" href="https://kennems.github.io/img/sun.png">
<link rel="mask-icon" href="https://kennems.github.io/img/sun.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://kennems.github.io/posts/tech/mit6.s0811-os-overview/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>


<link href="https://fonts.cdnfonts.com/css/code-new-roman" rel="stylesheet">
                
  

<meta property="og:url" content="https://kennems.github.io/posts/tech/mit6.s0811-os-overview/">
  <meta property="og:site_name" content="Kennem&#39;s Blog">
  <meta property="og:title" content="MIT6.S081(1)-O/S overview">
  <meta property="og:description" content="MIT6.S081(1)">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-31T22:30:13+08:00">
    <meta property="article:modified_time" content="2024-08-31T22:20:13+08:00">
    <meta property="article:tag" content="MIT6.S081">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT6.S081(1)-O/S overview">
<meta name="twitter:description" content="MIT6.S081(1)">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://kennems.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ’»æŠ€æœ¯",
      "item": "https://kennems.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MIT6.S081(1)-O/S overview",
      "item": "https://kennems.github.io/posts/tech/mit6.s0811-os-overview/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MIT6.S081(1)-O/S overview",
  "name": "MIT6.S081(1)-O\/S overview",
  "description": "MIT6.S081(1)",
  "keywords": [
    "MIT6.S081"
  ],
  "articleBody": "MIT6.S081(1)-O/S overview Class Page Overview 6.S081 goals Understand operating system (O/S) design and implementation Hands-on experience extending a small O/S Hands-on experience writing systems software What is the purpose of an O/S? Abstract the hardware for convenience and portability Multiplex the hardware among many applications Isolate applications in order to contain bugs Allow sharing among cooperating applications Control sharing for security Donâ€™t get in the way of high performance Support a wide range of applications Organization: layered picture user applications: vi, gcc, DB, \u0026c kernel services h/w: CPU, RAM, disk, net, \u0026c we care a lot about the interfaces and internal kernel structure What services does an O/S kernel typically provide? process (a running program) memory allocation file contents file names, directories access control (security) many others: users, IPCï¼ˆInter-Process Communicationï¼‰, network, time, terminals Whatâ€™s the application / kernel interface? â€œSystem callsâ€\nExamples, in C, from UNIX (e.g. Linux, macOS, FreeBSD):\nfd = open(\"out\", 1); write(fd, \"hello\\n\", 6); pid = fork(); These look like function calls but they arenâ€™t\nSystem Calls å‡½æ•°å åŠŸèƒ½æè¿° int fork() åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œè¿”å›å­è¿›ç¨‹çš„ PIDã€‚ int exit(int status) ç»ˆæ­¢å½“å‰è¿›ç¨‹ï¼Œstatus è¿”å›ç»™ wait()ï¼Œä¸è¿”å›ã€‚ int wait(int *status) ç­‰å¾…å­è¿›ç¨‹é€€å‡ºï¼Œé€€å‡ºçŠ¶æ€å­˜å…¥ *statusï¼Œè¿”å›å­è¿›ç¨‹çš„ PIDã€‚ int kill(int pid) ç»ˆæ­¢è¿›ç¨‹ PIDã€‚è¿”å› 0 æˆ– -1ï¼ˆè¡¨ç¤ºé”™è¯¯ï¼‰ã€‚ int getpid() è¿”å›å½“å‰è¿›ç¨‹çš„ PIDã€‚ int sleep(int n) æš‚åœ n ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ int exec(char *file, char *argv[]) åŠ è½½å¹¶æ‰§è¡Œæ–‡ä»¶ fileï¼Œä¼ å…¥å‚æ•° argv[]ï¼Œä»…åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å›ã€‚ char *sbrk(int n) å¢åŠ  n å­—èŠ‚çš„è¿›ç¨‹å†…å­˜ï¼Œè¿”å›æ–°å†…å­˜çš„èµ·å§‹åœ°å€ã€‚ int open(char *file, int flags) æ‰“å¼€æ–‡ä»¶ï¼Œflags æŒ‡ç¤ºè¯»/å†™æ¨¡å¼ï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚ int write(int fd, char *buf, int n) ä» buf ä¸­å‘æ–‡ä»¶æè¿°ç¬¦ fd å†™å…¥ n å­—èŠ‚ï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚æ•°ã€‚ int read(int fd, char *buf, int n) ä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å– n å­—èŠ‚åˆ° bufï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°æˆ– 0ï¼ˆæ–‡ä»¶ç»“æŸï¼‰ã€‚ int close(int fd) å…³é—­æ–‡ä»¶æè¿°ç¬¦ fdã€‚ int dup(int fd) è¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒæŒ‡å‘ä¸ fd ç›¸åŒçš„æ–‡ä»¶ã€‚ int pipe(int p[]) åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå°†è¯»/å†™æ–‡ä»¶æè¿°ç¬¦æ”¾å…¥ p[0] å’Œ p[1]ã€‚ int chdir(char *dir) æ›´æ”¹å½“å‰ç›®å½•ä¸º dirã€‚ int mkdir(char *dir) åˆ›å»ºä¸€ä¸ªæ–°ç›®å½• dirã€‚ int mknod(char *file, int, int) åˆ›å»ºä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ã€‚ int fstat(int fd, struct stat *st) å°†å…³äºæ‰“å¼€æ–‡ä»¶çš„ä¿¡æ¯æ”¾å…¥ *stã€‚ int stat(char *file, struct stat *st) å°†å…³äºæ–‡ä»¶ file çš„ä¿¡æ¯æ”¾å…¥ *stã€‚ int link(char *file1, char *file2) ä¸ºæ–‡ä»¶ file1 åˆ›å»ºå¦ä¸€ä¸ªåç§° file2ã€‚ int unlink(char *file) åˆ é™¤æ–‡ä»¶ fileã€‚ Why is O/S design + implementation hard and interesting? unforgiving environment: quirky h/w, hard to debug\nmany design tensions:\nefficient vs abstract / portable / general-purpose powerful vs simple interfaces flexible vs secure features interact: fd = open(); fork()\nuses are varied: laptops, smart-phones, cloud, virtual machines, embedded\nevolving hardware: NVRAM, multi-core, fast networks\nYouâ€™ll be glad you took this course if youâ€¦\ncare about what goes on under the hood like infrastructure need to track down bugs or security problems care about high performance Class structure Online course information: https://pdos.csail.mit.edu/6.S081/2020 â€“ schedule, assignments, labs Piazza â€“ announcements, discussion, lab help\nLectures\nO/S ideas case study of xv6, a small O/S, via code and xv6 book lab background O/S papers submit a question about each reading, before lecture. Labs: The point: hands-on experience Mostly one week each. Three kinds: Systems programming (due next weekâ€¦) O/S primitives, e.g. thread switching. O/S kernel extensions to xv6, e.g. network. Use piazza to ask/answer lab questions. Discussion is great, but please do not look at othersâ€™ solutions!\nGrading: 70% labs, based on tests (the same tests you run). 20% lab check-off meetings: weâ€™ll ask you about randomly-selected labs. 10% home-work and class/piazza discussion. No exams, no quizzes. Note that most of the grade is from labs. Start them early!\nIntroduction to UNIX system calls Iâ€™ll show some examples, and run them on xv6. xv6 has similar structure to UNIX systems such as Linux. but much simpler â€“ youâ€™ll be able to digest all of xv6 accompanying book explains how xv6 works, and why Why UNIX? open source, well documented, clean design, widely used studying xv6 will help if you ever need to look inside Linux xv6 has two roles in 6.S081: example of core functions: virtual memory, multi-core, interrupts, \u0026c starting point for most of the labs xv6 runs on RISC-V, as in current 6.004 youâ€™ll run xv6 under the qemu machine emulator\nExample: copy.c, copy input to output read bytes from input, write them to the output\n$ copy copy.c is written in C Kernighan and Ritchie (K\u0026R) book is good for learning C you can find these example programs via the schedule on the web site\ncopy.c // copy.c: å¤åˆ¶è¾“å…¥åˆ°è¾“å‡º #include \"kernel/types.h\" // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰ #include \"user/user.h\" // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ read, write, exitï¼‰ int main() { char buf[64]; // å®šä¹‰ä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨è¯»å–çš„æ•°æ® // æ— é™å¾ªç¯ï¼Œç›´åˆ°è¯»å–åˆ°æ–‡ä»¶ç»“æŸæ ‡å¿—æˆ–å‡ºç°é”™è¯¯ while(1){ // ä»æ ‡å‡†è¾“å…¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦ 0ï¼‰ä¸­è¯»å–æ•°æ®åˆ° buf ä¸­ int n = read(0, buf, sizeof(buf)); // å¦‚æœè¯»å–åˆ°çš„æ•°æ®é‡å°äºç­‰äº 0ï¼Œåˆ™è¡¨ç¤ºè¾“å…¥ç»“æŸæˆ–å‘ç”Ÿäº†é”™è¯¯ if(n \u003c= 0) break; // é€€å‡ºå¾ªç¯ // å°†è¯»å–çš„æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰ write(1, buf, n); } // æ­£å¸¸é€€å‡ºç¨‹åº exit(0); } read() and write() are system calls first read()/write() argument is a \"file descriptor\" (fd) passed to kernel to tell it which â€œopen fileâ€ to read/write must previously have been opened\nan FD connects to a file/device/socket/\u0026c a process can open many files, have many FDs\nUNIX convention: fd 0 is â€œstandard inputâ€, 1 is â€œstandard outputâ€\nsecond read() argument is a pointer to some memory into which to read\nthird argument is the maximum number of bytes to read read() may read less, but not more return value: number of bytes actually read, or -1 for error\nnote: copy.c does not care about the format of the data UNIX I/O is 8-bit bytes interpretation is application-specific, e.g. database records, C source, \u0026c\nWhere do file descriptors come from? example: open.c, create a file\n$ open $ cat output.txt open() creates a file, returns a file descriptor (or -1 for error) FD is a small integer FD indexes into a per-process table maintained by kernel [user/kernel diagram] different processes have different FD name-spaces i.e. FD 1 often means different things to different processes these examples ignore errors â€“ donâ€™t be this sloppy! Figure 1.2 in the xv6 book lists system call arguments/return or look at UNIX man pages, e.g. â€œman 2 openâ€\nWhat happens when a program calls a system call like open()? looks like a function call, but itâ€™s actually a special instruction hardware saves some user registers hardware increases privilege level hardware jumps to a known â€œentry pointâ€ in the kernel now running C code in the kernel kernel calls system call implementation open() looks up name in file system it might wait for the disk it updates kernel data structures (cache, FD table) restore user registers reduce privilege level jump back to calling point in the program, which resumes weâ€™ll see more detail later in the course\nIâ€™ve been typing to UNIXâ€™s command-line interface, the shell. the shell prints the â€œ$â€ prompts. the shell lets you run UNIX command-line utilities useful for system management, messing with files, development, scripting\n$ ls $ ls \u003e out $ grep x \u003c out UNIX supports other styles of interaction too window systems, GUIs, servers, routers, \u0026c. but time-sharing via the shell was the original focus of UNIX. we can exercise many system calls via the shell.\nexample: fork.c, create a new process\nâ€‹\tthe shell creates a new process for each command you type, e.g. for\n$ echo hello the fork() system call creates a new process\n$ fork the kernel makes a copy of the calling process instructions, data, registers, file descriptors, current directory â€œparentâ€ and â€œchildâ€ processes only difference: fork() returns a pid in parent, 0 in child a pid (process ID) is an integer, kernel gives each process a different pid thus: fork.câ€™s â€œfork() returnedâ€ executes in both processes the â€œif(pid == 0)â€ allows code to distinguish ok, fork lets us create a new process how can we run a program in that process?\nexample: exec.c, replace calling process with an executable file how does the shell run a program, e.g.\n$ echo a b c a program is stored in a file: instructions and initial memory created by the compiler and linker so thereâ€™s a file called echo, containing instructions\n$ exec exec() replaces current process with an executable file discards instruction and data memory loads instructions and memory from the file preserves file descriptors exec(filename, argument-array) argument-array holds command-line arguments; exec passes to main() cat user/echo.c echo.c shows how a program looks at its command-line arguments\nexample: forkexec.c, fork() a new process, exec() a program\n$ forkexec forkexec.c contains a common UNIX idiom: fork() : a child process exec() : a command in the child parent wait()s for child to finish the shell does fork/exec/wait for every command you type after wait(), the shell prints the next prompt to run in the background â€“ \u0026 â€“ the shell skips the wait() exit(status) -\u003e wait(\u0026status) status convention: 0 = success, 1 = command encountered an error note: the fork() copies, but exec() discards the copied memory this may seem wasteful youâ€™ll transparently eliminate the copy in the â€œcopy-on-writeâ€ lab\nfork å’Œ exec çš„åŒºåˆ« fork ç”¨äºåˆ›å»ºæ–°è¿›ç¨‹ï¼Œçˆ¶å­è¿›ç¨‹å¹¶å‘æ‰§è¡Œã€‚\nexec ç”¨äºåœ¨ç°æœ‰è¿›ç¨‹ä¸­åŠ è½½å¹¶è¿è¡Œæ–°ç¨‹åºã€‚\nfork ç³»ç»Ÿè°ƒç”¨ åŠŸèƒ½ï¼šfork ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç§°ä¸ºå­è¿›ç¨‹ã€‚å­è¿›ç¨‹æ˜¯é€šè¿‡å¤åˆ¶å½“å‰è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰çš„åœ°å€ç©ºé—´åˆ›å»ºçš„ï¼Œå› æ­¤å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å‡ ä¹å®Œå…¨ç›¸åŒï¼Œæ‹¥æœ‰ç›¸åŒçš„ä»£ç ã€æ•°æ®å’Œæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ æ‰§è¡Œç»“æœï¼š çˆ¶è¿›ç¨‹è°ƒç”¨ fork åï¼Œè¿”å›å€¼æ˜¯å­è¿›ç¨‹çš„ PIDã€‚ å­è¿›ç¨‹ä» fork è¿”å›æ—¶ï¼Œè¿”å›å€¼æ˜¯ 0ã€‚ ç‰¹ç‚¹ï¼š å­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‡ ä¹ç²¾ç¡®å‰¯æœ¬ï¼ŒåŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ã€å˜é‡ã€ä»£ç æ®µç­‰ï¼Œä½†å…¶ PIDï¼ˆè¿›ç¨‹ IDï¼‰ä¸åŒã€‚ å¹¶å‘æ‰§è¡Œï¼šfork ä¹‹åï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œå„è‡ªçš„ä»£ç ã€‚ å¤šæ¬¡è¿”å›ï¼šfork ä¼šè¿”å›ä¸¤æ¬¡ï¼Œä¸€æ¬¡åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œä¸€æ¬¡åœ¨å­è¿›ç¨‹ä¸­ã€‚ exec ç³»ç»Ÿè°ƒç”¨ åŠŸèƒ½ï¼šexec ç”¨äºæ›¿æ¢å½“å‰è¿›ç¨‹çš„ä»£ç å’Œæ•°æ®æ®µï¼ŒåŠ è½½ä¸€ä¸ªæ–°ç¨‹åºå¹¶æ‰§è¡Œè¯¥ç¨‹åºã€‚å½“ exec è¢«è°ƒç”¨æ—¶ï¼Œå½“å‰è¿›ç¨‹çš„æ‰€æœ‰å†…å®¹ï¼ˆå¦‚ä»£ç ã€æ•°æ®ã€å †æ ˆï¼‰éƒ½è¢«æ–°ç¨‹åºæ›¿æ¢ï¼Œä½†è¿›ç¨‹çš„ PID ä¸å˜ã€‚ æ‰§è¡Œç»“æœï¼š exec ä¸è¿”å›ï¼Œé™¤éè°ƒç”¨å¤±è´¥ã€‚æˆåŠŸè°ƒç”¨ exec åï¼Œæ—§çš„ç¨‹åºä»£ç å®Œå…¨è¢«æ–°ç¨‹åºæ›¿æ¢ã€‚ æ–‡ä»¶æè¿°ç¬¦ä¸ä¼šè¢«å…³é—­ï¼ˆé™¤éè®¾ç½®äº† close-on-exec æ ‡å¿—ï¼‰ã€‚ ç‰¹ç‚¹ï¼š exec åªä¼šæ”¹å˜è¿›ç¨‹çš„æ‰§è¡Œä»£ç ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚ æ–°ç¨‹åºç»§æ‰¿äº†è°ƒç”¨è¿›ç¨‹çš„ PID å’Œæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†åŸæœ‰çš„å†…å­˜æ•°æ®ã€å †æ ˆã€ä»£ç ç­‰éƒ½ä¼šè¢«æ–°ç¨‹åºæ›¿æ¢æ‰ã€‚ example: redirect.c, redirect the output of a command what does the shell do for this?\n$ echo hello \u003e out answer: fork, change FD 1 in child, exec echo\n$ redirect $ cat output.txt note: open() always chooses lowest unused FD; 1 due to close(1). fork, FDs, and exec interact nicely to implement I/O redirection separate fork-then-exec give child a chance to change FDs before exec FDs provide indirection commands just use FDs 0 and 1, donâ€™t have to know where they go exec preserves the FDs that sh set up thus: only sh has to know about I/O redirection, not each program\nItâ€™s worth asking â€œwhyâ€ about design decisions: Why these I/O and process abstractions? Why not something else? Why provide a file system? Why not let programs use the disk their own way? Why FDs? Why not pass a filename to write()? Why are files streams of bytes, not disk blocks or formatted records? Why not combine fork() and exec()? The UNIX design works well, but we will see other designs!\nexample: pipe1.c, communicate through a pipe how does the shell implement\n$ ls | grep x $ pipe1 an FD can refer to a â€œpipeâ€, as well as a file the pipe() system call creates two FDs read from the first FD write to the second FD the kernel maintains a buffer for each pipe [u/k diagram] write() appends to the buffer read() waits until there is data\nexample: pipe2.c, communicate between processes pipes combine well with fork() to implement ls | grep x shell creates a pipe, then forks (twice), then connects lsâ€™s FD 1 to pipeâ€™s write FD, and grepâ€™s FD 0 to the pipe [diagram]\n$ pipe2 -- a simplified version pipes are a separate abstraction, but combine well w/ fork()\nexample: list.c, list files in a directory how does ls get a list of the files in a directory? you can open a directory and read it -\u003e file names â€œ.â€ is a pseudo-name for a processâ€™s current directory see ls.c for more details\nSummary Weâ€™ve looked at UNIXâ€™s I/O, file system, and process abstractions. The interfaces are simple â€“ just integers and I/O buffers. The abstractions combine well, e.g. for I/O redirection. Youâ€™ll use these system calls in the first lab, due next week.\nCode Pipes int pipeFd[2]; // ç®¡é“æ–‡ä»¶æè¿°ç¬¦æ•°ç»„ï¼ŒpipeFd[0]ä¸ºè¯»å–ç«¯ï¼ŒpipeFd[1]ä¸ºå†™å…¥ç«¯ char *arguments[2]; // å­˜å‚¨ä¼ é€’ç»™execçš„å‚æ•° int main() { // è®¾ç½®è¦æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•° arguments[0] = \"wc\"; // å°† \"wc\" å‘½ä»¤ä½œä¸ºå‚æ•°ä¼ é€’ç»™execï¼Œç”¨äºç»Ÿè®¡è¾“å…¥çš„è¡Œã€å•è¯å’Œå­—ç¬¦æ•° arguments[1] = 0; // ä»¥NULLè¡¨ç¤ºå‚æ•°ç»“æŸ // åˆ›å»ºç®¡é“ pipe(pipeFd); // pipeFd[0]ç”¨äºè¯»å–ï¼ŒpipeFd[1]ç”¨äºå†™å…¥ // åˆ›å»ºå­è¿›ç¨‹ if(fork() == 0) { // å­è¿›ç¨‹ä»£ç ï¼Œfork()è¿”å›0è¡¨ç¤ºå½“å‰æ˜¯å­è¿›ç¨‹ close(0); // å…³é—­æ ‡å‡†è¾“å…¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦0ï¼‰ dup(pipeFd[0]); // å°†ç®¡é“çš„è¯»å–ç«¯å¤åˆ¶åˆ°æ–‡ä»¶æè¿°ç¬¦0ï¼Œä½¿æ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°ç®¡é“çš„è¯»å–ç«¯ close(pipeFd[0]); // å…³é—­ç®¡é“çš„è¯»å–ç«¯ï¼Œå·²é‡å®šå‘åˆ°æ ‡å‡†è¾“å…¥ï¼Œä¸å†éœ€è¦ close(pipeFd[1]); // å…³é—­ç®¡é“çš„å†™å…¥ç«¯ï¼Œå­è¿›ç¨‹ä¸è´Ÿè´£å†™å…¥æ•°æ® exec(\"/bin/wc\", arguments); // æ‰§è¡Œwcå‘½ä»¤ï¼Œè¯»å–æ ‡å‡†è¾“å…¥ï¼ˆä»ç®¡é“ä¸­è¯»å–ï¼‰ï¼Œè®¡ç®—è¡Œã€å•è¯å’Œå­—ç¬¦æ•° } else { // çˆ¶è¿›ç¨‹ä»£ç  close(pipeFd[0]); // å…³é—­ç®¡é“çš„è¯»å–ç«¯ï¼Œçˆ¶è¿›ç¨‹ä¸è´Ÿè´£è¯»å–æ•°æ® // å‘ç®¡é“å†™å…¥æ•°æ® write(pipeFd[1], \"hello world\\n\", 12); // å°† \"hello world\\n\" å†™å…¥ç®¡é“ï¼Œä¾›å­è¿›ç¨‹è¯»å– close(pipeFd[1]); // å…³é—­ç®¡é“çš„å†™å…¥ç«¯ï¼Œè¡¨ç¤ºæ•°æ®å†™å…¥å®Œæˆ } return 0; } cat.c #include \"kernel/types.h\" // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰ #include \"kernel/stat.h\" // åŒ…å«æ–‡ä»¶çŠ¶æ€ç›¸å…³çš„å®šä¹‰ #include \"user/user.h\" // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ read, write, open, close, fprintf, exitï¼‰ char buf[512]; // å®šä¹‰ä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨è¯»å–çš„æ•°æ® // å‡½æ•°ï¼šcat // å‚æ•°ï¼šint fd - æ–‡ä»¶æè¿°ç¬¦ // åŠŸèƒ½ï¼šä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å°†å…¶å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰ void cat(int fd) { int n; // ä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å–æ•°æ®åˆ° buf ä¸­ï¼Œè¯»å–çš„å­—èŠ‚æ•°å­˜å‚¨åœ¨ n ä¸­ while((n = read(fd, buf, sizeof(buf))) \u003e 0) { // å°†è¯»å–çš„æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡º if (write(1, buf, n) != n) { // å¦‚æœå†™å…¥çš„å­—èŠ‚æ•°ä¸ç­‰äºè¯»å–çš„å­—èŠ‚æ•°ï¼ŒæŠ¥å‘Šå†™å…¥é”™è¯¯ fprintf(2, \"cat: write error\\n\"); exit(1); } } // å¦‚æœè¯»å–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼ŒæŠ¥å‘Šè¯»å–é”™è¯¯å¹¶é€€å‡º if(n \u003c 0){ fprintf(2, \"cat: read error\\n\"); exit(1); } } // ä¸»å‡½æ•° int main(int argc, char *argv[]) { int fd, i; // å¦‚æœæ²¡æœ‰æä¾›æ–‡ä»¶å‚æ•°ï¼Œé»˜è®¤è¯»å–æ ‡å‡†è¾“å…¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦ 0ï¼‰ if(argc \u003c= 1){ cat(0); exit(0); } // éå†å‘½ä»¤è¡Œå‚æ•°ä¸­çš„æ–‡ä»¶å for(i = 1; i \u003c argc; i++){ // æ‰“å¼€æ–‡ä»¶ï¼Œè·å–æ–‡ä»¶æè¿°ç¬¦ if((fd = open(argv[i], 0)) \u003c 0){ // å¦‚æœæ–‡ä»¶æ— æ³•æ‰“å¼€ï¼ŒæŠ¥å‘Šé”™è¯¯å¹¶é€€å‡º fprintf(2, \"cat: cannot open %s\\n\", argv[i]); exit(1); } // è°ƒç”¨ cat å‡½æ•°ï¼Œå°†æ–‡ä»¶å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º cat(fd); // å…³é—­æ–‡ä»¶æè¿°ç¬¦ close(fd); } // æ­£å¸¸é€€å‡º exit(0); } echo.c #include \"kernel/types.h\" // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰ #include \"kernel/stat.h\" // åŒ…å«æ–‡ä»¶çŠ¶æ€ç›¸å…³çš„å®šä¹‰ #include \"user/user.h\" // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ write, exit, strlenï¼‰ int main(int argc, char *argv[]) { int i; // éå†å‘½ä»¤è¡Œå‚æ•°ï¼Œä»ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆargv[1]ï¼‰å¼€å§‹ for(i = 1; i \u003c argc; i++){ // å°†å½“å‰å‚æ•° argv[i] å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰ write(1, argv[i], strlen(argv[i])); // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œåœ¨å…¶åå†™å…¥ä¸€ä¸ªç©ºæ ¼ if(i + 1 \u003c argc){ write(1, \" \", 1); } else { // å¦‚æœæ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œåœ¨å…¶åå†™å…¥ä¸€ä¸ªæ¢è¡Œç¬¦ write(1, \"\\n\", 1); } } // æ­£å¸¸é€€å‡ºç¨‹åº exit(0); } forktest.c // æµ‹è¯• fork æ˜¯å¦èƒ½åœ¨è¿›ç¨‹è¡¨æ»¡æ—¶ä¼˜é›…åœ°å¤±è´¥ã€‚ // è¿™ä¸ªç¨‹åºæ˜¯ä¸€ä¸ªå°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨äºå¡«å……è¿›ç¨‹è¡¨ä»¥æµ‹è¯• fork çš„è¡Œä¸ºã€‚ #include \"kernel/types.h\" // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰ #include \"kernel/stat.h\" // åŒ…å«æ–‡ä»¶çŠ¶æ€ç›¸å…³çš„å®šä¹‰ #include \"user/user.h\" // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ write, exit, fork, wait, strlenï¼‰ #define N 1000 // å®šä¹‰æµ‹è¯•çš„ fork æœ€å¤§æ¬¡æ•° // å‡½æ•°ï¼šprint // å‚æ•°ï¼šconst char *s - è¦è¾“å‡ºçš„å­—ç¬¦ä¸² // åŠŸèƒ½ï¼šå°†å­—ç¬¦ä¸² s å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰ void print(const char *s) { write(1, s, strlen(s)); // ä½¿ç”¨ write ç³»ç»Ÿè°ƒç”¨å°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡º } // å‡½æ•°ï¼šforktest // åŠŸèƒ½ï¼šæµ‹è¯• fork ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯åœ¨è¿›ç¨‹è¡¨æ»¡æ—¶ void forktest(void) { int n, pid; // è¾“å‡ºå¼€å§‹æµ‹è¯•çš„ä¿¡æ¯ print(\"fork test\\n\"); // å¾ªç¯å°è¯•åˆ›å»º N ä¸ªå­è¿›ç¨‹ for(n = 0; n \u003c N; n++){ pid = fork(); // åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ if(pid \u003c 0) break; // å¦‚æœ fork å¤±è´¥ï¼Œé€€å‡ºå¾ªç¯ if(pid == 0) exit(0); // å­è¿›ç¨‹é€€å‡º } // å¦‚æœæˆåŠŸåˆ›å»ºäº† N ä¸ªå­è¿›ç¨‹ï¼Œè¡¨ç¤º fork è¡Œä¸ºå¼‚å¸¸ if(n == N){ print(\"fork claimed to work N times!\\n\"); exit(1); } // ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹ç»“æŸ for(; n \u003e 0; n--){ if(wait(0) \u003c 0){ // ç­‰å¾…å­è¿›ç¨‹ç»“æŸ print(\"wait stopped early\\n\"); exit(1); // å¦‚æœ wait å¤±è´¥ï¼ŒæŠ¥å‘Šé”™è¯¯å¹¶é€€å‡º } } // å¦‚æœ wait æ²¡æœ‰è¿”å› -1ï¼Œè¡¨ç¤ºè¿˜æœ‰å¤šä½™çš„å­è¿›ç¨‹ if(wait(0) != -1){ print(\"wait got too many\\n\"); exit(1); } // è¾“å‡ºæµ‹è¯•æˆåŠŸçš„ä¿¡æ¯ print(\"fork test OK\\n\"); } // ä¸»å‡½æ•° int main(void) { forktest(); // æ‰§è¡Œ fork æµ‹è¯• exit(0); // æ­£å¸¸é€€å‡ºç¨‹åº } stressfs.c // Demonstrate that moving the \"acquire\" in iderw after the loop that // appends to the idequeue results in a race. // For this to work, you should also add a spin within iderw's // idequeue traversal loop. Adding the following demonstrated a panic // after about 5 runs of stressfs in QEMU on a 2.1GHz CPU: // for (i = 0; i \u003c 40000; i++) // asm volatile(\"\"); #include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" #include \"kernel/fs.h\" #include \"kernel/fcntl.h\" int main(int argc, char *argv[]) { int fd, i; char path[] = \"stressfs0\"; char data[512]; printf(\"stressfs starting\\n\"); memset(data, 'a', sizeof(data)); for(i = 0; i \u003c 4; i++) if(fork() \u003e 0) break; printf(\"write %d\\n\", i); path[8] += i; fd = open(path, O_CREATE | O_RDWR); for(i = 0; i \u003c 20; i++) // printf(fd, \"%d\\n\", i); write(fd, data, sizeof(data)); close(fd); printf(\"read\\n\"); fd = open(path, O_RDONLY); for (i = 0; i \u003c 20; i++) read(fd, data, sizeof(data)); close(fd); wait(0); exit(0); } Lab - Util sleep (easy) #include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" int main(int argc, char *argv[]) { if(argc != 2){ fprintf(2, \"Usage: sleep [the times of ticks]...\\n\"); exit(1); } int times = atoi(argv[1]); sleep(times); exit(0); } pingpong (easy) #include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" int main(int argc, char *argv[]) { if (argc \u003e 1) { fprintf(2, \"Usage: pingpong (without any parameters)\\n\"); exit(1); } int pipe_fd[2]; if (pipe(pipe_fd) \u003c 0) { fprintf(2, \"pipe error\\n\"); exit(1); } int pid = fork(); if (pid \u003e 0) { // çˆ¶è¿›ç¨‹å…³é—­ç®¡é“çš„å†™ç«¯ close(pipe_fd[1]); // çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„ä¿¡å· char buf[1]; read(pipe_fd[0], buf, 1); pid = wait((int *)0); printf(\"%d: received pong\\n\", getpid()); // çˆ¶è¿›ç¨‹å…³é—­ç®¡é“çš„è¯»ç«¯ close(pipe_fd[0]); } else if (pid == 0) { // å­è¿›ç¨‹å…³é—­ç®¡é“çš„è¯»ç«¯ close(pipe_fd[0]); printf(\"%d: received ping\\n\", getpid()); // å­è¿›ç¨‹é€šè¿‡ç®¡é“å‘çˆ¶è¿›ç¨‹å‘é€ä¿¡å· write(pipe_fd[1], \"x\", 1); // å­è¿›ç¨‹å…³é—­ç®¡é“çš„å†™ç«¯ close(pipe_fd[1]); exit(0); } else { printf(\"fork error\\n\"); exit(1); } exit(0); } primes (moderate)/(hard) #include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" void sieve(int p_left) { int p_right[2]; int prime; // ä»å·¦ä¾§ç®¡é“è¯»å–ç¬¬ä¸€ä¸ªæ•°å­— if (read(p_left, \u0026prime, sizeof(int)) == 0) { close(p_left); exit(0); } // è¾“å‡ºè¯¥ç´ æ•° printf(\"prime %d\\n\", prime); // åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡é“ if (pipe(p_right) \u003c 0) { fprintf(2, \"pipe error\\n\"); exit(1); } if (fork() == 0) { // å­è¿›ç¨‹é€’å½’å¤„ç† close(p_right[1]); sieve(p_right[0]); } else { // çˆ¶è¿›ç¨‹ç»§ç»­è¯»å–å¹¶ç­›é€‰ close(p_right[0]); int num; while (read(p_left, \u0026num, sizeof(int)) != 0) { if (num % prime != 0) { write(p_right[1], \u0026num, sizeof(int)); } } // å…³é—­ç®¡é“ï¼Œç­‰å¾…å­è¿›ç¨‹ç»“æŸ close(p_left); close(p_right[1]); wait(0); exit(0); } } int main(int argc, char *argv[]) { int p[2]; if (pipe(p) \u003c 0) { fprintf(2, \"pipe error\\n\"); exit(1); } if (fork() == 0) { close(p[1]); sieve(p[0]); } else { close(p[0]); // å°† 2 åˆ° 35 çš„æ•°å­—å†™å…¥ç®¡é“ for (int i = 2; i \u003c= 35; i++) { write(p[1], \u0026i, sizeof(int)); } close(p[1]); wait(0); exit(0); } return 0; } find (moderate) #include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" #include \"kernel/fs.h\" #include \"kernel/fcntl.h\" #define MAXBUF 512 // å®šä¹‰ç¼“å†²åŒºå¤§å° /** * find - é€’å½’æŸ¥æ‰¾ç›®å½•æ ‘ä¸­ä¸æŒ‡å®šæ–‡ä»¶ååŒ¹é…çš„æ–‡ä»¶ã€‚ * @path: è¦æœç´¢çš„ç›®å½•è·¯å¾„ã€‚ * @filename: è¦æŸ¥æ‰¾çš„æ–‡ä»¶åã€‚ * * è¯¥å‡½æ•°é€šè¿‡é€’å½’éå†ç›®å½•æ ‘ï¼Œæ‰“å°å‡ºä¸æŒ‡å®šæ–‡ä»¶ååŒ¹é…çš„æ–‡ä»¶çš„è·¯å¾„ã€‚ * å®ƒä¼šå¿½ç•¥ç‰¹æ®Šç›®å½•é¡¹ `.` å’Œ `..` ä»¥é¿å…é€’å½’å›åˆ°å½“å‰æˆ–çˆ¶ç›®å½•ã€‚ */ void find(char *path, char *filename) { char buf[512], *p; int fd; struct dirent de; struct stat st; // æ‰“å¼€æŒ‡å®šçš„ç›®å½•è·¯å¾„ if ((fd = open(path, 0)) \u003c 0) { fprintf(2, \"find: cannot open %s\\n\", path); return; } // è·å–æ–‡ä»¶çŠ¶æ€ï¼ˆä¾‹å¦‚ç¡®å®šæ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼‰ if (fstat(fd, \u0026st) \u003c 0) { fprintf(2, \"find: cannot stat %s\\n\", path); close(fd); return; } // åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œå¤„ç†ä¸åŒçš„æƒ…å†µ switch (st.type) { case T_FILE: // å¦‚æœæ˜¯æ™®é€šæ–‡ä»¶ // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦ä¸ç›®æ ‡æ–‡ä»¶ååŒ¹é… if (strcmp(path + strlen(path) - strlen(filename), filename) == 0) { // å¦‚æœåŒ¹é…ï¼Œæ‰“å°æ–‡ä»¶è·¯å¾„ printf(\"%s\\n\", path); // æ³¨æ„è¿™é‡Œæ¯ä¸ªåŒ¹é…çš„æ–‡ä»¶éƒ½åº”è¯¥åœ¨æ–°è¡Œæ‰“å° } break; case T_DIR: // å¦‚æœæ˜¯ç›®å½• // æ£€æŸ¥è·¯å¾„é•¿åº¦æ˜¯å¦è¶…å‡ºç¼“å†²åŒºå¤§å° if (strlen(path) + 1 + DIRSIZ + 1 \u003e sizeof(buf)) { printf(\"find: path too long\\n\"); break; } // å°†å½“å‰è·¯å¾„å¤åˆ¶åˆ°ç¼“å†²åŒºä¸­ strcpy(buf, path); p = buf + strlen(buf); *p++ = '/'; // è¯»å–ç›®å½•ä¸­çš„æ¯ä¸ªç›®å½•é¡¹ while (read(fd, \u0026de, sizeof(de)) == sizeof(de)) { if (de.inum == 0) continue; // è·³è¿‡æ— æ•ˆçš„ç›®å½•é¡¹ // å°†ç›®å½•é¡¹åç§°å¤åˆ¶åˆ°è·¯å¾„ç¼“å†²åŒº memmove(p, de.name, DIRSIZ); p[DIRSIZ] = 0; // å¿½ç•¥ç‰¹æ®Šç›®å½•é¡¹ `.` å’Œ `..` if (strcmp(de.name, \".\") == 0 || strcmp(de.name, \"..\") == 0) continue; // é€’å½’è°ƒç”¨ find å‡½æ•°å¤„ç†å­ç›®å½•æˆ–æ–‡ä»¶ find(buf, filename); } break; } // å…³é—­æ–‡ä»¶æè¿°ç¬¦ä»¥é‡Šæ”¾èµ„æº close(fd); } /** * main - ç¨‹åºçš„å…¥å£ç‚¹ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°å¹¶è°ƒç”¨ find å‡½æ•°ã€‚ * @argc: å‚æ•°ä¸ªæ•°ã€‚ * @argv: å‚æ•°å€¼æ•°ç»„ã€‚ * * è¯¥å‡½æ•°éªŒè¯å‚æ•°çš„æ­£ç¡®æ€§ï¼Œå¹¶è°ƒç”¨ find å‡½æ•°å¼€å§‹é€’å½’æŸ¥æ‰¾ã€‚ */ int main(int argc, char *argv[]) { // æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦æ­£ç¡® if (argc \u003c 3) { // å¦‚æœå‚æ•°ä¸è¶³ï¼Œæ‰“å°ä½¿ç”¨è¯´æ˜å¹¶é€€å‡º fprintf(2, \"Usage: find \\n\"); exit(1); } // è°ƒç”¨ find å‡½æ•°ï¼Œå¼€å§‹æŸ¥æ‰¾æ–‡ä»¶ find(argv[1], argv[2]); exit(0); } xargs (moderate) #include \"kernel/types.h\" #include \"kernel/stat.h\" #include \"user/user.h\" #define MAXARG 32 // æœ€å¤§å‚æ•°æ•°é‡ #define MAXBUF 1024 // æœ€å¤§è¾“å…¥ç¼“å†²åŒºå¤§å° // ä»æ ‡å‡†è¾“å…¥è¯»å–ä¸€è¡Œ int read_line(char *buf, int size) { int i = 0; // å½“å‰å­—ç¬¦ç´¢å¼• char c; // å­˜å‚¨è¯»å–çš„å­—ç¬¦ // ä»æ ‡å‡†è¾“å…¥é€å­—ç¬¦è¯»å–ï¼Œç›´åˆ°é‡åˆ°æ¢è¡Œç¬¦æˆ–ç¼“å†²åŒºå·²æ»¡ while (i \u003c size - 1) { if (read(0, \u0026c, 1) != 1) { return i; // åˆ°è¾¾è¾“å…¥ç»“æŸæˆ–å‘ç”Ÿé”™è¯¯ } if (c == '\\n') { break; // é‡åˆ°æ¢è¡Œç¬¦ï¼Œåœæ­¢è¯»å– } buf[i++] = c; // å°†è¯»å–çš„å­—ç¬¦å­˜å…¥ç¼“å†²åŒº } buf[i] = '\\0'; // åœ¨å­—ç¬¦ä¸²æœ«å°¾æ·»åŠ  null ç»ˆæ­¢ç¬¦ return i; } int main(int argc, char *argv[]) { if (argc \u003c 2) { fprintf(2, \"Usage: xargs command [initial-args]\\n\"); // å¦‚æœæ²¡æœ‰æä¾›å‘½ä»¤å‚æ•°ï¼Œè¾“å‡ºç”¨æ³•æç¤º exit(1); // é€€å‡ºç¨‹åº } char buf[MAXBUF]; // ç”¨äºå­˜å‚¨è¾“å…¥è¡Œçš„ç¼“å†²åŒº // ä»æ ‡å‡†è¾“å…¥è¯»å–æ¯ä¸€è¡Œ while (read_line(buf, sizeof(buf)) \u003e 0) { // åˆ›å»ºå‘½ä»¤è¡Œå‚æ•°æ•°ç»„ char *cmd_argv[MAXARG + 2]; // +2: ä¸€ä¸ªå­˜æ”¾å‘½ä»¤åï¼Œä¸€ä¸ªå­˜æ”¾æ‹¼æ¥åçš„å‚æ•° cmd_argv[0] = argv[1]; // å‘½ä»¤åç§° int i; // å¤åˆ¶ç”¨æˆ·æä¾›çš„åˆå§‹å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰ for (i = 1; i \u003c argc - 1 \u0026\u0026 i \u003c MAXARG; i++) { cmd_argv[i] = argv[i + 1]; } // å°†è¯»å–çš„è¡Œä½œä¸ºæœ€åä¸€ä¸ªå‚æ•° cmd_argv[i++] = buf; cmd_argv[i] = 0; // å‚æ•°åˆ—è¡¨ä»¥ null ç»ˆæ­¢ int pid = fork(); // åˆ›å»ºå­è¿›ç¨‹ if (pid \u003c 0) { fprintf(2, \"xargs: fork failed\\n\"); // å¦‚æœåˆ›å»ºå­è¿›ç¨‹å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ exit(1); // é€€å‡ºç¨‹åº } else if (pid == 0) { exec(cmd_argv[0], cmd_argv); // æ‰§è¡Œå‘½ä»¤ fprintf(2, \"xargs: exec failed\\n\"); // å¦‚æœæ‰§è¡Œå‘½ä»¤å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ exit(1); // é€€å‡ºå­è¿›ç¨‹ } else { // çˆ¶è¿›ç¨‹ä¸­ wait(0); // ç­‰å¾…å­è¿›ç¨‹å®Œæˆ } } exit(0); // æ­£å¸¸é€€å‡ºç¨‹åº } ",
  "wordCount" : "5897",
  "inLanguage": "zh",
  "datePublished": "2024-08-31T22:30:13+08:00",
  "dateModified": "2024-08-31T22:20:13+08:00",
  "author":{
    "@type": "Person",
    "name": "ShowGuan"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kennems.github.io/posts/tech/mit6.s0811-os-overview/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Kennem's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kennems.github.io/img/sun.png"
    }
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>




</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kennems.github.io/" accesskey="h" title="Kennem&#39;s Blog (Alt + H)">
                <img src="https://kennems.github.io/img/sun.png" alt="" aria-label="logo"
                    height="35">Kennem&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://kennems.github.io/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/archives" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/categories" title="ğŸ—‚ï¸åˆ†ç±»">
                    <span>ğŸ—‚ï¸åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://kennems.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://kennems.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://kennems.github.io/posts/tech/">ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title entry-hint-parent">
      MIT6.S081(1)-O/S overview
    </h1>
    <div class="post-description">
      MIT6.S081(1)
    </div>
    <div class="post-meta"><span title='2024-08-31 22:30:13 +0800 CST'>2024-08-31</span>&nbsp;Â·&nbsp;12 åˆ†é’Ÿ&nbsp;Â·&nbsp;5897 å­—&nbsp;Â·&nbsp;updated:&nbsp;2024-08-31&nbsp;Â·&nbsp;ShowGuan

</div>
    
     <div class="post-password">
        
    </div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#mit6s0811-os-overview" aria-label="MIT6.S081(1)-O/S overview">MIT6.S081(1)-O/S overview</a><ul>
                            
                    <li>
                        <a href="#class-pagehttpspdoscsailmitedu6s0812020schedulehtml" aria-label="Class Page"><a href="https://pdos.csail.mit.edu/6.S081/2020/schedule.html">Class Page</a></a></li>
                    <li>
                        <a href="#overview" aria-label="Overview">Overview</a><ul>
                            
                    <li>
                        <a href="#6s081-goals" aria-label="6.S081 goals">6.S081 goals</a></li>
                    <li>
                        <a href="#what-is-the-purpose-of-an-os" aria-label="What is the purpose of an O/S?">What is the purpose of an O/S?</a></li>
                    <li>
                        <a href="#organization-layered-picture" aria-label="Organization: layered picture">Organization: layered picture</a></li>
                    <li>
                        <a href="#what-services-does-an-os-kernel-typically-provide" aria-label="What services does an O/S kernel typically provide?">What services does an O/S kernel typically provide?</a></li>
                    <li>
                        <a href="#whats-the-application--kernel-interface" aria-label="What&rsquo;s the application / kernel interface?">What&rsquo;s the application / kernel interface?</a></li>
                    <li>
                        <a href="#system-calls" aria-label="System Calls">System Calls</a></li>
                    <li>
                        <a href="#why-is-os-design--implementation-hard-and-interesting" aria-label="Why is O/S design &#43; implementation hard and interesting?">Why is O/S design + implementation hard and interesting?</a></li></ul>
                    </li>
                    <li>
                        <a href="#class-structure" aria-label="Class structure">Class structure</a></li>
                    <li>
                        <a href="#introduction-to-unix-system-calls" aria-label="Introduction to UNIX system calls">Introduction to UNIX system calls</a></li>
                    <li>
                        <a href="#why-unix" aria-label="Why UNIX?">Why UNIX?</a><ul>
                            
                    <li>
                        <a href="#example-copyc-copy-input-to-output" aria-label="Example: copy.c, copy input to output">Example: copy.c, copy input to output</a><ul>
                            
                    <li>
                        <a href="#copyc" aria-label="copy.c">copy.c</a></li></ul>
                    </li>
                    <li>
                        <a href="#where-do-file-descriptors-come-from" aria-label="Where do file descriptors come from?">Where do file descriptors come from?</a><ul>
                            
                    <li>
                        <a href="#what-happens-when-a-program-calls-a-system-call-like-open" aria-label="What happens when a program calls a system call like open()?">What happens when a program calls a system call like open()?</a></li></ul>
                    </li>
                    <li>
                        <a href="#fork-%e5%92%8c-exec-%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="fork å’Œ exec çš„åŒºåˆ«"><code>fork</code> å’Œ <code>exec</code> çš„åŒºåˆ«</a><ul>
                            
                    <li>
                        <a href="#fork-%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="fork ç³»ç»Ÿè°ƒç”¨"><strong><code>fork</code> ç³»ç»Ÿè°ƒç”¨</strong></a></li>
                    <li>
                        <a href="#exec-%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="exec ç³»ç»Ÿè°ƒç”¨"><strong><code>exec</code> ç³»ç»Ÿè°ƒç”¨</strong></a></li></ul>
                    </li>
                    <li>
                        <a href="#its-worth-asking-why-about-design-decisions" aria-label="It&rsquo;s worth asking &ldquo;why&rdquo; about design decisions:">It&rsquo;s worth asking &ldquo;why&rdquo; about design decisions:</a></li>
                    <li>
                        <a href="#summary" aria-label="Summary">Summary</a></li></ul>
                    </li>
                    <li>
                        <a href="#code" aria-label="Code">Code</a><ul>
                            
                    <li>
                        <a href="#pipes" aria-label="Pipes">Pipes</a></li>
                    <li>
                        <a href="#catc" aria-label="cat.c">cat.c</a></li>
                    <li>
                        <a href="#echoc" aria-label="echo.c">echo.c</a></li>
                    <li>
                        <a href="#forktestc" aria-label="forktest.c">forktest.c</a></li>
                    <li>
                        <a href="#stressfsc" aria-label="stressfs.c">stressfs.c</a></li></ul>
                    </li>
                    <li>
                        <a href="#lab---utilhttpspdoscsailmitedu6s0812020labsutilhtml" aria-label="Lab - Util"><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/util.html">Lab - Util</a></a><ul>
                            
                    <li>
                        <a href="#sleep-easyhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="sleep (easy)">sleep (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)</a></li>
                    <li>
                        <a href="#pingpong-easyhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="pingpong (easy)">pingpong (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)</a></li>
                    <li>
                        <a href="#primes-moderatehttpspdoscsailmitedu6s0812020labsguidancehtmlhardhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="primes (moderate)/(hard)">primes (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)/(<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)</a></li>
                    <li>
                        <a href="#find-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="find (moderate)">find (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)</a></li>
                    <li>
                        <a href="#xargs-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="xargs (moderate)">xargs (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h1 id="mit6s0811-os-overview">MIT6.S081(1)-O/S overview<a hidden class="anchor" aria-hidden="true" href="#mit6s0811-os-overview">#</a></h1>
<h2 id="class-pagehttpspdoscsailmitedu6s0812020schedulehtml"><a href="https://pdos.csail.mit.edu/6.S081/2020/schedule.html">Class Page</a><a hidden class="anchor" aria-hidden="true" href="#class-pagehttpspdoscsailmitedu6s0812020schedulehtml">#</a></h2>
<h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<h3 id="6s081-goals">6.S081 goals<a hidden class="anchor" aria-hidden="true" href="#6s081-goals">#</a></h3>
<ul>
<li>Understand operating system (O/S) design and implementation</li>
<li>Hands-on experience extending a small O/S</li>
<li>Hands-on experience writing systems software</li>
</ul>
<h3 id="what-is-the-purpose-of-an-os">What is the purpose of an O/S?<a hidden class="anchor" aria-hidden="true" href="#what-is-the-purpose-of-an-os">#</a></h3>
<ul>
<li><strong>Abstract the hardware</strong> for convenience and portability</li>
<li><strong>Multiplex</strong> the hardware among many applications</li>
<li><strong>Isolate</strong> applications in order to contain bugs</li>
<li>Allow <strong>sharing</strong> among cooperating applications</li>
<li>Control sharing for <strong>security</strong></li>
<li>Don&rsquo;t get in the way of high <strong>performance</strong></li>
<li>Support a wide <strong>range of applications</strong></li>
</ul>
<h3 id="organization-layered-picture">Organization: layered picture<a hidden class="anchor" aria-hidden="true" href="#organization-layered-picture">#</a></h3>
<ul>
<li>user applications: <code>vi</code>, <code>gcc</code>, <code>DB</code>, &amp;c</li>
<li>kernel services</li>
<li>h/w: <code>CPU</code>, <code>RAM</code>, <code>disk</code>, <code>net</code>, &amp;c</li>
</ul>
<ul>
<li>we care a lot about the interfaces and internal kernel structure</li>
</ul>
<p>
<img alt="image-20240830172602324" loading="lazy" src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240830172602324.png">

    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240830172602324.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240830172602324.png" alt="image-20240830172602324"  />
        </a>
    </div>
</p>
<h3 id="what-services-does-an-os-kernel-typically-provide">What services does an O/S kernel typically provide?<a hidden class="anchor" aria-hidden="true" href="#what-services-does-an-os-kernel-typically-provide">#</a></h3>
<ul>
<li>process (a running program)</li>
<li>memory allocation</li>
<li>file contents</li>
<li>file names, directories</li>
<li>access control (security)</li>
<li>many others: users, IPCï¼ˆInter-Process Communicationï¼‰, network, time, terminals</li>
</ul>
<h3 id="whats-the-application--kernel-interface">What&rsquo;s the application / kernel interface?<a hidden class="anchor" aria-hidden="true" href="#whats-the-application--kernel-interface">#</a></h3>
<ul>
<li>
<p><strong>&ldquo;System calls&rdquo;</strong></p>
</li>
<li>
<p>Examples, in C, from UNIX (e.g. Linux, macOS, FreeBSD):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;out&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">write</span>(fd, <span style="color:#e6db74">&#34;hello</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>();
</span></span></code></pre></div></li>
<li>
<p>These look like function calls but they aren&rsquo;t</p>
</li>
</ul>
<h3 id="system-calls">System Calls<a hidden class="anchor" aria-hidden="true" href="#system-calls">#</a></h3>
<table>
<thead>
<tr>
<th>å‡½æ•°å</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int fork()</code></td>
<td>åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œè¿”å›å­è¿›ç¨‹çš„ PIDã€‚</td>
</tr>
<tr>
<td><code>int exit(int status)</code></td>
<td>ç»ˆæ­¢å½“å‰è¿›ç¨‹ï¼Œ<code>status</code> è¿”å›ç»™ <code>wait()</code>ï¼Œä¸è¿”å›ã€‚</td>
</tr>
<tr>
<td><code>int wait(int *status)</code></td>
<td>ç­‰å¾…å­è¿›ç¨‹é€€å‡ºï¼Œé€€å‡ºçŠ¶æ€å­˜å…¥ <code>*status</code>ï¼Œè¿”å›å­è¿›ç¨‹çš„ PIDã€‚</td>
</tr>
<tr>
<td><code>int kill(int pid)</code></td>
<td>ç»ˆæ­¢è¿›ç¨‹ PIDã€‚è¿”å› 0 æˆ– -1ï¼ˆè¡¨ç¤ºé”™è¯¯ï¼‰ã€‚</td>
</tr>
<tr>
<td><code>int getpid()</code></td>
<td>è¿”å›å½“å‰è¿›ç¨‹çš„ PIDã€‚</td>
</tr>
<tr>
<td><code>int sleep(int n)</code></td>
<td>æš‚åœ <code>n</code> ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚</td>
</tr>
<tr>
<td><code>int exec(char *file, char *argv[])</code></td>
<td>åŠ è½½å¹¶æ‰§è¡Œæ–‡ä»¶ <code>file</code>ï¼Œä¼ å…¥å‚æ•° <code>argv[]</code>ï¼Œä»…åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å›ã€‚</td>
</tr>
<tr>
<td><code>char *sbrk(int n)</code></td>
<td>å¢åŠ  <code>n</code> å­—èŠ‚çš„è¿›ç¨‹å†…å­˜ï¼Œè¿”å›æ–°å†…å­˜çš„èµ·å§‹åœ°å€ã€‚</td>
</tr>
<tr>
<td><code>int open(char *file, int flags)</code></td>
<td>æ‰“å¼€æ–‡ä»¶ï¼Œ<code>flags</code> æŒ‡ç¤ºè¯»/å†™æ¨¡å¼ï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚</td>
</tr>
<tr>
<td><code>int write(int fd, char *buf, int n)</code></td>
<td>ä» <code>buf</code> ä¸­å‘æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> å†™å…¥ <code>n</code> å­—èŠ‚ï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚æ•°ã€‚</td>
</tr>
<tr>
<td><code>int read(int fd, char *buf, int n)</code></td>
<td>ä»æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> ä¸­è¯»å– <code>n</code> å­—èŠ‚åˆ° <code>buf</code>ï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°æˆ– 0ï¼ˆæ–‡ä»¶ç»“æŸï¼‰ã€‚</td>
</tr>
<tr>
<td><code>int close(int fd)</code></td>
<td>å…³é—­æ–‡ä»¶æè¿°ç¬¦ <code>fd</code>ã€‚</td>
</tr>
<tr>
<td><code>int dup(int fd)</code></td>
<td>è¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒæŒ‡å‘ä¸ <code>fd</code> ç›¸åŒçš„æ–‡ä»¶ã€‚</td>
</tr>
<tr>
<td><code>int pipe(int p[])</code></td>
<td>åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå°†è¯»/å†™æ–‡ä»¶æè¿°ç¬¦æ”¾å…¥ <code>p[0]</code> å’Œ <code>p[1]</code>ã€‚</td>
</tr>
<tr>
<td><code>int chdir(char *dir)</code></td>
<td>æ›´æ”¹å½“å‰ç›®å½•ä¸º <code>dir</code>ã€‚</td>
</tr>
<tr>
<td><code>int mkdir(char *dir)</code></td>
<td>åˆ›å»ºä¸€ä¸ªæ–°ç›®å½• <code>dir</code>ã€‚</td>
</tr>
<tr>
<td><code>int mknod(char *file, int, int)</code></td>
<td>åˆ›å»ºä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ã€‚</td>
</tr>
<tr>
<td><code>int fstat(int fd, struct stat *st)</code></td>
<td>å°†å…³äºæ‰“å¼€æ–‡ä»¶çš„ä¿¡æ¯æ”¾å…¥ <code>*st</code>ã€‚</td>
</tr>
<tr>
<td><code>int stat(char *file, struct stat *st)</code></td>
<td>å°†å…³äºæ–‡ä»¶ <code>file</code> çš„ä¿¡æ¯æ”¾å…¥ <code>*st</code>ã€‚</td>
</tr>
<tr>
<td><code>int link(char *file1, char *file2)</code></td>
<td>ä¸ºæ–‡ä»¶ <code>file1</code> åˆ›å»ºå¦ä¸€ä¸ªåç§° <code>file2</code>ã€‚</td>
</tr>
<tr>
<td><code>int unlink(char *file)</code></td>
<td>åˆ é™¤æ–‡ä»¶ <code>file</code>ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="why-is-os-design--implementation-hard-and-interesting">Why is O/S design + implementation hard and interesting?<a hidden class="anchor" aria-hidden="true" href="#why-is-os-design--implementation-hard-and-interesting">#</a></h3>
<ul>
<li>
<p>unforgiving environment: quirky h/w, hard to debug</p>
</li>
<li>
<p>many design tensions:</p>
<ul>
<li>efficient vs abstract / portable / general-purpose</li>
<li>powerful vs simple interfaces</li>
<li>flexible vs secure</li>
</ul>
</li>
<li>
<p>features interact: <code>fd = open(); fork()</code></p>
</li>
<li>
<p>uses are varied: laptops, smart-phones, cloud, virtual machines, embedded</p>
</li>
<li>
<p>evolving hardware: NVRAM, multi-core, fast networks</p>
</li>
<li>
<p>You&rsquo;ll be glad you took this course if you&hellip;</p>
<ul>
<li>care about what goes on under the hood</li>
<li>like infrastructure</li>
<li>need to track down bugs or security problems</li>
<li>care about high performance</li>
</ul>
</li>
</ul>
<h2 id="class-structure">Class structure<a hidden class="anchor" aria-hidden="true" href="#class-structure">#</a></h2>
<ul>
<li>
<p>Online course information:
<a href="https://pdos.csail.mit.edu/6.S081/2020">https://pdos.csail.mit.edu/6.S081/2020</a> &ndash; schedule, assignments, labs
Piazza &ndash; announcements, discussion, lab help</p>
</li>
<li>
<p>Lectures</p>
<ul>
<li>O/S ideas</li>
<li>case study of xv6, a small O/S, via code and xv6 book</li>
<li>lab background</li>
<li>O/S papers</li>
<li>submit a question about each reading, before lecture.</li>
</ul>
</li>
<li>
<p>Labs:
The point: hands-on experience
Mostly one week each.
Three kinds:
Systems programming (due next week&hellip;)
O/S primitives, e.g. thread switching.
O/S kernel extensions to xv6, e.g. network.
Use piazza to ask/answer lab questions.
Discussion is great, but please do not look at others&rsquo; solutions!</p>
</li>
<li>
<p>Grading:
70% labs, based on tests (the same tests you run).
20% lab check-off meetings: we&rsquo;ll ask you about randomly-selected labs.
10% home-work and class/piazza discussion.
No exams, no quizzes.
Note that most of the grade is from labs. Start them early!</p>
</li>
</ul>
<h2 id="introduction-to-unix-system-calls">Introduction to UNIX system calls<a hidden class="anchor" aria-hidden="true" href="#introduction-to-unix-system-calls">#</a></h2>
<ul>
<li>I&rsquo;ll show some examples, and run them on xv6.
xv6 has similar structure to UNIX systems such as Linux.
but much simpler &ndash; you&rsquo;ll be able to digest all of xv6
accompanying book explains how xv6 works, and why</li>
</ul>
<h2 id="why-unix">Why UNIX?<a hidden class="anchor" aria-hidden="true" href="#why-unix">#</a></h2>
<p>open source, well documented, clean design, widely used
studying xv6 will help if you ever need to look inside Linux
xv6 has two roles in 6.S081:
example of core functions: virtual memory, multi-core, interrupts, &amp;c
starting point for most of the labs
xv6 runs on RISC-V, as in current 6.004
you&rsquo;ll run xv6 under the qemu machine emulator</p>
<h3 id="example-copyc-copy-input-to-output">Example: copy.c, copy input to output<a hidden class="anchor" aria-hidden="true" href="#example-copyc-copy-input-to-output">#</a></h3>
<p>read bytes from input, write them to the output</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ copy
</span></span></code></pre></div><p><code>copy.c</code> is written in C
Kernighan and Ritchie (K&amp;R) book is good for learning C
you can find these example programs via the schedule on the web site</p>
<h4 id="copyc">copy.c<a hidden class="anchor" aria-hidden="true" href="#copyc">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// copy.c: å¤åˆ¶è¾“å…¥åˆ°è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;   // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;      // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ read, write, exitï¼‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">64</span>];  <span style="color:#75715e">// å®šä¹‰ä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨è¯»å–çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// æ— é™å¾ªç¯ï¼Œç›´åˆ°è¯»å–åˆ°æ–‡ä»¶ç»“æŸæ ‡å¿—æˆ–å‡ºç°é”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä»æ ‡å‡†è¾“å…¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦ 0ï¼‰ä¸­è¯»å–æ•°æ®åˆ° buf ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœè¯»å–åˆ°çš„æ•°æ®é‡å°äºç­‰äº 0ï¼Œåˆ™è¡¨ç¤ºè¾“å…¥ç»“æŸæˆ–å‘ç”Ÿäº†é”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;  <span style="color:#75715e">// é€€å‡ºå¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†è¯»å–çš„æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, buf, n);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// æ­£å¸¸é€€å‡ºç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>read()</code> and <code>write()</code> are system calls
<strong>first</strong> <code>read()/write()</code> argument is a <code>&quot;file descriptor&quot;</code> <code>(fd)</code>
passed to kernel to tell it which &ldquo;open file&rdquo; to read/write
must previously have been opened</p>
<p>an FD connects to a <code>file</code>/<code>device</code>/<code>socket</code>/&amp;c
a process can open many files, have many FDs</p>
<p><strong>UNIX convention</strong>: fd 0 is &ldquo;standard input&rdquo;, 1 is &ldquo;standard output&rdquo;</p>
<p><strong>second</strong> read() argument is a pointer to some memory into which to read</p>
<p><strong>third</strong> argument is the maximum number of bytes to read
read() may read less, but not more
return value: number of bytes actually read, or -1 for error</p>
<p><strong>note</strong>: <code>copy.c</code> does not care about the format of the data
UNIX I/O is 8-bit bytes
interpretation is application-specific, e.g. database records, C source, &amp;c</p>
<h3 id="where-do-file-descriptors-come-from">Where do file descriptors come from?<a hidden class="anchor" aria-hidden="true" href="#where-do-file-descriptors-come-from">#</a></h3>
<ul>
<li>
<p>example: open.c, create a file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ open
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat output.txt
</span></span></code></pre></div></li>
</ul>
<p><code>	open()</code> creates a file, returns a file descriptor (or -1 for error)
<strong>FD is a small integer</strong>
FD indexes into a per-process table maintained by kernel
[user/kernel diagram]
different processes have different FD name-spaces
i.e. FD 1 often means different things to different processes
these examples ignore errors &ndash; don&rsquo;t be this sloppy!
Figure 1.2 in the xv6 book lists system call arguments/return
or look at UNIX man pages, e.g. &ldquo;man 2 open&rdquo;</p>
<h4 id="what-happens-when-a-program-calls-a-system-call-like-open">What happens when a program calls a system call like open()?<a hidden class="anchor" aria-hidden="true" href="#what-happens-when-a-program-calls-a-system-call-like-open">#</a></h4>
<p>looks like a function call, but it&rsquo;s actually a <strong>special instruction</strong>
hardware saves some user registers
hardware increases privilege level
hardware jumps to a known &ldquo;entry point&rdquo; in the kernel
now running C code in the kernel
kernel calls system call implementation
<code>open()</code> looks up name in file system
it might wait for the disk
it updates kernel data structures (cache, FD table)
restore user registers
reduce privilege level
jump back to calling point in the program, which resumes
we&rsquo;ll see more detail later in the course</p>
<ul>
<li>
<p>I&rsquo;ve been typing to UNIX&rsquo;s command-line interface, the shell.
the shell prints the &ldquo;$&rdquo; prompts.
the shell lets you run UNIX command-line utilities
useful for system management, messing with files, development, scripting</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls &gt; out
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ grep x &lt; out
</span></span></code></pre></div><p>UNIX supports other styles of interaction too
<code>window systems</code>, <code>GUIs</code>, <code>servers</code>, <code>routers</code>, &amp;c.
but time-sharing via the shell was the original focus of UNIX.
we can exercise many system calls via the shell.</p>
</li>
<li>
<p>example: <code>fork.c</code>, create a new process</p>
</li>
</ul>
<p>â€‹	the shell creates a new process for each command you type, e.g. for</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ echo hello
</span></span></code></pre></div><p>the <code>fork()</code> system call creates a new process</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ fork
</span></span></code></pre></div><p>the kernel makes a copy of the calling process
instructions, data, registers, file descriptors, current directory
&ldquo;parent&rdquo; and &ldquo;child&rdquo; processes
only difference: <code>fork()</code> returns a pid in parent, 0 in child
a pid (process ID) is an integer, kernel gives each process a different pid
thus:
<code>fork.c</code>&rsquo;s &ldquo;fork() returned&rdquo; executes in <em>both</em> processes
the &ldquo;if(pid == 0)&rdquo; allows code to distinguish
ok, fork lets us create a new process
how can we run a program in that process?</p>
<ul>
<li>
<p>example: <code>exec.c</code>, replace calling process with an executable file
how does the shell run a program, e.g.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ echo a b c
</span></span></code></pre></div><p>a program is stored in a file: instructions and initial memory
created by the compiler and linker
so there&rsquo;s a file called echo, containing instructions</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ exec
</span></span></code></pre></div><p><code>exec()</code> replaces current process with an executable file
discards instruction and data memory
loads instructions and memory from the file
preserves file descriptors
<code>exec(filename, argument-array)</code>
argument-array holds command-line arguments; exec passes to main()
cat user/echo.c
echo.c shows how a program looks at its command-line arguments</p>
</li>
<li>
<p>example: forkexec.c, <code>fork()</code> a new process, exec() a program</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forkexec
</span></span></code></pre></div><p>forkexec.c contains a common UNIX idiom:
<code>fork()</code> :  a child process
<code>exec()</code>  : a command in the child
parent wait()s for child to finish
the shell does fork/exec/wait for every command you type
after <code>wait()</code>, the shell prints the next prompt
to run in the background &ndash; &amp; &ndash; the shell skips the <code>wait()</code>
<code>exit(status)</code> <code>-&gt;</code> <code>wait(&amp;status)</code>
status convention: 0 = success, 1 = command encountered an error
note: the <code>fork()</code> copies, but <code>exec()</code> discards the copied memory
this may seem wasteful
you&rsquo;ll transparently eliminate the copy in the &ldquo;copy-on-write&rdquo; lab</p>
</li>
</ul>
<h3 id="fork-å’Œ-exec-çš„åŒºåˆ«"><code>fork</code> å’Œ <code>exec</code> çš„åŒºåˆ«<a hidden class="anchor" aria-hidden="true" href="#fork-å’Œ-exec-çš„åŒºåˆ«">#</a></h3>
<p><strong><code>fork</code></strong> ç”¨äºåˆ›å»ºæ–°è¿›ç¨‹ï¼Œçˆ¶å­è¿›ç¨‹å¹¶å‘æ‰§è¡Œã€‚</p>
<p><strong><code>exec</code></strong> ç”¨äºåœ¨ç°æœ‰è¿›ç¨‹ä¸­åŠ è½½å¹¶è¿è¡Œæ–°ç¨‹åºã€‚</p>
<h4 id="fork-ç³»ç»Ÿè°ƒç”¨"><strong><code>fork</code> ç³»ç»Ÿè°ƒç”¨</strong><a hidden class="anchor" aria-hidden="true" href="#fork-ç³»ç»Ÿè°ƒç”¨">#</a></h4>
<ul>
<li><strong>åŠŸèƒ½</strong>ï¼š<code>fork</code> ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç§°ä¸ºå­è¿›ç¨‹ã€‚å­è¿›ç¨‹æ˜¯é€šè¿‡å¤åˆ¶å½“å‰è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰çš„åœ°å€ç©ºé—´åˆ›å»ºçš„ï¼Œå› æ­¤å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å‡ ä¹å®Œå…¨ç›¸åŒï¼Œæ‹¥æœ‰ç›¸åŒçš„ä»£ç ã€æ•°æ®å’Œæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
<li>æ‰§è¡Œç»“æœï¼š
<ul>
<li>çˆ¶è¿›ç¨‹è°ƒç”¨ <code>fork</code> åï¼Œè¿”å›å€¼æ˜¯å­è¿›ç¨‹çš„ PIDã€‚</li>
<li>å­è¿›ç¨‹ä» <code>fork</code> è¿”å›æ—¶ï¼Œè¿”å›å€¼æ˜¯ 0ã€‚</li>
</ul>
</li>
<li>ç‰¹ç‚¹ï¼š
<ul>
<li>å­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‡ ä¹ç²¾ç¡®å‰¯æœ¬ï¼ŒåŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ã€å˜é‡ã€ä»£ç æ®µç­‰ï¼Œä½†å…¶ PIDï¼ˆè¿›ç¨‹ IDï¼‰ä¸åŒã€‚</li>
<li><strong>å¹¶å‘æ‰§è¡Œ</strong>ï¼š<code>fork</code> ä¹‹åï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œå„è‡ªçš„ä»£ç ã€‚</li>
<li><strong>å¤šæ¬¡è¿”å›</strong>ï¼š<code>fork</code> ä¼šè¿”å›ä¸¤æ¬¡ï¼Œä¸€æ¬¡åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œä¸€æ¬¡åœ¨å­è¿›ç¨‹ä¸­ã€‚</li>
</ul>
</li>
</ul>
<h4 id="exec-ç³»ç»Ÿè°ƒç”¨"><strong><code>exec</code> ç³»ç»Ÿè°ƒç”¨</strong><a hidden class="anchor" aria-hidden="true" href="#exec-ç³»ç»Ÿè°ƒç”¨">#</a></h4>
<ul>
<li><strong>åŠŸèƒ½</strong>ï¼š<code>exec</code> ç”¨äºæ›¿æ¢å½“å‰è¿›ç¨‹çš„ä»£ç å’Œæ•°æ®æ®µï¼ŒåŠ è½½ä¸€ä¸ªæ–°ç¨‹åºå¹¶æ‰§è¡Œè¯¥ç¨‹åºã€‚å½“ <code>exec</code> è¢«è°ƒç”¨æ—¶ï¼Œå½“å‰è¿›ç¨‹çš„æ‰€æœ‰å†…å®¹ï¼ˆå¦‚ä»£ç ã€æ•°æ®ã€å †æ ˆï¼‰éƒ½è¢«æ–°ç¨‹åºæ›¿æ¢ï¼Œä½†è¿›ç¨‹çš„ PID ä¸å˜ã€‚</li>
<li>æ‰§è¡Œç»“æœï¼š
<ul>
<li><code>exec</code> ä¸è¿”å›ï¼Œé™¤éè°ƒç”¨å¤±è´¥ã€‚æˆåŠŸè°ƒç”¨ <code>exec</code> åï¼Œæ—§çš„ç¨‹åºä»£ç å®Œå…¨è¢«æ–°ç¨‹åºæ›¿æ¢ã€‚</li>
<li>æ–‡ä»¶æè¿°ç¬¦ä¸ä¼šè¢«å…³é—­ï¼ˆé™¤éè®¾ç½®äº† <code>close-on-exec</code> æ ‡å¿—ï¼‰ã€‚</li>
</ul>
</li>
<li>ç‰¹ç‚¹ï¼š
<ul>
<li><code>exec</code> åªä¼šæ”¹å˜è¿›ç¨‹çš„æ‰§è¡Œä»£ç ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚</li>
<li>æ–°ç¨‹åºç»§æ‰¿äº†è°ƒç”¨è¿›ç¨‹çš„ PID å’Œæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†åŸæœ‰çš„å†…å­˜æ•°æ®ã€å †æ ˆã€ä»£ç ç­‰éƒ½ä¼šè¢«æ–°ç¨‹åºæ›¿æ¢æ‰ã€‚</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>example: <code>redirect.c</code>, redirect the output of a command
what does the shell do for this?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ echo hello &gt; out
</span></span></code></pre></div><p>answer: fork, change FD 1 in child, exec echo</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ redirect
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat output.txt
</span></span></code></pre></div><p><strong>note</strong>: <code>open()</code> always chooses lowest unused FD; 1 due to <code>close(1)</code>.
fork, FDs, and exec interact nicely to implement I/O redirection
separate fork-then-exec give child a chance to change FDs before exec
FDs provide indirection
commands just use FDs 0 and 1, don&rsquo;t have to know where they go
exec preserves the FDs that sh set up
thus: only sh has to know about I/O redirection, not each program</p>
</li>
</ul>
<h3 id="its-worth-asking-why-about-design-decisions">It&rsquo;s worth asking &ldquo;why&rdquo; about design decisions:<a hidden class="anchor" aria-hidden="true" href="#its-worth-asking-why-about-design-decisions">#</a></h3>
<p>Why these I/O and process abstractions? Why not something else?
Why provide a file system? Why not let programs use the disk their own way?
Why FDs? Why not pass a filename to write()?
Why are files streams of bytes, not disk blocks or formatted records?
Why not combine fork() and exec()?
The UNIX design works well, but we will see other designs!</p>
<ul>
<li>
<p>example: pipe1.c, communicate through a pipe
how does the shell implement</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls | grep x
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pipe1
</span></span></code></pre></div><p>an FD can refer to a &ldquo;pipe&rdquo;, as well as a file
the pipe() system call creates two FDs
read from the first FD
write to the second FD
the kernel maintains a buffer for each pipe
[u/k diagram]
<code>write()</code> appends to the buffer
<code>read()</code> waits until there is data</p>
</li>
<li>
<p>example: pipe2.c, communicate between processes
pipes combine well with fork() to implement ls | grep x
shell creates a pipe,
then forks (twice),
then connects ls&rsquo;s FD 1 to pipe&rsquo;s write FD,
and grep&rsquo;s FD 0 to the pipe
[diagram]</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pipe2 -- a simplified version 
</span></span></code></pre></div><p>pipes are a separate abstraction, but combine well w/ fork()</p>
</li>
<li>
<p>example: list.c, list files in a directory
how does ls get a list of the files in a directory?
you can open a directory and read it -&gt; file names
&ldquo;.&rdquo; is a pseudo-name for a process&rsquo;s current directory
see ls.c for more details</p>
</li>
</ul>
<h3 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h3>
<ul>
<li>We&rsquo;ve looked at UNIX&rsquo;s I/O, file system, and process abstractions.</li>
<li>The interfaces are simple &ndash; just integers and I/O buffers.</li>
<li>The abstractions combine well, e.g. for I/O redirection.</li>
</ul>
<p>You&rsquo;ll use these system calls in the first lab, due next week.</p>
<h2 id="code">Code<a hidden class="anchor" aria-hidden="true" href="#code">#</a></h2>
<h3 id="pipes">Pipes<a hidden class="anchor" aria-hidden="true" href="#pipes">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> pipeFd[<span style="color:#ae81ff">2</span>];    <span style="color:#75715e">// ç®¡é“æ–‡ä»¶æè¿°ç¬¦æ•°ç»„ï¼ŒpipeFd[0]ä¸ºè¯»å–ç«¯ï¼ŒpipeFd[1]ä¸ºå†™å…¥ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>arguments[<span style="color:#ae81ff">2</span>];  <span style="color:#75715e">// å­˜å‚¨ä¼ é€’ç»™execçš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®¾ç½®è¦æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    arguments[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wc&#34;</span>;   <span style="color:#75715e">// å°† &#34;wc&#34; å‘½ä»¤ä½œä¸ºå‚æ•°ä¼ é€’ç»™execï¼Œç”¨äºç»Ÿè®¡è¾“å…¥çš„è¡Œã€å•è¯å’Œå­—ç¬¦æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    arguments[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;      <span style="color:#75715e">// ä»¥NULLè¡¨ç¤ºå‚æ•°ç»“æŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ›å»ºç®¡é“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pipe</span>(pipeFd);          <span style="color:#75715e">// pipeFd[0]ç”¨äºè¯»å–ï¼ŒpipeFd[1]ç”¨äºå†™å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ›å»ºå­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">fork</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {      <span style="color:#75715e">// å­è¿›ç¨‹ä»£ç ï¼Œfork()è¿”å›0è¡¨ç¤ºå½“å‰æ˜¯å­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(<span style="color:#ae81ff">0</span>);          <span style="color:#75715e">// å…³é—­æ ‡å‡†è¾“å…¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦0ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">dup</span>(pipeFd[<span style="color:#ae81ff">0</span>]);    <span style="color:#75715e">// å°†ç®¡é“çš„è¯»å–ç«¯å¤åˆ¶åˆ°æ–‡ä»¶æè¿°ç¬¦0ï¼Œä½¿æ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°ç®¡é“çš„è¯»å–ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipeFd[<span style="color:#ae81ff">0</span>]);  <span style="color:#75715e">// å…³é—­ç®¡é“çš„è¯»å–ç«¯ï¼Œå·²é‡å®šå‘åˆ°æ ‡å‡†è¾“å…¥ï¼Œä¸å†éœ€è¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipeFd[<span style="color:#ae81ff">1</span>]);  <span style="color:#75715e">// å…³é—­ç®¡é“çš„å†™å…¥ç«¯ï¼Œå­è¿›ç¨‹ä¸è´Ÿè´£å†™å…¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">exec</span>(<span style="color:#e6db74">&#34;/bin/wc&#34;</span>, arguments);  <span style="color:#75715e">// æ‰§è¡Œwcå‘½ä»¤ï¼Œè¯»å–æ ‡å‡†è¾“å…¥ï¼ˆä»ç®¡é“ä¸­è¯»å–ï¼‰ï¼Œè®¡ç®—è¡Œã€å•è¯å’Œå­—ç¬¦æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {               <span style="color:#75715e">// çˆ¶è¿›ç¨‹ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipeFd[<span style="color:#ae81ff">0</span>]);  <span style="color:#75715e">// å…³é—­ç®¡é“çš„è¯»å–ç«¯ï¼Œçˆ¶è¿›ç¨‹ä¸è´Ÿè´£è¯»å–æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// å‘ç®¡é“å†™å…¥æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">write</span>(pipeFd[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;hello world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">12</span>);  <span style="color:#75715e">// å°† &#34;hello world\n&#34; å†™å…¥ç®¡é“ï¼Œä¾›å­è¿›ç¨‹è¯»å–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipeFd[<span style="color:#ae81ff">1</span>]);  <span style="color:#75715e">// å…³é—­ç®¡é“çš„å†™å…¥ç«¯ï¼Œè¡¨ç¤ºæ•°æ®å†™å…¥å®Œæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="catc">cat.c<a hidden class="anchor" aria-hidden="true" href="#catc">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;   // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;    // åŒ…å«æ–‡ä»¶çŠ¶æ€ç›¸å…³çš„å®šä¹‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;      // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ read, write, open, close, fprintf, exitï¼‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">512</span>];  <span style="color:#75715e">// å®šä¹‰ä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨è¯»å–çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‡½æ•°ï¼šcat
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‚æ•°ï¼šint fd - æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// åŠŸèƒ½ï¼šä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å°†å…¶å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span>(<span style="color:#66d9ef">int</span> fd)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å–æ•°æ®åˆ° buf ä¸­ï¼Œè¯»å–çš„å­—èŠ‚æ•°å­˜å‚¨åœ¨ n ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span>((n <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(fd, buf, <span style="color:#66d9ef">sizeof</span>(buf))) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†è¯»å–çš„æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, buf, n) <span style="color:#f92672">!=</span> n) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// å¦‚æœå†™å…¥çš„å­—èŠ‚æ•°ä¸ç­‰äºè¯»å–çš„å­—èŠ‚æ•°ï¼ŒæŠ¥å‘Šå†™å…¥é”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;cat: write error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å¦‚æœè¯»å–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼ŒæŠ¥å‘Šè¯»å–é”™è¯¯å¹¶é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;cat: read error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸»å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> fd, i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å¦‚æœæ²¡æœ‰æä¾›æ–‡ä»¶å‚æ•°ï¼Œé»˜è®¤è¯»å–æ ‡å‡†è¾“å…¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦ 0ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cat</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// éå†å‘½ä»¤è¡Œå‚æ•°ä¸­çš„æ–‡ä»¶å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;</span> argc; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ‰“å¼€æ–‡ä»¶ï¼Œè·å–æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(argv[i], <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// å¦‚æœæ–‡ä»¶æ— æ³•æ‰“å¼€ï¼ŒæŠ¥å‘Šé”™è¯¯å¹¶é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;cat: cannot open %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[i]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è°ƒç”¨ cat å‡½æ•°ï¼Œå°†æ–‡ä»¶å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">cat</span>(fd);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å…³é—­æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// æ­£å¸¸é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="echoc">echo.c<a hidden class="anchor" aria-hidden="true" href="#echoc">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;   // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;    // åŒ…å«æ–‡ä»¶çŠ¶æ€ç›¸å…³çš„å®šä¹‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;      // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ write, exit, strlenï¼‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// éå†å‘½ä»¤è¡Œå‚æ•°ï¼Œä»ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆargv[1]ï¼‰å¼€å§‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;</span> argc; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†å½“å‰å‚æ•° argv[i] å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, argv[i], <span style="color:#a6e22e">strlen</span>(argv[i]));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œåœ¨å…¶åå†™å…¥ä¸€ä¸ªç©ºæ ¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> argc){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œåœ¨å…¶åå†™å…¥ä¸€ä¸ªæ¢è¡Œç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// æ­£å¸¸é€€å‡ºç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="forktestc">forktest.c<a hidden class="anchor" aria-hidden="true" href="#forktestc">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æµ‹è¯• fork æ˜¯å¦èƒ½åœ¨è¿›ç¨‹è¡¨æ»¡æ—¶ä¼˜é›…åœ°å¤±è´¥ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿™ä¸ªç¨‹åºæ˜¯ä¸€ä¸ªå°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨äºå¡«å……è¿›ç¨‹è¡¨ä»¥æµ‹è¯• fork çš„è¡Œä¸ºã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;   // åŒ…å«ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ç±»å‹å®šä¹‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;    // åŒ…å«æ–‡ä»¶çŠ¶æ€ç›¸å…³çš„å®šä¹‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;      // åŒ…å«ç”¨æˆ·æ€å‡½æ•°çš„å£°æ˜ï¼ˆå¦‚ write, exit, fork, wait, strlenï¼‰</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define N  1000  </span><span style="color:#75715e">// å®šä¹‰æµ‹è¯•çš„ fork æœ€å¤§æ¬¡æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‡½æ•°ï¼šprint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‚æ•°ï¼šconst char *s - è¦è¾“å‡ºçš„å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// åŠŸèƒ½ï¼šå°†å­—ç¬¦ä¸² s å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, s, <span style="color:#a6e22e">strlen</span>(s));  <span style="color:#75715e">// ä½¿ç”¨ write ç³»ç»Ÿè°ƒç”¨å°†å­—ç¬¦ä¸²å†™å…¥æ ‡å‡†è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‡½æ•°ï¼šforktest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// åŠŸèƒ½ï¼šæµ‹è¯• fork ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯åœ¨è¿›ç¨‹è¡¨æ»¡æ—¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">forktest</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n, pid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// è¾“å‡ºå¼€å§‹æµ‹è¯•çš„ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;fork test</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å¾ªç¯å°è¯•åˆ›å»º N ä¸ªå­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; n <span style="color:#f92672">&lt;</span> N; n<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>();  <span style="color:#75715e">// åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(pid <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;  <span style="color:#75715e">// å¦‚æœ fork å¤±è´¥ï¼Œé€€å‡ºå¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);  <span style="color:#75715e">// å­è¿›ç¨‹é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å¦‚æœæˆåŠŸåˆ›å»ºäº† N ä¸ªå­è¿›ç¨‹ï¼Œè¡¨ç¤º fork è¡Œä¸ºå¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">==</span> N){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;fork claimed to work N times!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹ç»“æŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(; n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; n<span style="color:#f92672">--</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">wait</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){  <span style="color:#75715e">// ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;wait stopped early</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);  <span style="color:#75715e">// å¦‚æœ wait å¤±è´¥ï¼ŒæŠ¥å‘Šé”™è¯¯å¹¶é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å¦‚æœ wait æ²¡æœ‰è¿”å› -1ï¼Œè¡¨ç¤ºè¿˜æœ‰å¤šä½™çš„å­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">wait</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;wait got too many</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// è¾“å‡ºæµ‹è¯•æˆåŠŸçš„ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;fork test OK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸»å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forktest</span>();  <span style="color:#75715e">// æ‰§è¡Œ fork æµ‹è¯•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);     <span style="color:#75715e">// æ­£å¸¸é€€å‡ºç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="stressfsc">stressfs.c<a hidden class="anchor" aria-hidden="true" href="#stressfsc">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Demonstrate that moving the &#34;acquire&#34; in iderw after the loop that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// appends to the idequeue results in a race.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// For this to work, you should also add a spin within iderw&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// idequeue traversal loop.  Adding the following demonstrated a panic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// after about 5 runs of stressfs in QEMU on a 2.1GHz CPU:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    for (i = 0; i &lt; 40000; i++)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      asm volatile(&#34;&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/fs.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/fcntl.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> fd, i;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> path[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stressfs0&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> data[<span style="color:#ae81ff">512</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;stressfs starting</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(data, <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#66d9ef">sizeof</span>(data));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">fork</span>() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;write %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, i);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  path[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">+=</span> i;
</span></span><span style="display:flex;"><span>  fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(path, O_CREATE <span style="color:#f92672">|</span> O_RDWR);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">//    printf(fd, &#34;%d\n&#34;, i);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">write</span>(fd, data, <span style="color:#66d9ef">sizeof</span>(data));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;read</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(path, O_RDONLY);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(fd, data, <span style="color:#66d9ef">sizeof</span>(data));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">wait</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="lab---utilhttpspdoscsailmitedu6s0812020labsutilhtml"><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/util.html">Lab - Util</a><a hidden class="anchor" aria-hidden="true" href="#lab---utilhttpspdoscsailmitedu6s0812020labsutilhtml">#</a></h2>
<h3 id="sleep-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">sleep (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)<a hidden class="anchor" aria-hidden="true" href="#sleep-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;Usage: sleep [the times of ticks]...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> times <span style="color:#f92672">=</span> <span style="color:#a6e22e">atoi</span>(argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sleep</span>(times);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="pingpong-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">pingpong (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)<a hidden class="anchor" aria-hidden="true" href="#pingpong-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;Usage: pingpong (without any parameters)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> pipe_fd[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pipe</span>(pipe_fd) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;pipe error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// çˆ¶è¿›ç¨‹å…³é—­ç®¡é“çš„å†™ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipe_fd[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">read</span>(pipe_fd[<span style="color:#ae81ff">0</span>], buf, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">wait</span>((<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d: received pong</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">getpid</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// çˆ¶è¿›ç¨‹å…³é—­ç®¡é“çš„è¯»ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipe_fd[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å­è¿›ç¨‹å…³é—­ç®¡é“çš„è¯»ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipe_fd[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d: received ping</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">getpid</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å­è¿›ç¨‹é€šè¿‡ç®¡é“å‘çˆ¶è¿›ç¨‹å‘é€ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">write</span>(pipe_fd[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å­è¿›ç¨‹å…³é—­ç®¡é“çš„å†™ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(pipe_fd[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;fork error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="primes-moderatehttpspdoscsailmitedu6s0812020labsguidancehtmlhardhttpspdoscsailmitedu6s0812020labsguidancehtml">primes (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)/(<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)<a hidden class="anchor" aria-hidden="true" href="#primes-moderatehttpspdoscsailmitedu6s0812020labsguidancehtmlhardhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sieve</span>(<span style="color:#66d9ef">int</span> p_left) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> p_right[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> prime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä»å·¦ä¾§ç®¡é“è¯»å–ç¬¬ä¸€ä¸ªæ•°å­—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">read</span>(p_left, <span style="color:#f92672">&amp;</span>prime, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(p_left);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è¾“å‡ºè¯¥ç´ æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;prime %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, prime);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡é“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pipe</span>(p_right) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;pipe error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fork</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å­è¿›ç¨‹é€’å½’å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(p_right[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sieve</span>(p_right[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// çˆ¶è¿›ç¨‹ç»§ç»­è¯»å–å¹¶ç­›é€‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(p_right[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> num;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">read</span>(p_left, <span style="color:#f92672">&amp;</span>num, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (num <span style="color:#f92672">%</span> prime <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">write</span>(p_right[<span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>num, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å…³é—­ç®¡é“ï¼Œç­‰å¾…å­è¿›ç¨‹ç»“æŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">close</span>(p_left);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(p_right[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wait</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> p[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pipe</span>(p) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;pipe error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fork</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(p[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sieve</span>(p[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(p[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°† 2 åˆ° 35 çš„æ•°å­—å†™å…¥ç®¡é“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">35</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">write</span>(p[<span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>i, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(p[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wait</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="find-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml">find (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)<a hidden class="anchor" aria-hidden="true" href="#find-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/fs.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/fcntl.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAXBUF 512  </span><span style="color:#75715e">// å®šä¹‰ç¼“å†²åŒºå¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * find - é€’å½’æŸ¥æ‰¾ç›®å½•æ ‘ä¸­ä¸æŒ‡å®šæ–‡ä»¶ååŒ¹é…çš„æ–‡ä»¶ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @path: è¦æœç´¢çš„ç›®å½•è·¯å¾„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @filename: è¦æŸ¥æ‰¾çš„æ–‡ä»¶åã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * è¯¥å‡½æ•°é€šè¿‡é€’å½’éå†ç›®å½•æ ‘ï¼Œæ‰“å°å‡ºä¸æŒ‡å®šæ–‡ä»¶ååŒ¹é…çš„æ–‡ä»¶çš„è·¯å¾„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å®ƒä¼šå¿½ç•¥ç‰¹æ®Šç›®å½•é¡¹ `.` å’Œ `..` ä»¥é¿å…é€’å½’å›åˆ°å½“å‰æˆ–çˆ¶ç›®å½•ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">find</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>filename) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">512</span>], <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> fd;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> dirent de;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> stat st;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ‰“å¼€æŒ‡å®šçš„ç›®å½•è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(path, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;find: cannot open %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è·å–æ–‡ä»¶çŠ¶æ€ï¼ˆä¾‹å¦‚ç¡®å®šæ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fstat</span>(fd, <span style="color:#f92672">&amp;</span>st) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;find: cannot stat %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œå¤„ç†ä¸åŒçš„æƒ…å†µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">switch</span> (st.type) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> T_FILE:  <span style="color:#75715e">// å¦‚æœæ˜¯æ™®é€šæ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦ä¸ç›®æ ‡æ–‡ä»¶ååŒ¹é…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(path <span style="color:#f92672">+</span> <span style="color:#a6e22e">strlen</span>(path) <span style="color:#f92672">-</span> <span style="color:#a6e22e">strlen</span>(filename), filename) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¦‚æœåŒ¹é…ï¼Œæ‰“å°æ–‡ä»¶è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);  <span style="color:#75715e">// æ³¨æ„è¿™é‡Œæ¯ä¸ªåŒ¹é…çš„æ–‡ä»¶éƒ½åº”è¯¥åœ¨æ–°è¡Œæ‰“å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> T_DIR:  <span style="color:#75715e">// å¦‚æœæ˜¯ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ£€æŸ¥è·¯å¾„é•¿åº¦æ˜¯å¦è¶…å‡ºç¼“å†²åŒºå¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strlen</span>(path) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> DIRSIZ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">sizeof</span>(buf)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;find: path too long</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°†å½“å‰è·¯å¾„å¤åˆ¶åˆ°ç¼“å†²åŒºä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">strcpy</span>(buf, path);
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> buf <span style="color:#f92672">+</span> <span style="color:#a6e22e">strlen</span>(buf);
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>p<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è¯»å–ç›®å½•ä¸­çš„æ¯ä¸ªç›®å½•é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">read</span>(fd, <span style="color:#f92672">&amp;</span>de, <span style="color:#66d9ef">sizeof</span>(de)) <span style="color:#f92672">==</span> <span style="color:#66d9ef">sizeof</span>(de)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (de.inum <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;  <span style="color:#75715e">// è·³è¿‡æ— æ•ˆçš„ç›®å½•é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// å°†ç›®å½•é¡¹åç§°å¤åˆ¶åˆ°è·¯å¾„ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">memmove</span>(p, de.name, DIRSIZ);
</span></span><span style="display:flex;"><span>            p[DIRSIZ] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¿½ç•¥ç‰¹æ®Šç›®å½•é¡¹ `.` å’Œ `..`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(de.name, <span style="color:#e6db74">&#34;.&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">strcmp</span>(de.name, <span style="color:#e6db74">&#34;..&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// é€’å½’è°ƒç”¨ find å‡½æ•°å¤„ç†å­ç›®å½•æˆ–æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">find</span>(buf, filename);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å…³é—­æ–‡ä»¶æè¿°ç¬¦ä»¥é‡Šæ”¾èµ„æº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * main - ç¨‹åºçš„å…¥å£ç‚¹ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°å¹¶è°ƒç”¨ find å‡½æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @argc: å‚æ•°ä¸ªæ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @argv: å‚æ•°å€¼æ•°ç»„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * è¯¥å‡½æ•°éªŒè¯å‚æ•°çš„æ­£ç¡®æ€§ï¼Œå¹¶è°ƒç”¨ find å‡½æ•°å¼€å§‹é€’å½’æŸ¥æ‰¾ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦æ­£ç¡®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¦‚æœå‚æ•°ä¸è¶³ï¼Œæ‰“å°ä½¿ç”¨è¯´æ˜å¹¶é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;Usage: find &lt;directory&gt; &lt;filename&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è°ƒç”¨ find å‡½æ•°ï¼Œå¼€å§‹æŸ¥æ‰¾æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">find</span>(argv[<span style="color:#ae81ff">1</span>], argv[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="xargs-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml">xargs (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">moderate</a>)<a hidden class="anchor" aria-hidden="true" href="#xargs-moderatehttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/types.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;kernel/stat.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;user/user.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAXARG 32   </span><span style="color:#75715e">// æœ€å¤§å‚æ•°æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define MAXBUF 1024 </span><span style="color:#75715e">// æœ€å¤§è¾“å…¥ç¼“å†²åŒºå¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä»æ ‡å‡†è¾“å…¥è¯»å–ä¸€è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_line</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">int</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// å½“å‰å­—ç¬¦ç´¢å¼•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> c;    <span style="color:#75715e">// å­˜å‚¨è¯»å–çš„å­—ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä»æ ‡å‡†è¾“å…¥é€å­—ç¬¦è¯»å–ï¼Œç›´åˆ°é‡åˆ°æ¢è¡Œç¬¦æˆ–ç¼“å†²åŒºå·²æ»¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (i <span style="color:#f92672">&lt;</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>c, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> i; <span style="color:#75715e">// åˆ°è¾¾è¾“å…¥ç»“æŸæˆ–å‘ç”Ÿé”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (c <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>; <span style="color:#75715e">// é‡åˆ°æ¢è¡Œç¬¦ï¼Œåœæ­¢è¯»å–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        buf[i<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> c; <span style="color:#75715e">// å°†è¯»å–çš„å­—ç¬¦å­˜å…¥ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    buf[i] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>; <span style="color:#75715e">// åœ¨å­—ç¬¦ä¸²æœ«å°¾æ·»åŠ  null ç»ˆæ­¢ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> i;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;Usage: xargs command [initial-args]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>); <span style="color:#75715e">// å¦‚æœæ²¡æœ‰æä¾›å‘½ä»¤å‚æ•°ï¼Œè¾“å‡ºç”¨æ³•æç¤º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);                                             <span style="color:#75715e">// é€€å‡ºç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[MAXBUF]; <span style="color:#75715e">// ç”¨äºå­˜å‚¨è¾“å…¥è¡Œçš„ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä»æ ‡å‡†è¾“å…¥è¯»å–æ¯ä¸€è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">read_line</span>(buf, <span style="color:#66d9ef">sizeof</span>(buf)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºå‘½ä»¤è¡Œå‚æ•°æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cmd_argv[MAXARG <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>]; <span style="color:#75715e">// +2: ä¸€ä¸ªå­˜æ”¾å‘½ä»¤åï¼Œä¸€ä¸ªå­˜æ”¾æ‹¼æ¥åçš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        cmd_argv[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];      <span style="color:#75715e">// å‘½ä»¤åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¤åˆ¶ç”¨æˆ·æä¾›çš„åˆå§‹å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;</span> argc <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;</span> MAXARG; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            cmd_argv[i] <span style="color:#f92672">=</span> argv[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°†è¯»å–çš„è¡Œä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        cmd_argv[i<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> buf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cmd_argv[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// å‚æ•°åˆ—è¡¨ä»¥ null ç»ˆæ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>(); <span style="color:#75715e">// åˆ›å»ºå­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;xargs: fork failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>); <span style="color:#75715e">// å¦‚æœåˆ›å»ºå­è¿›ç¨‹å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);                            <span style="color:#75715e">// é€€å‡ºç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">exec</span>(cmd_argv[<span style="color:#ae81ff">0</span>], cmd_argv);        <span style="color:#75715e">// æ‰§è¡Œå‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">fprintf</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;xargs: exec failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>); <span style="color:#75715e">// å¦‚æœæ‰§è¡Œå‘½ä»¤å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);                            <span style="color:#75715e">// é€€å‡ºå­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// çˆ¶è¿›ç¨‹ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">wait</span>(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// ç­‰å¾…å­è¿›ç¨‹å®Œæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// æ­£å¸¸é€€å‡ºç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kennems.github.io/tags/mit6.s081/">MIT6.S081</a></li>
    </ul>
        
    
    <ul id="categories">
      
        <li><a href="https://kennems.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">æ“ä½œç³»ç»Ÿ</a> </li>
      
    </ul>
    
    
<nav class="paginav">
  <a class="prev" href="https://kennems.github.io/posts/read/%E8%82%A1%E7%A5%A8/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>è‚¡ç¥¨</span>
  </a>
  <a class="next" href="https://kennems.github.io/posts/tech/mit6.s0813-os-organization/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>MIT6.S081(3)-OS organization</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://kennems.github.io/">Kennem&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
<footer class="footer">
    <script async src="https://busuanzi.sukap.cn/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        Visitors: <span id="busuanzi_value_page_uv"></span>
        Views: <span id="busuanzi_value_page_pv"></span>

        
    </span>
</footer>



</body>

</html>
