<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">

<meta name="msvalidate.01" content="DF5FE493CC759E62BFE073BEA8EFD472" />
<title>MIT6.S081(4)-Virtual Memory | Kennem&#39;s Blog</title>
<meta name="keywords" content="MIT6.S081">
<meta name="description" content="MIT6.S081(4)">
<meta name="author" content="ShowGuan">
<link rel="canonical" href="https://kennems.github.io/posts/tech/mit6.s0814-virtual-memory/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.915c20762c304dbee6179b74c308e69b9b1fbc661fecb4d1d1007529d55ca598.css" integrity="sha256-kVwgdiwwTb7mF5t0wwjmm5sfvGYf7LTR0QB1KdVcpZg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kennems.github.io/img/sun.png">
<link rel="apple-touch-icon" href="https://kennems.github.io/img/sun.png">
<link rel="mask-icon" href="https://kennems.github.io/img/sun.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://kennems.github.io/posts/tech/mit6.s0814-virtual-memory/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>


<link rel="stylesheet" href="https://fonts.cdnfonts.com/css/code-new-roman">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

<meta property="og:url" content="https://kennems.github.io/posts/tech/mit6.s0814-virtual-memory/">
  <meta property="og:site_name" content="Kennem&#39;s Blog">
  <meta property="og:title" content="MIT6.S081(4)-Virtual Memory">
  <meta property="og:description" content="MIT6.S081(4)">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-02T22:30:13+08:00">
    <meta property="article:modified_time" content="2024-09-02T22:20:13+08:00">
    <meta property="article:tag" content="MIT6.S081">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT6.S081(4)-Virtual Memory">
<meta name="twitter:description" content="MIT6.S081(4)">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "üìöÊñáÁ´†",
      "item": "https://kennems.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "üíªÊäÄÊúØ",
      "item": "https://kennems.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MIT6.S081(4)-Virtual Memory",
      "item": "https://kennems.github.io/posts/tech/mit6.s0814-virtual-memory/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MIT6.S081(4)-Virtual Memory",
  "name": "MIT6.S081(4)-Virtual Memory",
  "description": "MIT6.S081(4)",
  "keywords": [
    "MIT6.S081"
  ],
  "articleBody": "MIT6.S081(4)-Virtual Memory Plan: Address spaces\nPaging hardware\nxv6 VM code\nVirtual memory overview Today‚Äôs problem: [user/kernel diagram] [memory view: diagram with user processes and kernel in memory]\nSuppose the shell has a bug:\nsometimes it writes to a random memory address how can we keep it from wrecking the kernel? and from wrecking other processes?\nwe want isolated address spaces each process has its own memory it can read and write its own memory it cannot read or write anything else\nchallenge: How to multiplex several memories over one physical memory?\nwhile maintaining isolation between memories\nxv6 uses RISC-V‚Äôs paging hardware to implement AS(Address Space)‚Äôs ask questions! this material is important topic of next lab (and shows up in several other labs) paging provides a level of indirection for addressing\nCPU -\u003e MMU -\u003e RAM\rVA PA s/w can only ld/st to virtual addresses, not physical kernel tells MMU how to map each virtual address to a physical address MMUÔºàMemory Management UnitÔºâ essentially has a table, indexed by va, yielding pa called a ‚Äúpage table‚Äù one page table per address space MMU can restrict what virtual addresses user code can use By programming the MMU, the kernel has complete control over va-\u003epa mapping Allows for many interesting OS features/tricks\nRISC-V maps 4-KB ‚Äúpages‚Äù and aligned ‚Äì start on 4 KB boundaries $4 KB = 12 bits$ the RISC-V used in xv6 has 64-bit for addresses thus page table index is top 64-12 = 52 bits of VA except that the top 25 of the top 52 are unused no RISC-V has that much memory now can grow in future so, index is 27 bits. MMU translation see Figure 3.1 of book use index bits of VA to find a page table entry (PTE) construct physical address using PPN from PTE + offset of VA What is in PTE? each PTE is 64 bits, but only 54 are used top 44 bits of PTE are top bits of physical address ‚Äúphysical page number‚Äù low 10 bits of PTE flags Present, Writeable, \u0026c note: size virtual addresses != size physical addresses\nWhere is the page table stored? in RAM ‚Äì MMU loads (and stores) PTEs o/s can read/write PTEs read/write memory location corresponding to PTEs\nWould it be reasonable for page table to just be an array of PTEs? how big is it? 2^27 is roughly 134 million 64 bits per entry 134*8 MB for a full page table wasting roughly 1GB per page table one page table per address space one address space per application would waste lots of memory for small programs! you only need mappings for a few hundred pages so the rest of the million entries would be there but not needed\nRISC-V 64 uses a ‚Äúthree-level page table‚Äù to save space see figure 3.2 from book page directory page (PD) PD has 512 PTEs PTEs point to another PD or is a leaf so 512512512 PTEs in total PD entries can be invalid those PTE pages need not exist so a page table for a small address space can be small\nhow does the mmu know where the page table is located in RAM? satp holds phys address of top PD pages can be anywhere in RAM ‚Äì need not be contiguous rewrite satp when switching to another address space/application\nhow does RISC-V paging hardware translate a va? need to find the right PTE satp register points to PA of top/L2 PD top 9 bits index L2 PD to get PA of L1 PD next 9 bits index L1 PD to get PA of L0 PD next 9 bits index L0 PD to get PA of PTE PPN from PTE + low-12 from VA\nflags in PTE V, R, W, X, U xv6 uses all of them\nwhat if V bit not set? or store and W bit not set? ‚Äúpage fault‚Äù forces transfer to kernel trap.c in xv6 source kernel can just produce error, kill process in xv6: ‚Äúusertrap(): unexpected scause ‚Ä¶ pid=‚Ä¶ sepc=‚Ä¶ stval=‚Ä¶‚Äù or kernel can install a PTE, resume the process e.g. after loading the page of memory from disk\nindirection allows paging h/w to solve many problems e.g. phys memory doesn‚Äôt have to be contiguous avoids fragmentation e.g. lazy allocation (a lab) e.g. copy-on-write fork (another lab) many more techniques topic of next lecture Q: why use virtual memory in kernel? It is clearly good to have page tables for user processes but why have a page table for the kernel? could the kernel run with using only physical addresses? top-level answer: yes most standard kernels do use virtual addresses why do standard kernels do so? some reasons are lame, some are better, none are fundamental\nthe hardware makes it difficult to turn it off e.g. on entering a system call, one would have to disable VM the kernel itself can benefit from virtual addresses mark text pages X, but data not (helps tracking down bugs) unmap a page below kernel stack (helps tracking down bugs) map a page both in user and kernel (helps user/kernel transition) Virtual memory in xv6 kernel page table See figure 3.3 of book simple maping mostly map virtual to physical one-on-one note double-mapping of trampoline note permissions why map devices? Trampoline ÁöÑ‰ΩúÁî® ‰∏∫ÂÜÖÊ†∏ÂíåÁî®Êà∑ÊÄÅ‰πãÈó¥ÁöÑÂàáÊç¢Êèê‰æõ‰∏Ä‰∏™Áªü‰∏ÄÁöÑÂÖ•Âè£„ÄÇÁî±‰∫éÂÖ∂Âú®ÊØè‰∏™ËøõÁ®ãÁöÑÈ°µË°®ÈÉΩÊò†Â∞ÑÂà∞Áõ∏ÂêåÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÂÜÖÊ†∏ÂíåÁî®Êà∑ËøõÁ®ãÈÉΩËÉΩÂ§üÂú®ÂàáÊç¢ËøáÁ®ã‰∏≠‰ΩøÁî®ËøôÊÆµ‰ª£Á†ÅÔºåÂèØ‰ª•Á°Æ‰øù Ôºö\n‰∏ä‰∏ãÊñáÁöÑ‰øùÂ≠òÂíåÊÅ¢Â§çÔºö‰øùÂ≠òÂΩìÂâçÁöÑCPUÁä∂ÊÄÅÔºàÂØÑÂ≠òÂô®ÔºåÂ†ÜÊ†àÁ≠âÔºâÔºåÂπ∂Âú®ËøîÂõûÁî®Êà∑ÊÄÅÊó∂ÊÅ¢Â§ç„ÄÇ Âú∞ÂùÄÁ©∫Èó¥ÂàáÊç¢ Ôºö Âú®ËøõÁ®ãÂàáÊç¢Êó∂Ôºå‰ªéÁî®Êà∑Âú∞ÂùÄÁ©∫Èó¥ÂàáÊç¢Âà∞ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÔºåÂπ∂Á°Æ‰øùÂÆâÂÖ®„ÄÇ trampolineÊàê‰∏∫Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥ÂÆâÂÖ®‰∏î‰∏ÄËá¥ÁöÑÊ°•Ê¢Å„ÄÇ\nEach process has its own address space and its own page table\nsee figure 3.4 of book\nnote:\ntrampoline and trapframe aren‚Äôt writable by user process\nkernel switches page tables (i.e. sets satp) when switching processes\nQ: why this address space arrangement? user virtual addresses start at zero of course user va 0 maps to different pa for each process $16,777,216 GB$ for user heap to grow contiguously but needn‚Äôt have contiguous phys mem ‚Äì no fragmentation problem both kernel and user map trampoline and trapframe page eases transition user -\u003e kernel and back kernel doesn‚Äôt map user applications not easy for kernel to r/w user memory need translate user virtual address to kernel virtual address good for isolation (see spectre attacks) easy for kernel to r/w physical memory pa x mapped at va x\nQ: does the kernel have to map all of phys mem into its virtual address space? Code walk through setup of kernel address space kvmmap()\n// Âú®ÂÜÖÊ†∏È°µË°®‰∏≠Ê∑ªÂä†‰∏Ä‰∏™Êò†Â∞Ñ„ÄÇ // ‰ªÖÂú®ÂêØÂä®Êó∂‰ΩøÁî®„ÄÇ // ËØ•ÂáΩÊï∞‰∏çÂà∑Êñ∞ TLB ÊàñÂêØÁî®ÂàÜÈ°µ„ÄÇ void kvmmap(uint64 va, uint64 pa, uint64 sz, int perm) { // Ë∞ÉÁî® mappages ÂáΩÊï∞Â∞ÜËôöÊãüÂú∞ÂùÄ va Êò†Â∞ÑÂà∞Áâ©ÁêÜÂú∞ÂùÄ paÔºåÊò†Â∞ÑÂ§ßÂ∞è‰∏∫ szÔºåÊùÉÈôê‰∏∫ perm if(mappages(kernel_pagetable, va, sz, pa, perm) != 0) // Â¶ÇÊûúÊò†Â∞ÑÂ§±Ë¥•ÔºåÂàôËß¶ÂèëÁ≥ªÁªüÈîôËØØ panic(\"kvmmap\"); } Q: what is address 0x10000000 (256M)\n$ 0x10000000 = 256 MB$\nQ: how much address space does 1 L2 entry cover? (1G)\n$512√ó2 MB=1 GB$\nQ: how much address space does 1 L1 entry cover? (2MB)\n$512 √ó 4096B = 2MB$\nQ: how much address space does 1 L0 entry cover? (4096)\nÊØè‰∏™ L0 Êù°ÁõÆÊåáÂêë‰∏Ä‰∏™ 4KB ÁöÑÈ°µÔºåÂõ†Ê≠§ÊØè‰∏™ L0 Êù°ÁõÆË¶ÜÁõñ 4096 Â≠óËäÇÁöÑÂú∞ÂùÄÁ©∫Èó¥\nprint kernel page table\nQ: what is size of address space? (512G)\nÊØè‰∏™L2Ë¶ÜÁõñ $1GB$, ÂÖ±Ë¶ÜÁõñ$512GB$\nQ: how much memory is used to represent it after 1rst kvmmap()?\n($3 pages$)\nQ: how many entries is CLINT?\n($16 pages$)\nQ: how many entries is PLIC?\n(1024 pages, two level 1 PDs)\nQ: how many pages is kernel text\n$ (8 pages)$\nQ: how many pages is kernel total\n$ (128M = 64 * 2MB)$\nQ: Is trampoline mapped twice?\n(yes, last entry and direct-mapped, entry [2, 3, 7])\nkvminithart(); Q: after executing w_satp() why will the next instruction be sfence_vma()?\nmappages() in vm.c // ‰∏∫‰ªé va ÂºÄÂßãÁöÑËôöÊãüÂú∞ÂùÄÂàõÂª∫ PTEÔºàÈ°µË°®Êù°ÁõÆÔºâÔºå // Ëøô‰∫õÊù°ÁõÆÂºïÁî®‰ªé pa ÂºÄÂßãÁöÑÁâ©ÁêÜÂú∞ÂùÄ„ÄÇ // va Âíå size ÂèØËÉΩ‰∏çÊòØÈ°µÈù¢ÂØπÈΩêÁöÑ„ÄÇ // ÊàêÂäüËøîÂõû 0ÔºåÂ§±Ë¥•Êó∂ËøîÂõû -1ÔºàÂ¶ÇÊûú walk() Êó†Ê≥ïÂàÜÈÖçÊâÄÈúÄÁöÑÈ°µË°®È°µÈù¢Ôºâ„ÄÇ int mappages(pagetable_t pagetable, uint64 va, uint64 size, uint64 pa, int perm) { uint64 a, last; // ÂÆö‰πâÂèòÈáè a Âíå lastÔºåÁî®‰∫éË∑üË∏™ÂΩìÂâçÂú∞ÂùÄ pte_t *pte; // ÂÆö‰πâÊåáÈíà pteÔºåÁî®‰∫éËÆøÈóÆÈ°µË°®Êù°ÁõÆ // Â∞ÜËôöÊãüÂú∞ÂùÄ va Âêë‰∏ãÂØπÈΩêÂà∞È°µÈù¢ËæπÁïå a = PGROUNDDOWN(va); // Â∞ÜÊúÄÂêé‰∏Ä‰∏™ËôöÊãüÂú∞ÂùÄÂêë‰∏ãÂØπÈΩêÂà∞È°µÈù¢ËæπÁïå last = PGROUNDDOWN(va + size - 1); // Âæ™ÁéØÂàõÂª∫È°µË°®Êù°ÁõÆ for(;;){ // Ëé∑ÂèñÂΩìÂâçËôöÊãüÂú∞ÂùÄ a ÂØπÂ∫îÁöÑÈ°µË°®Êù°ÁõÆ if((pte = walk(pagetable, a, 1)) == 0) return -1; // Â¶ÇÊûú walk Â§±Ë¥•ÔºåËøîÂõû -1 // Ê£ÄÊü•ÂΩìÂâçÈ°µË°®Êù°ÁõÆÊòØÂê¶Â∑≤ÁªèÊúâÊïà if(*pte \u0026 PTE_V) panic(\"remap\"); // Â¶ÇÊûúÂ∑≤ÁªèÊò†Â∞ÑÔºåËß¶ÂèëÈîôËØØ // ËÆæÁΩÆÈ°µË°®Êù°ÁõÆÔºåÊò†Â∞ÑÁâ©ÁêÜÂú∞ÂùÄ paÔºåÂπ∂ËÆæÁΩÆÊùÉÈôêÂíåÊúâÊïà‰Ωç *pte = PA2PTE(pa) | perm | PTE_V; // Â¶ÇÊûúÂΩìÂâçÂú∞ÂùÄ a ÊòØÊúÄÂêé‰∏Ä‰∏™Âú∞ÂùÄÔºåÈÄÄÂá∫Âæ™ÁéØ if(a == last) break; // ÁªßÁª≠Âà∞‰∏ã‰∏Ä‰∏™È°µÈù¢ a += PGSIZE; // ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™ËôöÊãüÂú∞ÂùÄ pa += PGSIZE; // ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™Áâ©ÁêÜÂú∞ÂùÄ } return 0; // ÊàêÂäüÂàõÂª∫ÊâÄÊúâÈ°µË°®Êù°ÁõÆÔºåËøîÂõû 0 } arguments are top PD, va, size, pa, perm adds mappings from a range of va‚Äôs to corresponding pa‚Äôs rounds b/c some uses pass in non-page-aligned addresses for each page-aligned address in the range call walkpgdir to find address of PTE need the PTE‚Äôs address (not just content) b/c we want to modify put the desired pa into the PTE mark PTE as valid w/ PTE_P\nwalk() in vm.c pte_t * walk(pagetable_t pagetable, uint64 va, int alloc) { // Ê£ÄÊü•ËôöÊãüÂú∞ÂùÄÊòØÂê¶Ë∂ÖËøáÊúÄÂ§ßËôöÊãüÂú∞ÂùÄ if(va \u003e= MAXVA) panic(\"walk\"); // ‰ªéÊúÄÈ´òÁ∫ßÂà´ÁöÑÈ°µË°®ÂºÄÂßãÔºåÈÄêÁ∫ßÂêë‰∏ãÊü•Êâæ for(int level = 2; level \u003e 0; level--) { // Ëé∑ÂèñÂΩìÂâçÁ∫ßÂà´ÁöÑÈ°µË°®Êù°ÁõÆÊåáÈíà pte_t *pte = \u0026pagetable[PX(level, va)]; // Â¶ÇÊûúÈ°µË°®Êù°ÁõÆÊúâÊïà if(*pte \u0026 PTE_V) { // Ëé∑ÂèñÁâ©ÁêÜÂú∞ÂùÄÂπ∂ËøõÂÖ•‰∏ã‰∏ÄÂ±ÇÈ°µË°® pagetable = (pagetable_t)PTE2PA(*pte); } else { // Â¶ÇÊûú‰∏çÂàÜÈÖçÔºåÊàñËÄÖÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû0 if(!alloc || (pagetable = (pde_t*)kalloc()) == 0) return 0; // ÂàùÂßãÂåñÊñ∞ÁöÑÈ°µË°®‰∏∫0 memset(pagetable, 0, PGSIZE); // ËÆæÁΩÆÈ°µË°®Êù°ÁõÆ‰∏∫Êñ∞ÂàÜÈÖçÁöÑÈ°µË°®ÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÊ†áËÆ∞‰∏∫ÊúâÊïà *pte = PA2PTE(pagetable) | PTE_V; } } // ËøîÂõûÊúÄ‰ΩéÁ∫ßÂà´È°µË°®‰∏≠ÂØπÂ∫îËôöÊãüÂú∞ÂùÄÁöÑÈ°µË°®Êù°ÁõÆ return \u0026pagetable[PX(0, va)]; } mimics how the paging h/w finds the PTE for an address PX extracts the 9 bits at Level level \u0026pagetable[PX(level, va)] is the address of the relevant PTE\nif PTE_V\rthe relevant page-table page already exists\rPTE2PA extracts the PPN from the PDE\rif not PTE_V\ralloc a page-table page\rfill in pte with PPN (using PA2PTE) now the PTE we want is in the page-table page\nprocinit() in proc.c // Âú®ÂêØÂä®Êó∂ÂàùÂßãÂåñËøõÁ®ãË°®„ÄÇ void procinit(void) { struct proc *p; // ÂàùÂßãÂåñËøõÁ®ã ID ÈîÅÔºå‰ª•Á°Æ‰øùÂØπËøõÁ®ã ID ÁöÑÂÆâÂÖ®ËÆøÈóÆ„ÄÇ initlock(\u0026pid_lock, \"nextpid\"); // ÈÅçÂéÜËøõÁ®ãË°®‰∏≠ÁöÑÊØè‰∏™ËøõÁ®ã for(p = proc; p \u003c \u0026proc[NPROC]; p++) { // ÂàùÂßãÂåñÊØè‰∏™ËøõÁ®ãÁöÑÈîÅÔºå‰ª•‰øùÊä§ËøõÁ®ãÁªìÊûÑÁöÑÂπ∂ÂèëËÆøÈóÆ„ÄÇ initlock(\u0026p-\u003elock, \"proc\"); // ‰∏∫ËøõÁ®ãÁöÑÂÜÖÊ†∏Ê†àÂàÜÈÖç‰∏ÄÈ°µÂÜÖÂ≠ò„ÄÇ // Â∞ÜÂÖ∂Êò†Â∞ÑÂà∞È´òÂú∞ÂùÄÂÜÖÂ≠òÔºåÂπ∂Ë∑üÈöè‰∏Ä‰∏™Êó†ÊïàÁöÑ‰øùÊä§È°µ„ÄÇ char *pa = kalloc(); // ÂàÜÈÖç‰∏ÄÈ°µÂÜÖÂ≠ò if(pa == 0) panic(\"kalloc\"); // Â¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåËß¶ÂèëÁ≥ªÁªüÈîôËØØ // ËÆ°ÁÆóËØ•ËøõÁ®ãÂÜÖÊ†∏Ê†àÁöÑËôöÊãüÂú∞ÂùÄ uint64 va = KSTACK((int) (p - proc)); // Âú®ÂÜÖÊ†∏È°µË°®‰∏≠Êò†Â∞ÑËôöÊãüÂú∞ÂùÄ va Âà∞Áâ©ÁêÜÂú∞ÂùÄ paÔºåÂ§ßÂ∞è‰∏∫ PGSIZEÔºåÊùÉÈôê‰∏∫ÂèØËØªÂíåÂèØÂÜô kvmmap(va, (uint64)pa, PGSIZE, PTE_R | PTE_W); // Â∞ÜËÆ°ÁÆóÂá∫ÁöÑËôöÊãüÂú∞ÂùÄ‰øùÂ≠òÂà∞ËøõÁ®ãÁªìÊûÑ‰∏≠ p-\u003ekstack = va; } // ÂàùÂßãÂåñËôöÊãüÂÜÖÂ≠òÁÆ°ÁêÜÁõ∏ÂÖ≥ÁöÑÁ°¨‰ª∂ËÆæÁΩÆ kvminithart(); } alloc a page for each kernel stack with a guard page\nsetup user address space allocproc(): allocates empty top-level page table // Âú®ËøõÁ®ãË°®‰∏≠Êü•Êâæ‰∏Ä‰∏™ UNUSED Áä∂ÊÄÅÁöÑËøõÁ®ã„ÄÇ // Â¶ÇÊûúÊâæÂà∞ÔºåÂàùÂßãÂåñÊâÄÈúÄÁöÑÁä∂ÊÄÅ‰ª•Âú®ÂÜÖÊ†∏‰∏≠ËøêË°åÔºåÂπ∂ËøîÂõûÊó∂ÊåÅÊúâ p-\u003elock„ÄÇ // Â¶ÇÊûúÊ≤°ÊúâÁ©∫Èó≤ÁöÑËøõÁ®ãÔºåÊàñÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû 0„ÄÇ static struct proc* allocproc(void) { struct proc *p; // ÈÅçÂéÜËøõÁ®ãË°®‰∏≠ÁöÑÊØè‰∏™ËøõÁ®ã for(p = proc; p \u003c \u0026proc[NPROC]; p++) { acquire(\u0026p-\u003elock); // Ëé∑ÂèñËøõÁ®ãÁöÑÈîÅ‰ª•ÂÆâÂÖ®ËÆøÈóÆÂÖ∂Áä∂ÊÄÅ if(p-\u003estate == UNUSED) { // Ê£ÄÊü•ËøõÁ®ãÁä∂ÊÄÅÊòØÂê¶‰∏∫ UNUSED goto found; // ÊâæÂà∞Á©∫Èó≤ËøõÁ®ãÔºåË∑≥ËΩ¨Âà∞ÂàùÂßãÂåñÈÉ®ÂàÜ } else { release(\u0026p-\u003elock); // Â¶ÇÊûú‰∏çÊòØ UNUSEDÔºåÈáäÊîæÈîÅÂπ∂ÁªßÁª≠‰∏ã‰∏Ä‰∏™ËøõÁ®ã } } // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Á©∫Èó≤ËøõÁ®ãÔºåËøîÂõû 0 return 0; found: // ÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑËøõÁ®ã ID p-\u003epid = allocpid(); // ‰∏∫ËøõÁ®ãÂàÜÈÖç‰∏Ä‰∏™ trapframe È°µÈù¢ÔºåÁî®‰∫éÂ§ÑÁêÜÁ≥ªÁªüË∞ÉÁî®Âíå‰∏≠Êñ≠ if((p-\u003etrapframe = (struct trapframe *)kalloc()) == 0) { release(\u0026p-\u003elock); // ÂàÜÈÖçÂ§±Ë¥•ÔºåÈáäÊîæÈîÅ return 0; // ËøîÂõû 0 Ë°®Á§∫Â§±Ë¥• } // ÂàõÂª∫‰∏Ä‰∏™Á©∫ÁöÑÁî®Êà∑È°µÈù¢Ë°® p-\u003epagetable = proc_pagetable(p); if(p-\u003epagetable == 0) { // Ê£ÄÊü•È°µÈù¢Ë°®ÂàÜÈÖçÊòØÂê¶ÊàêÂäü freeproc(p); // Â¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåÈáäÊîæËøõÁ®ãËµÑÊ∫ê release(\u0026p-\u003elock); // ÈáäÊîæÈîÅ return 0; // ËøîÂõû 0 Ë°®Á§∫Â§±Ë¥• } // ËÆæÁΩÆÊñ∞ÁöÑ‰∏ä‰∏ãÊñáÔºå‰ª•Âú® forkret Â§ÑÂºÄÂßãÊâßË°åÔºå // forkret ‰ºöËøîÂõûÂà∞Áî®Êà∑Á©∫Èó¥„ÄÇ memset(\u0026p-\u003econtext, 0, sizeof(p-\u003econtext)); // Ê∏ÖÈõ∂‰∏ä‰∏ãÊñáÁªìÊûÑ p-\u003econtext.ra = (uint64)forkret; // ËÆæÁΩÆËøîÂõûÂú∞ÂùÄ‰∏∫ forkret ÂáΩÊï∞ p-\u003econtext.sp = p-\u003ekstack + PGSIZE; // ËÆæÁΩÆÂ†ÜÊ†àÊåáÈíàÂà∞ÂÜÖÊ†∏Ê†àÁöÑÈ°∂ÈÉ® return p; // ËøîÂõûÂàÜÈÖçÂíåÂàùÂßãÂåñÁöÑËøõÁ®ã } fork(): uvmcopy()\n// Ê†πÊçÆÁà∂ËøõÁ®ãÁöÑÈ°µË°®ÔºåÂ∞ÜÂÖ∂ÂÜÖÂ≠òÂ§çÂà∂Âà∞Â≠êËøõÁ®ãÁöÑÈ°µË°®„ÄÇ // Â§çÂà∂È°µË°®ÂíåÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇ // ÊàêÂäüËøîÂõû 0ÔºåÂ§±Ë¥•ËøîÂõû -1„ÄÇ // Âú®Â§±Ë¥•Êó∂ÈáäÊîæÂ∑≤ÂàÜÈÖçÁöÑÈ°µÈù¢„ÄÇ int uvmcopy(pagetable_t old, pagetable_t new, uint64 sz) { pte_t *pte; // È°µË°®Êù°ÁõÆÁöÑÊåáÈíà uint64 pa, i; // Áâ©ÁêÜÂú∞ÂùÄÂíåÂæ™ÁéØÂèòÈáè uint flags; // È°µË°®Êù°ÁõÆÁöÑÊ†áÂøó‰Ωç // ÈÅçÂéÜ‰ªé 0 Âà∞ sz ÁöÑÊâÄÊúâÈ°µÈù¢ for(i = 0; i \u003c sz; i += PGSIZE){ // Ëé∑ÂèñÊóßÈ°µË°®‰∏≠ÂØπÂ∫îËôöÊãüÂú∞ÂùÄÁöÑÈ°µË°®Êù°ÁõÆ if((pte = walk(old, i, 0)) == 0) panic(\"uvmcopy: pte should exist\"); // Â¶ÇÊûúÊú™ÊâæÂà∞È°µË°®Êù°ÁõÆÔºåËß¶ÂèëÈîôËØØ // Ê£ÄÊü•È°µË°®Êù°ÁõÆÊòØÂê¶ÊúâÊïà if((*pte \u0026 PTE_V) == 0) panic(\"uvmcopy: page not present\"); // Â¶ÇÊûúÈ°µÈù¢‰∏çÂ≠òÂú®ÔºåËß¶ÂèëÈîôËØØ // Ëé∑ÂèñÁâ©ÁêÜÂú∞ÂùÄ pa = PTE2PA(*pte); // Ê∏ÖÈô§ÂÜôÊùÉÈôêÊ†áÂøóÔºå‰ª•‰æøËøõË°åÂÜôÊó∂Â§çÂà∂ÔºàCopy-On-WriteÔºâ *pte \u0026= (~PTE_W); // Ê∏ÖÈô§ PTE_W *pte |= (PTE_C); // ËÆæÁΩÆ PTE_CÔºåÊ†áËÆ∞Ê≠§È°µÈù¢‰∏∫ Copy-On-Write // Ëé∑ÂèñÂΩìÂâçÈ°µË°®Êù°ÁõÆÁöÑÂÖ∂‰ªñÊ†áÂøó flags = PTE_FLAGS(*pte); // Âú®Êñ∞È°µË°®‰∏≠Êò†Â∞ÑÂéüÊù•ÁöÑÁâ©ÁêÜÂú∞ÂùÄ if (mappages(new, i, PGSIZE, pa, flags) != 0) { goto err; // Â¶ÇÊûúÊò†Â∞ÑÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ } // Â¢ûÂä†Áâ©ÁêÜÈ°µÈù¢ÁöÑÂºïÁî®ËÆ°Êï∞ kincre((void *)pa); } return 0; // ÊàêÂäüÂÆåÊàêÂ§çÂà∂ÔºåËøîÂõû 0 err: // ÈáäÊîæÂú®Êñ∞È°µË°®‰∏≠Â∑≤ÂàÜÈÖçÁöÑÈ°µÈù¢ uvmunmap(new, 0, i / PGSIZE, 1); return -1; // ËøîÂõû -1 Ë°®Á§∫Â§±Ë¥• } exec(): replace proc‚Äôs page table with a new one\n// ÊâßË°åÊåáÂÆöË∑ØÂæÑÁöÑÁ®ãÂ∫èÔºåËÆæÁΩÆÊñ∞ÁöÑÁî®Êà∑Ê†àÂπ∂ÂáÜÂ§áÂèÇÊï∞„ÄÇ // ÊàêÂäüËøîÂõûÁ®ãÂ∫èÁöÑÂèÇÊï∞‰∏™Êï∞ÔºåÂ§±Ë¥•ËøîÂõû -1„ÄÇ int exec(char *path, char **argv) { char *s, *last; // Â≠óÁ¨¶‰∏≤ÊåáÈíàÔºåÁî®‰∫éÂ§ÑÁêÜË∑ØÂæÑ int i, off; // Âæ™ÁéØÂèòÈáèÂíåÂÅèÁßªÈáè uint64 argc, sz = 0, sp, ustack[MAXARG+1], stackbase; // ÂèÇÊï∞ËÆ°Êï∞„ÄÅÂÜÖÂ≠òÂ§ßÂ∞è„ÄÅÊ†àÊåáÈíà„ÄÅÁî®Êà∑Ê†àÊï∞ÁªÑÂíåÊ†àÂü∫Âú∞ÂùÄ struct elfhdr elf; // ELF Â§¥ÁªìÊûÑ struct inode *ip; // Êñá‰ª∂ËäÇÁÇπÊåáÈíà struct proghdr ph; // Á®ãÂ∫èÂ§¥ÁªìÊûÑ pagetable_t pagetable = 0, oldpagetable; // Êñ∞ÊóßÈ°µË°® struct proc *p = myproc(); // Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁªìÊûÑ begin_op(); // ÂºÄÂßãÊñá‰ª∂Êìç‰Ωú // Êü•ÊâæÁ®ãÂ∫èË∑ØÂæÑÂØπÂ∫îÁöÑ inode if((ip = namei(path)) == 0){ end_op(); // ÁªìÊùüÊñá‰ª∂Êìç‰Ωú return -1; // Êâæ‰∏çÂà∞Êñá‰ª∂ÔºåËøîÂõû -1 } ilock(ip); // ÈîÅÂÆö inode // Ê£ÄÊü• ELF Â§¥ if(readi(ip, 0, (uint64)\u0026elf, 0, sizeof(elf)) != sizeof(elf)) goto bad; // ËØªÂèñ ELF Â§¥Â§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ if(elf.magic != ELF_MAGIC) goto bad; // Ê£ÄÊü• ELF È≠îÊ≥ïÊï∞ÔºåËã•‰∏çÂåπÈÖçÂàôË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ // Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁöÑÈ°µË°® if((pagetable = proc_pagetable(p)) == 0) goto bad; // Ëé∑ÂèñÈ°µË°®Â§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ // ‰ªé ELF Êñá‰ª∂Âä†ËΩΩÁ®ãÂ∫èÂà∞ÂÜÖÂ≠ò for(i = 0, off = elf.phoff; i \u003c elf.phnum; i++, off += sizeof(ph)){ // ËØªÂèñÁ®ãÂ∫èÂ§¥ if(readi(ip, 0, (uint64)\u0026ph, off, sizeof(ph)) != sizeof(ph)) goto bad; // ËØªÂèñÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ if(ph.type != ELF_PROG_LOAD) continue; // ‰ªÖÂ§ÑÁêÜÂä†ËΩΩÁ±ªÂûãÁöÑÁ®ãÂ∫èÂ§¥ if(ph.memsz \u003c ph.filesz) goto bad; // ÂÜÖÂ≠òÂ§ßÂ∞èÂ∞è‰∫éÊñá‰ª∂Â§ßÂ∞èÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ if(ph.vaddr + ph.memsz \u003c ph.vaddr) goto bad; // Âú∞ÂùÄÊ∫¢Âá∫ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ uint64 sz1; // ‰∏∫Âä†ËΩΩÁöÑÊÆµÂàÜÈÖçÂÜÖÂ≠ò if((sz1 = uvmalloc(pagetable, sz, ph.vaddr + ph.memsz)) == 0) goto bad; // ÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ sz = sz1; // Êõ¥Êñ∞ÂàÜÈÖçÂ§ßÂ∞è // Ê£ÄÊü•ÊÆµÁöÑËôöÊãüÂú∞ÂùÄÊòØÂê¶ÂØπÈΩê if(ph.vaddr % PGSIZE != 0) goto bad; // ËôöÊãüÂú∞ÂùÄÊú™ÂØπÈΩêÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ // ‰ªéÊñá‰ª∂‰∏≠Âä†ËΩΩÊÆµÂà∞ÂÜÖÂ≠ò if(loadseg(pagetable, ph.vaddr, ip, ph.off, ph.filesz) \u003c 0) goto bad; // Âä†ËΩΩÊÆµÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ } iunlockput(ip); // Ëß£ÈîÅÂπ∂ÈáäÊîæ inode end_op(); // ÁªìÊùüÊñá‰ª∂Êìç‰Ωú ip = 0; // Ê∏ÖÁ©∫ inode ÊåáÈíà p = myproc(); // ÂÜçÊ¨°Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁªìÊûÑ uint64 oldsz = p-\u003esz; // ‰øùÂ≠òÊóßÁöÑÁ®ãÂ∫èÂ§ßÂ∞è // Âú®‰∏ã‰∏Ä‰∏™È°µËæπÁïåÂàÜÈÖç‰∏§‰∏™È°µÈù¢ // ‰ΩøÁî®Á¨¨‰∫å‰∏™È°µÈù¢‰Ωú‰∏∫Áî®Êà∑Ê†à sz = PGROUNDUP(sz); // Â∞ÜÂ§ßÂ∞èÂêë‰∏äÂØπÈΩêÂà∞È°µËæπÁïå uint64 sz1; if((sz1 = uvmalloc(pagetable, sz, sz + 2*PGSIZE)) == 0) goto bad; // ÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ sz = sz1; // Êõ¥Êñ∞ÂàÜÈÖçÂ§ßÂ∞è uvmclear(pagetable, sz - 2 * PGSIZE); // Ê∏ÖÈô§Ê†àÂ∫ïÁöÑÈ°µÈù¢ÂÜÖÂÆπ sp = sz; // ËÆæÁΩÆÊ†àÊåáÈíà stackbase = sp - PGSIZE; // ËÆæÁΩÆÊ†àÂü∫Âú∞ÂùÄ // Â∞ÜÂèÇÊï∞Â≠óÁ¨¶‰∏≤Êé®ÂÖ•Ê†àÔºåÂπ∂ÂáÜÂ§áÊ†àÁöÑÂÖ∂‰ªñÈÉ®ÂàÜ for(argc = 0; argv[argc]; argc++) { if(argc \u003e= MAXARG) goto bad; // Ë∂ÖËøáÊúÄÂ§ßÂèÇÊï∞Êï∞ÈáèÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ sp -= strlen(argv[argc]) + 1; // ‰∏∫ÂèÇÊï∞Â≠óÁ¨¶‰∏≤ÂàÜÈÖçÁ©∫Èó¥ sp -= sp % 16; // Á°Æ‰øùÊ†àÊåáÈíàÊòØ 16 Â≠óËäÇÂØπÈΩê if(sp \u003c stackbase) goto bad; // Ê†àÊåáÈíàË∂ÖÂá∫Ê†àÂü∫ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ if(copyout(pagetable, sp, argv[argc], strlen(argv[argc]) + 1) \u003c 0) goto bad; // Â∞ÜÂèÇÊï∞Â≠óÁ¨¶‰∏≤Â§çÂà∂Âà∞Áî®Êà∑Ê†àÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ ustack[argc] = sp; // ‰øùÂ≠òÂèÇÊï∞Â≠óÁ¨¶‰∏≤ÁöÑÂú∞ÂùÄ } ustack[argc] = 0; // ‰ª• 0 ÁªìÊùüÂèÇÊï∞Êï∞ÁªÑ // Â∞Ü argv[] ÊåáÈíàÊï∞ÁªÑÊé®ÂÖ•Ê†à sp -= (argc + 1) * sizeof(uint64); // ‰∏∫ argv ÊåáÈíàÊï∞ÁªÑÂàÜÈÖçÁ©∫Èó¥ sp -= sp % 16; // Á°Æ‰øùÊ†àÊåáÈíàÊòØ 16 Â≠óËäÇÂØπÈΩê if(sp \u003c stackbase) goto bad; // Ê†àÊåáÈíàË∂ÖÂá∫Ê†àÂü∫ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ if(copyout(pagetable, sp, (char *)ustack, (argc + 1) * sizeof(uint64)) \u003c 0) goto bad; // Â§çÂà∂ argv ÊåáÈíàÊï∞ÁªÑÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ // ÂáÜÂ§áÁî®Êà∑‰∏ªÂáΩÊï∞ÁöÑÂèÇÊï∞ (argc, argv) // argc Â∞ÜÈÄöËøáÁ≥ªÁªüË∞ÉÁî®ËøîÂõûÂÄºÊîæÂÖ• a0 ‰∏≠ p-\u003etrapframe-\u003ea1 = sp; // Â∞ÜÊ†àÊåáÈíàËµãÂÄºÁªô trapframe // ‰øùÂ≠òÁ®ãÂ∫èÂêçÁß∞‰ª•‰æøË∞ÉËØï for(last = s = path; *s; s++) if(*s == '/') last = s + 1; // ÊâæÂà∞Ë∑ØÂæÑ‰∏≠ÁöÑÊúÄÂêé‰∏Ä‰∏™ÊñúÊù† safestrcpy(p-\u003ename, last, sizeof(p-\u003ename)); // Â§çÂà∂Á®ãÂ∫èÂêçÁß∞ // Êèê‰∫§Áî®Êà∑Êò†ÂÉè oldpagetable = p-\u003epagetable; // ‰øùÂ≠òÊóßÁöÑÈ°µË°® p-\u003epagetable = pagetable; // Êõ¥Êñ∞ÂΩìÂâçËøõÁ®ãÁöÑÈ°µË°® p-\u003esz = sz; // Êõ¥Êñ∞ËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è p-\u003etrapframe-\u003eepc = elf.entry; // ËÆæÁΩÆÂàùÂßãÁ®ãÂ∫èËÆ°Êï∞Âô®‰∏∫ ELF ÂÖ•Âè£ÁÇπ p-\u003etrapframe-\u003esp = sp; // ËÆæÁΩÆÂàùÂßãÊ†àÊåáÈíà proc_freepagetable(oldpagetable, oldsz); // ÈáäÊîæÊóßÁöÑÈ°µË°® return argc; // ËøîÂõûÂèÇÊï∞‰∏™Êï∞ÔºåÊîæÂÖ• a0Ôºå‰Ωú‰∏∫ main(argc, argv) ÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞ bad: // ÈîôËØØÂ§ÑÁêÜÈÉ®ÂàÜ if(pagetable) proc_freepagetable(pagetable, sz); // ÈáäÊîæÂ∑≤ÂàÜÈÖçÁöÑÈ°µË°® if(ip){ iunlockput(ip); // Ëß£ÈîÅÂπ∂ÈáäÊîæ inode end_op(); // ÁªìÊùüÊñá‰ª∂Êìç‰Ωú } return -1; // ËøîÂõû -1 Ë°®Á§∫Â§±Ë¥• } uvmalloc()\nloadseg()\n// Â∞ÜÁ®ãÂ∫èÊÆµÂä†ËΩΩÂà∞ÊåáÂÆöÁöÑÈ°µË°®‰∏≠ÔºåËôöÊãüÂú∞ÂùÄ‰∏∫ va„ÄÇ // va ÂøÖÈ°ªÊòØÈ°µÂØπÈΩêÁöÑÔºå‰∏î‰ªé va Âà∞ va+sz ÁöÑÈ°µÂøÖÈ°ªÂ∑≤ÁªèÊò†Â∞Ñ„ÄÇ // ÊàêÂäüÊó∂ËøîÂõû 0ÔºåÂ§±Ë¥•Êó∂ËøîÂõû -1„ÄÇ static int loadseg(pagetable_t pagetable, uint64 va, struct inode *ip, uint offset, uint sz) { uint i, n; // Âæ™ÁéØÂèòÈáè i ÂíåÊØèÈ°µË¶ÅËØªÂèñÁöÑÂ≠óËäÇÊï∞ n uint64 pa; // Êò†Â∞ÑÂà∞ÁöÑÁâ©ÁêÜÂú∞ÂùÄ // Ê£ÄÊü•ËôöÊãüÂú∞ÂùÄÊòØÂê¶ÊòØÈ°µÂØπÈΩêÁöÑ if((va % PGSIZE) != 0) panic(\"loadseg: va must be page aligned\"); // ÈÅçÂéÜÊØè‰∏™È°µÔºå‰ªéËôöÊãüÂú∞ÂùÄ va ÂºÄÂßãÔºåÁõ¥Âà∞Âä†ËΩΩÁöÑÂ§ßÂ∞è sz for(i = 0; i \u003c sz; i += PGSIZE){ // Ëé∑ÂèñÂΩìÂâçËôöÊãüÂú∞ÂùÄÂØπÂ∫îÁöÑÁâ©ÁêÜÂú∞ÂùÄ pa = walkaddr(pagetable, va + i); // Â¶ÇÊûúÁâ©ÁêÜÂú∞ÂùÄ‰∏∫ 0ÔºåË°®Á§∫ÂØπÂ∫îÁöÑÈ°µ‰∏çÂ≠òÂú®ÔºåËß¶Âèë panic if(pa == 0) panic(\"loadseg: address should exist\"); // Á°ÆÂÆöË¶ÅËØªÂèñÁöÑÂ≠óËäÇÊï∞ if(sz - i \u003c PGSIZE) n = sz - i; // Â¶ÇÊûúÂâ©‰ΩôÁöÑÂ≠óËäÇÊï∞Â∞è‰∫é‰∏ÄÈ°µÔºåÂàôÂè™ËØªÂèñÂâ©‰ΩôÁöÑÂ≠óËäÇ else n = PGSIZE; // Âê¶ÂàôËØªÂèñ‰∏ÄÊï¥È°µ // ‰ªé inode ‰∏≠ËØªÂèñÊï∞ÊçÆÂà∞Áâ©ÁêÜÂÜÖÂ≠ò‰∏≠ if(readi(ip, 0, (uint64)pa, offset+i, n) != n) return -1; // Â¶ÇÊûúËØªÂèñÁöÑÂ≠óËäÇÊï∞‰∏çÁ≠â‰∫é nÔºåËøîÂõû -1 Ë°®Á§∫Â§±Ë¥• } return 0; // ÊàêÂäüÂä†ËΩΩÊâÄÊúâÈ°µÔºåËøîÂõû 0 } print user page table for sh\nQ: what is entry 2?\na process calls sbrk(n) to ask for n more bytes of heap memory user/umalloc.c calls sbrk() to get memory for the allocator each process has a size kernel adds new memory at process‚Äôs end, increases size sbrk() allocates physical memory (RAM) maps it into the process‚Äôs page table returns the starting address of the new memory\ngrowproc() in proc.c // Â¢ûÂä†ÊàñÂáèÂ∞ëÁî®Êà∑ÂÜÖÂ≠ò n Â≠óËäÇ„ÄÇ // ÊàêÂäüÊó∂ËøîÂõû 0ÔºåÂ§±Ë¥•Êó∂ËøîÂõû -1„ÄÇ int growproc(int n) { uint sz; // ÂΩìÂâçËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è struct proc *p = myproc(); // Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁªìÊûÑ sz = p-\u003esz; // Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è if(n \u003e 0){ // Â¶ÇÊûú n ‰∏∫Ê≠£ÔºåË°®Á§∫Â¢ûÂä†ÂÜÖÂ≠ò // Â∞ùËØïÂàÜÈÖçÊñ∞ÁöÑÂÜÖÂ≠òÁ©∫Èó¥ if((sz = uvmalloc(p-\u003epagetable, sz, sz + n)) == 0) { // Â¶ÇÊûúÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû -1 return -1; } } else if(n \u003c 0){ // Â¶ÇÊûú n ‰∏∫Ë¥üÔºåË°®Á§∫ÂáèÂ∞ëÂÜÖÂ≠ò // Â∞ùËØïÈáäÊîæÂÜÖÂ≠ò sz = uvmdealloc(p-\u003epagetable, sz, sz + n); // Ê≥®ÊÑèÔºöÊ≠§Â§ÑÊ≤°ÊúâÊ£ÄÊü• uvmdealloc ÁöÑËøîÂõûÂÄºÔºåÂÅáËÆæÂÖ∂ÊàêÂäü } p-\u003esz = sz; // Êõ¥Êñ∞ÂΩìÂâçËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è return 0; // ËøîÂõû 0 Ë°®Á§∫ÊàêÂäü } proc-\u003esz is the process‚Äôs current size uvmalloc() does most of the work when switching to user space satp will be loaded with updated page table\nuvmalloc() in vm.c // ‰∏∫ËøõÁ®ãÂàÜÈÖçÈ°µË°®È°πÂíåÁâ©ÁêÜÂÜÖÂ≠òÔºåÂ∞ÜËøõÁ®ã‰ªé oldsz Êâ©Â±ïÂà∞ newsz„ÄÇ // newsz ‰∏çÈúÄË¶ÅÈ°µÂØπÈΩê„ÄÇÊàêÂäüÊó∂ËøîÂõûÊñ∞Â§ßÂ∞èÔºåÂ§±Ë¥•Êó∂ËøîÂõû 0„ÄÇ uint64 uvmalloc(pagetable_t pagetable, uint64 oldsz, uint64 newsz) { char *mem; // Áî®‰∫éÂ≠òÂÇ®ÂàÜÈÖçÁöÑÂÜÖÂ≠òÊåáÈíà uint64 a; // Âæ™ÁéØÂèòÈáèÔºåÁî®‰∫éÈÅçÂéÜÂàÜÈÖçÁöÑÂÜÖÂ≠òÂú∞ÂùÄ // Â¶ÇÊûúÊñ∞ÁöÑÂ§ßÂ∞èÂ∞è‰∫éÊóßÁöÑÂ§ßÂ∞èÔºåÁõ¥Êé•ËøîÂõûÊóßÁöÑÂ§ßÂ∞è if(newsz \u003c oldsz) return oldsz; // Â∞ÜÊóßÂ§ßÂ∞èÂêë‰∏äÂØπÈΩêÂà∞‰∏ã‰∏Ä‰∏™È°µËæπÁïå oldsz = PGROUNDUP(oldsz); // ‰ªéÊóßÂ§ßÂ∞èÂºÄÂßãÔºåÈÄêÈ°µÂàÜÈÖçÂÜÖÂ≠òÁõ¥Âà∞Êñ∞ÁöÑÂ§ßÂ∞è for(a = oldsz; a \u003c newsz; a += PGSIZE){ // ÂàÜÈÖç‰∏ÄÈ°µÁâ©ÁêÜÂÜÖÂ≠ò mem = kalloc(); if(mem == 0){ // Â¶ÇÊûúÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåÈáäÊîæÂ∑≤ÁªèÂàÜÈÖçÁöÑÂÜÖÂ≠òÂπ∂ËøîÂõû 0 uvmdealloc(pagetable, a, oldsz); return 0; } // Â∞ÜÂàÜÈÖçÁöÑÂÜÖÂ≠òÂàùÂßãÂåñ‰∏∫ 0 memset(mem, 0, PGSIZE); // Â∞ÜÂàÜÈÖçÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊò†Â∞ÑÂà∞ËøõÁ®ãÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ if(mappages(pagetable, a, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != 0){ // Â¶ÇÊûúÊò†Â∞ÑÂ§±Ë¥•ÔºåÈáäÊîæÁâ©ÁêÜÂÜÖÂ≠òÂπ∂ÈáäÊîæÂ∑≤ÂàÜÈÖçÁöÑÂÜÖÂ≠ò kfree(mem); uvmdealloc(pagetable, a, oldsz); return 0; } } // Â¶ÇÊûúÊâÄÊúâÁöÑÂÜÖÂ≠òÈÉΩÊàêÂäüÂàÜÈÖçÂíåÊò†Â∞ÑÔºåËøîÂõûÊñ∞ÁöÑÂ§ßÂ∞è return newsz; } why PGROUNDUP? arguments to mappages()‚Ä¶\nLab: page tables Print a page table (easy) Define a function called vmprint(). It should take a pagetable_t argument, and print that pagetable in the format described below. Insert if(p-\u003epid==1) vmprint(p-\u003epagetable) in exec.c just before the return argc, to print the first process‚Äôs page table. You receive full credit for this assignment if you pass the pte printout test of make grade.\nvoid vmprint_rec(pagetable_t pagetable, int level) { for (int i = 0; i \u003c 512; i++) { pte_t pte = pagetable[i]; if (pte \u0026 PTE_V) { uint64 pa = PTE2PA(pte); for (int j = 0; j \u003c= level; j++) { if(j \u003e 0){ printf(\" \"); } printf(\"..\"); } printf(\"%d: pte %p pa %p\\n\", i, pte, pa); if ((pte \u0026 (PTE_R | PTE_W | PTE_X)) == 0) { // Recursively print next level page table vmprint_rec((pagetable_t)pa, level + 1); } } } } void vmprint(pagetable_t pagetable) { printf(\"page table %p\\n\", pagetable); vmprint_rec(pagetable, 0); } pid = 1‰ª£Ë°®initËøõÁ®ãÔºåÂç≥Á¨¨‰∏Ä‰∏™ÂêØÂä®ÁöÑÁî®Êà∑Á∫ßËøõÁ®ãÔºåÂÆÉË¥üË¥£Ê¥æÁîüÂÖ∂‰ªñËøõÁ®ãÂπ∂‰∏∫Á≥ªÁªüÊèê‰æõÂü∫Êú¨ÊúçÂä°„ÄÇ\nA kernel page table per process (hard) proc.h proc.c vm.c defs.h Simplify copyin/copyinstr (hard) defs.h vm.c Q \u0026 A ",
  "wordCount" : "5742",
  "inLanguage": "zh",
  "datePublished": "2024-09-02T22:30:13+08:00",
  "dateModified": "2024-09-02T22:20:13+08:00",
  "author":{
    "@type": "Person",
    "name": "ShowGuan"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kennems.github.io/posts/tech/mit6.s0814-virtual-memory/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Kennem's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kennems.github.io/img/sun.png"
    }
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>




</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kennems.github.io/" accesskey="h" title="Kennem&#39;s Blog (Alt + H)">
                <img src="https://kennems.github.io/img/sun.png" alt="" aria-label="logo"
                    height="35">Kennem&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://kennems.github.io/" title="üè†‰∏ªÈ°µ">
                    <span>üè†‰∏ªÈ°µ</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/search" title="üîçÊêúÁ¥¢ (Alt &#43; /)" accesskey=/>
                    <span>üîçÊêúÁ¥¢</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/posts" title="üìöÊñáÁ´†">
                    <span>üìöÊñáÁ´†</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/archives" title="‚è±Êó∂Èó¥ËΩ¥">
                    <span>‚è±Êó∂Èó¥ËΩ¥</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/tags" title="üîñÊ†áÁ≠æ">
                    <span>üîñÊ†áÁ≠æ</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/categories" title="üóÇÔ∏èÂàÜÁ±ª">
                    <span>üóÇÔ∏èÂàÜÁ±ª</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/about" title="üôãüèª‚Äç‚ôÇÔ∏èÂÖ≥‰∫é">
                    <span>üôãüèª‚Äç‚ôÇÔ∏èÂÖ≥‰∫é</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://kennems.github.io/">‰∏ªÈ°µ</a>&nbsp;¬ª&nbsp;<a href="https://kennems.github.io/posts/">üìöÊñáÁ´†</a>&nbsp;¬ª&nbsp;<a href="https://kennems.github.io/posts/tech/">üíªÊäÄÊúØ</a></div>
    <h1 class="post-title entry-hint-parent">
      MIT6.S081(4)-Virtual Memory
    </h1>
    <div class="post-description">
      MIT6.S081(4)
    </div>
    <div class="post-meta"><span title='2024-09-02 22:30:13 +0800 CST'>2024-09-02</span>&nbsp;¬∑&nbsp;12 ÂàÜÈíü&nbsp;¬∑&nbsp;5742 Â≠ó&nbsp;¬∑&nbsp;updated:&nbsp;2024-09-02&nbsp;¬∑&nbsp;ShowGuan

</div>
    
     <div class="post-password">
        
    </div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ÁõÆÂΩï</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#mit6s0814-virtual-memory" aria-label="MIT6.S081(4)-Virtual Memory">MIT6.S081(4)-Virtual Memory</a><ul>
                            
                    <li>
                        <a href="#plan" aria-label="Plan:">Plan:</a></li>
                    <li>
                        <a href="#virtual-memory-overview" aria-label="Virtual memory overview">Virtual memory overview</a><ul>
                            
                    <li>
                        <a href="#todays-problem" aria-label="Today&rsquo;s problem:">Today&rsquo;s problem:</a></li>
                    <li>
                        <a href="#challenge" aria-label="challenge:">challenge:</a></li>
                    <li>
                        <a href="#mmu-translation" aria-label="MMU translation">MMU translation</a><ul>
                            
                    <li>
                        <a href="#where-is-the-page-table-stored" aria-label="Where is the page table stored?">Where is the page table stored?</a></li></ul>
                    </li>
                    <li>
                        <a href="#would-it-be-reasonable-for-page-table-to-just-be-an-array-of-ptes" aria-label="Would it be reasonable for page table to just be an array of PTEs?">Would it be reasonable for page table to just be an array of PTEs?</a></li>
                    <li>
                        <a href="#risc-v-64-uses-a-three-level-page-table-to-save-space" aria-label="RISC-V 64 uses a &ldquo;three-level page table&rdquo; to save space">RISC-V 64 uses a &ldquo;three-level page table&rdquo; to save space</a></li>
                    <li>
                        <a href="#how-does-risc-v-paging-hardware-translate-a-va" aria-label="how does RISC-V paging hardware translate a va?">how does RISC-V paging hardware translate a va?</a></li>
                    <li>
                        <a href="#flags-in-pte" aria-label="flags in PTE">flags in PTE</a></li>
                    <li>
                        <a href="#what-if-v-bit-not-set-or-store-and-w-bit-not-set" aria-label="what if V bit not set? or store and W bit not set?">what if V bit not set? or store and W bit not set?</a></li>
                    <li>
                        <a href="#q-why-use-virtual-memory-in-kernel" aria-label="Q: why use virtual memory in kernel?">Q: why use virtual memory in kernel?</a></li></ul>
                    </li>
                    <li>
                        <a href="#virtual-memory-in-xv6" aria-label="Virtual memory in xv6">Virtual memory in xv6</a><ul>
                            
                    <li>
                        <a href="#trampoline-%e7%9a%84%e4%bd%9c%e7%94%a8" aria-label="Trampoline ÁöÑ‰ΩúÁî®">Trampoline ÁöÑ‰ΩúÁî®</a></li>
                    <li>
                        <a href="#q-why-this-address-space-arrangement" aria-label="Q: why this address space arrangement?">Q: why this address space arrangement?</a></li>
                    <li>
                        <a href="#q-does-the-kernel-have-to-map-all-of-phys-mem-into-its-virtual-address-space" aria-label="Q: does the kernel have to map all of phys mem into its virtual address space?">Q: does the kernel have to map all of phys mem into its virtual address space?</a></li></ul>
                    </li>
                    <li>
                        <a href="#code-walk-through" aria-label="Code walk through">Code walk through</a><ul>
                            
                    <li>
                        <a href="#setup-user-address-space" aria-label="setup user address space">setup user address space</a></li></ul>
                    </li>
                    <li>
                        <a href="#lab-page-tableshttpspdoscsailmitedu6s0812020labspgtblhtml" aria-label="Lab: page tables"><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/pgtbl.html">Lab: page tables</a></a><ul>
                            
                    <li>
                        <a href="#print-a-page-table-easyhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="Print a page table (easy)">Print a page table (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)</a></li>
                    <li>
                        <a href="#a-kernel-page-table-per-process-hardhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="A kernel page table per process (hard)">A kernel page table per process (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)</a><ul>
                            
                    <li>
                        <a href="#proch" aria-label="proc.h">proc.h</a></li>
                    <li>
                        <a href="#procc" aria-label="proc.c">proc.c</a></li>
                    <li>
                        <a href="#vmc" aria-label="vm.c">vm.c</a></li>
                    <li>
                        <a href="#defsh" aria-label="defs.h">defs.h</a></li></ul>
                    </li>
                    <li>
                        <a href="#simplify-copyincopyinstr-hardhttpspdoscsailmitedu6s0812020labsguidancehtml" aria-label="Simplify copyin/copyinstr (hard)">Simplify <code>copyin/copyinstr</code> (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)</a><ul>
                            
                    <li>
                        <a href="#defsh-1" aria-label="defs.h">defs.h</a></li>
                    <li>
                        <a href="#vmc-1" aria-label="vm.c">vm.c</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#q--a" aria-label="Q &amp; A">Q &amp; A</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h1 id="mit6s0814-virtual-memory">MIT6.S081(4)-Virtual Memory<a hidden class="anchor" aria-hidden="true" href="#mit6s0814-virtual-memory">#</a></h1>
<h2 id="plan">Plan:<a hidden class="anchor" aria-hidden="true" href="#plan">#</a></h2>
<ul>
<li>
<p>Address spaces</p>
</li>
<li>
<p>Paging hardware</p>
</li>
<li>
<p>xv6 VM code</p>
</li>
</ul>
<h2 id="virtual-memory-overview">Virtual memory overview<a hidden class="anchor" aria-hidden="true" href="#virtual-memory-overview">#</a></h2>
<h3 id="todays-problem">Today&rsquo;s problem:<a hidden class="anchor" aria-hidden="true" href="#todays-problem">#</a></h3>
<p>[user/kernel diagram]
[memory view: diagram with user processes and kernel in memory]</p>
<p><strong>Suppose the shell has a bug</strong>:</p>
<ul>
<li>sometimes it writes to a random memory address</li>
</ul>
<p>how can we keep it from wrecking the kernel?
and from wrecking other processes?</p>
<p>we want isolated address spaces
each process has its own memory
it can read and write its own memory
it cannot read or write anything else</p>
<h3 id="challenge">challenge:<a hidden class="anchor" aria-hidden="true" href="#challenge">#</a></h3>
<p>How to multiplex several memories over one physical memory?</p>
<p>while maintaining isolation between memories</p>
<ul>
<li>xv6 uses RISC-V&rsquo;s paging hardware to implement AS(Address Space)&rsquo;s
ask questions! this material is important
topic of next lab (and shows up in several other labs)</li>
</ul>
<p>paging provides a level of indirection for addressing</p>
<pre tabindex="0"><code>CPU -&gt; MMU -&gt; RAM
       VA     PA
</code></pre><p>s/w can only ld/st to virtual addresses, not physical
kernel tells MMU how to map each virtual address to a physical address
MMUÔºàMemory Management UnitÔºâ essentially has a table, indexed by <code>va</code>, yielding <code>pa</code>
called a &ldquo;<strong>page table</strong>&rdquo;
one page table per address space
MMU can restrict what virtual addresses user code can use
By programming the MMU, the kernel has complete control over <code>va-&gt;pa</code> mapping
Allows for many interesting OS features/tricks</p>
<ul>
<li>RISC-V maps 4-KB &ldquo;pages&rdquo;
and aligned &ndash; start on 4 KB boundaries
$4 KB = 12 bits$
the RISC-V used in xv6 has <strong>64-bit for addresses</strong>
thus <strong>page table index</strong> is <strong>top 64-12 = 52 bits of VA</strong>
except that the top 25 of the top 52 are unused
no RISC-V has that much memory now
can grow in future
so, index is 27 bits.</li>
</ul>
<h3 id="mmu-translation">MMU translation<a hidden class="anchor" aria-hidden="true" href="#mmu-translation">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923104937296.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923104937296.png" alt="image-20240923104937296"  />
        </a>
    </div>
</p>
<ul>
<li>see Figure 3.1 of book
use index bits of VA to find a <strong>page table entry (PTE)</strong>
construct physical address using PPN from <strong>PTE + offset</strong> of VA</li>
</ul>
<p>What is in PTE?
each PTE is 64 bits, but only 54 are used
top 44 bits of PTE are top bits of physical address
&ldquo;<strong>physical page number</strong>&rdquo;
low 10 bits of PTE flags
Present, Writeable, &amp;c
note: size virtual addresses != size physical addresses</p>
<h4 id="where-is-the-page-table-stored">Where is the page table stored?<a hidden class="anchor" aria-hidden="true" href="#where-is-the-page-table-stored">#</a></h4>
<p>in RAM &ndash; MMU loads (and stores) PTEs
o/s can read/write PTEs
read/write memory location corresponding to PTEs</p>
<h3 id="would-it-be-reasonable-for-page-table-to-just-be-an-array-of-ptes">Would it be reasonable for page table to just be an array of PTEs?<a hidden class="anchor" aria-hidden="true" href="#would-it-be-reasonable-for-page-table-to-just-be-an-array-of-ptes">#</a></h3>
<p>how big is it?
2^27 is roughly 134 million
64 bits per entry
134*8 MB for a full page table
wasting roughly 1GB per page table
one page table per address space
one address space per application
would waste lots of memory for small programs!
you only need mappings for a few hundred pages
so the rest of the million entries would be there but not needed</p>
<h3 id="risc-v-64-uses-a-three-level-page-table-to-save-space">RISC-V 64 uses a &ldquo;three-level page table&rdquo; to save space<a hidden class="anchor" aria-hidden="true" href="#risc-v-64-uses-a-three-level-page-table-to-save-space">#</a></h3>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923111502163.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923111502163.png" alt="image-20240923111502163"  />
        </a>
    </div>
</p>
<p>see figure 3.2 from book
page directory page (PD)
PD has 512 PTEs
PTEs point to another PD or is a leaf
so 512<em>512</em>512 PTEs in total
PD entries can be invalid
those PTE pages need not exist
so a page table for a small address space can be small</p>
<p>how does the mmu know where the page table is located in RAM?
satp holds phys address of top PD
pages can be anywhere in RAM &ndash; need not be contiguous
rewrite satp when switching to another address space/application</p>
<h3 id="how-does-risc-v-paging-hardware-translate-a-va">how does RISC-V paging hardware translate a va?<a hidden class="anchor" aria-hidden="true" href="#how-does-risc-v-paging-hardware-translate-a-va">#</a></h3>
<p>need to find the right PTE
satp register points to PA of top/L2 PD
top 9 bits index L2 PD to get PA of L1 PD
next 9 bits index L1 PD to get PA of L0 PD
next 9 bits index L0 PD to get PA of PTE
PPN from PTE + low-12 from VA</p>
<h3 id="flags-in-pte">flags in PTE<a hidden class="anchor" aria-hidden="true" href="#flags-in-pte">#</a></h3>
<p>V, R, W, X, U
xv6 uses all of them</p>
<h3 id="what-if-v-bit-not-set-or-store-and-w-bit-not-set">what if V bit not set? or store and W bit not set?<a hidden class="anchor" aria-hidden="true" href="#what-if-v-bit-not-set-or-store-and-w-bit-not-set">#</a></h3>
<p>&ldquo;<strong>page fault</strong>&rdquo;
forces transfer to kernel
trap.c in xv6 source
kernel can just produce error, kill process
in xv6: &ldquo;usertrap(): unexpected scause &hellip; pid=&hellip; sepc=&hellip; stval=&hellip;&rdquo;
or kernel can install a PTE, resume the process
e.g. after loading the page of memory from disk</p>
<ul>
<li>indirection allows paging h/w to solve many problems
e.g. phys memory doesn&rsquo;t have to be contiguous
avoids fragmentation
e.g. lazy allocation (a lab)
e.g. copy-on-write fork (another lab)
many more techniques
topic of next lecture</li>
</ul>
<h3 id="q-why-use-virtual-memory-in-kernel">Q: why use virtual memory in kernel?<a hidden class="anchor" aria-hidden="true" href="#q-why-use-virtual-memory-in-kernel">#</a></h3>
<p>It is clearly good to have page tables for user processes
but why have a page table for the kernel?
could the kernel run with using only physical addresses?
top-level answer: yes
most standard kernels do use virtual addresses
why do standard kernels do so?
some reasons are lame, some are better, none are fundamental</p>
<ul>
<li>the hardware makes it difficult to turn it off
e.g. on entering a system call, one would have to disable VM</li>
<li>the kernel itself can benefit from virtual addresses
mark text pages X, but data not (helps tracking down bugs)
unmap a page below kernel stack (helps tracking down bugs)
map a page both in user and kernel (helps user/kernel transition)</li>
</ul>
<h2 id="virtual-memory-in-xv6">Virtual memory in xv6<a hidden class="anchor" aria-hidden="true" href="#virtual-memory-in-xv6">#</a></h2>
<ul>
<li>kernel page table</li>
</ul>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923105202533.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923105202533.png" alt="image-20240923105202533"  />
        </a>
    </div>
</p>
<ul>
<li>See figure 3.3 of book
simple maping mostly
map virtual to physical one-on-one
note double-mapping of trampoline
note permissions
why map devices?</li>
</ul>
<h3 id="trampoline-ÁöÑ‰ΩúÁî®">Trampoline ÁöÑ‰ΩúÁî®<a hidden class="anchor" aria-hidden="true" href="#trampoline-ÁöÑ‰ΩúÁî®">#</a></h3>
<p>‰∏∫ÂÜÖÊ†∏ÂíåÁî®Êà∑ÊÄÅ‰πãÈó¥ÁöÑÂàáÊç¢Êèê‰æõ‰∏Ä‰∏™Áªü‰∏ÄÁöÑÂÖ•Âè£„ÄÇÁî±‰∫éÂÖ∂Âú®ÊØè‰∏™ËøõÁ®ãÁöÑÈ°µË°®ÈÉΩÊò†Â∞ÑÂà∞Áõ∏ÂêåÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÂÜÖÊ†∏ÂíåÁî®Êà∑ËøõÁ®ãÈÉΩËÉΩÂ§üÂú®ÂàáÊç¢ËøáÁ®ã‰∏≠‰ΩøÁî®ËøôÊÆµ‰ª£Á†ÅÔºåÂèØ‰ª•Á°Æ‰øù Ôºö</p>
<ul>
<li><strong>‰∏ä‰∏ãÊñáÁöÑ‰øùÂ≠òÂíåÊÅ¢Â§ç</strong>Ôºö‰øùÂ≠òÂΩìÂâçÁöÑCPUÁä∂ÊÄÅÔºàÂØÑÂ≠òÂô®ÔºåÂ†ÜÊ†àÁ≠âÔºâÔºåÂπ∂Âú®ËøîÂõûÁî®Êà∑ÊÄÅÊó∂ÊÅ¢Â§ç„ÄÇ</li>
<li><strong>Âú∞ÂùÄÁ©∫Èó¥ÂàáÊç¢</strong> Ôºö Âú®ËøõÁ®ãÂàáÊç¢Êó∂Ôºå‰ªéÁî®Êà∑Âú∞ÂùÄÁ©∫Èó¥ÂàáÊç¢Âà∞ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÔºåÂπ∂Á°Æ‰øùÂÆâÂÖ®„ÄÇ</li>
</ul>
<p><code>trampoline</code>Êàê‰∏∫Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ‰πãÈó¥ÂÆâÂÖ®‰∏î‰∏ÄËá¥ÁöÑÊ°•Ê¢Å„ÄÇ</p>
<p>Each process has its own address space
and its own page table</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923105759997.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240923105759997.png" alt="image-20240923105759997"  />
        </a>
    </div>
</p>
<p>see figure 3.4 of book</p>
<p>note:</p>
<ul>
<li>
<p><code>trampoline</code> and <code>trapframe</code> aren&rsquo;t writable by user process</p>
</li>
<li>
<p>kernel switches page tables (i.e. sets satp) when switching processes</p>
</li>
</ul>
<h3 id="q-why-this-address-space-arrangement">Q: why this address space arrangement?<a hidden class="anchor" aria-hidden="true" href="#q-why-this-address-space-arrangement">#</a></h3>
<p>user virtual addresses start at zero
of course user va 0 maps to different pa for each process
$16,777,216 GB$ for user heap to grow contiguously
but needn&rsquo;t have contiguous phys mem &ndash; no fragmentation problem
both kernel and user map trampoline and trapframe page
eases transition user -&gt; kernel and back
kernel doesn&rsquo;t map user applications
not easy for kernel to r/w user memory
need translate user virtual address to kernel virtual address
good for isolation (see spectre attacks)
easy for kernel to r/w physical memory
pa x mapped at va x</p>
<h3 id="q-does-the-kernel-have-to-map-all-of-phys-mem-into-its-virtual-address-space">Q: does the kernel have to map all of phys mem into its virtual address space?<a hidden class="anchor" aria-hidden="true" href="#q-does-the-kernel-have-to-map-all-of-phys-mem-into-its-virtual-address-space">#</a></h3>
<h2 id="code-walk-through">Code walk through<a hidden class="anchor" aria-hidden="true" href="#code-walk-through">#</a></h2>
<p>setup of kernel address space
<code>kvmmap()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Âú®ÂÜÖÊ†∏È°µË°®‰∏≠Ê∑ªÂä†‰∏Ä‰∏™Êò†Â∞Ñ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ‰ªÖÂú®ÂêØÂä®Êó∂‰ΩøÁî®„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ËØ•ÂáΩÊï∞‰∏çÂà∑Êñ∞ TLB ÊàñÂêØÁî®ÂàÜÈ°µ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kvmmap</span>(uint64 va, uint64 pa, uint64 sz, <span style="color:#66d9ef">int</span> perm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ë∞ÉÁî® mappages ÂáΩÊï∞Â∞ÜËôöÊãüÂú∞ÂùÄ va Êò†Â∞ÑÂà∞Áâ©ÁêÜÂú∞ÂùÄ paÔºåÊò†Â∞ÑÂ§ßÂ∞è‰∏∫ szÔºåÊùÉÈôê‰∏∫ perm
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(kernel_pagetable, va, sz, pa, perm) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Â¶ÇÊûúÊò†Â∞ÑÂ§±Ë¥•ÔºåÂàôËß¶ÂèëÁ≥ªÁªüÈîôËØØ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;kvmmap&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Q: what is address 0x10000000 (256M)</p>
<p>$ 0x10000000 = 256 MB$</p>
<p>Q: how much address space does 1 L2 entry cover? (1G)</p>
<p>$512√ó2 MB=1 GB$</p>
<p>Q: how much address space does 1 L1 entry cover? (2MB)</p>
<p>$512 √ó 4096B = 2MB$</p>
<p>Q: how much address space does 1 L0 entry cover? (4096)</p>
<p>ÊØè‰∏™ L0 Êù°ÁõÆÊåáÂêë‰∏Ä‰∏™ 4KB ÁöÑÈ°µÔºåÂõ†Ê≠§ÊØè‰∏™ L0 Êù°ÁõÆË¶ÜÁõñ <strong>4096 Â≠óËäÇ</strong>ÁöÑÂú∞ÂùÄÁ©∫Èó¥</p>
<p>print kernel page table</p>
<p>Q: what is size of address space? (512G)</p>
<p>ÊØè‰∏™L2Ë¶ÜÁõñ $1GB$, ÂÖ±Ë¶ÜÁõñ$512GB$</p>
<p>Q: how much memory is used to represent it after 1rst kvmmap()?</p>
<p>($3 pages$)</p>
<p>Q: how many entries is CLINT?</p>
<p>($16 pages$)</p>
<p>Q: how many entries is PLIC?</p>
<p>(1024 pages, two level 1 PDs)</p>
<p>Q: how many pages is kernel text</p>
<p>$ (8 pages)$</p>
<p>Q: how many pages is kernel total</p>
<p>$ (128M = 64 * 2MB)$</p>
<p>Q: Is trampoline mapped twice?</p>
<p>(yes, last entry and direct-mapped, entry [2, 3, 7])</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">kvminithart</span>();
</span></span></code></pre></div><p>Q: after executing <code>w_satp()</code> why will the next instruction be <code>sfence_vma()</code>?</p>
<ul>
<li><code>mappages()</code> in vm.c</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ‰∏∫‰ªé va ÂºÄÂßãÁöÑËôöÊãüÂú∞ÂùÄÂàõÂª∫ PTEÔºàÈ°µË°®Êù°ÁõÆÔºâÔºå
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Ëøô‰∫õÊù°ÁõÆÂºïÁî®‰ªé pa ÂºÄÂßãÁöÑÁâ©ÁêÜÂú∞ÂùÄ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// va Âíå size ÂèØËÉΩ‰∏çÊòØÈ°µÈù¢ÂØπÈΩêÁöÑ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÊàêÂäüËøîÂõû 0ÔºåÂ§±Ë¥•Êó∂ËøîÂõû -1ÔºàÂ¶ÇÊûú walk() Êó†Ê≥ïÂàÜÈÖçÊâÄÈúÄÁöÑÈ°µË°®È°µÈù¢Ôºâ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mappages</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span style="color:#66d9ef">int</span> perm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 a, last;       <span style="color:#75715e">// ÂÆö‰πâÂèòÈáè a Âíå lastÔºåÁî®‰∫éË∑üË∏™ÂΩìÂâçÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;           <span style="color:#75715e">// ÂÆö‰πâÊåáÈíà pteÔºåÁî®‰∫éËÆøÈóÆÈ°µË°®Êù°ÁõÆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â∞ÜËôöÊãüÂú∞ÂùÄ va Âêë‰∏ãÂØπÈΩêÂà∞È°µÈù¢ËæπÁïå
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  a <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â∞ÜÊúÄÂêé‰∏Ä‰∏™ËôöÊãüÂú∞ÂùÄÂêë‰∏ãÂØπÈΩêÂà∞È°µÈù¢ËæπÁïå
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  last <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va <span style="color:#f92672">+</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Âæ™ÁéØÂàõÂª∫È°µË°®Êù°ÁõÆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(;;){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçËôöÊãüÂú∞ÂùÄ a ÂØπÂ∫îÁöÑÈ°µË°®Êù°ÁõÆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, a, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// Â¶ÇÊûú walk Â§±Ë¥•ÔºåËøîÂõû -1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ê£ÄÊü•ÂΩìÂâçÈ°µË°®Êù°ÁõÆÊòØÂê¶Â∑≤ÁªèÊúâÊïà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;remap&#34;</span>);  <span style="color:#75715e">// Â¶ÇÊûúÂ∑≤ÁªèÊò†Â∞ÑÔºåËß¶ÂèëÈîôËØØ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ËÆæÁΩÆÈ°µË°®Êù°ÁõÆÔºåÊò†Â∞ÑÁâ©ÁêÜÂú∞ÂùÄ paÔºåÂπ∂ËÆæÁΩÆÊùÉÈôêÂíåÊúâÊïà‰Ωç
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pa) <span style="color:#f92672">|</span> perm <span style="color:#f92672">|</span> PTE_V;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Â¶ÇÊûúÂΩìÂâçÂú∞ÂùÄ a ÊòØÊúÄÂêé‰∏Ä‰∏™Âú∞ÂùÄÔºåÈÄÄÂá∫Âæ™ÁéØ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(a <span style="color:#f92672">==</span> last)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ÁªßÁª≠Âà∞‰∏ã‰∏Ä‰∏™È°µÈù¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    a <span style="color:#f92672">+=</span> PGSIZE;  <span style="color:#75715e">// ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™ËôöÊãüÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pa <span style="color:#f92672">+=</span> PGSIZE; <span style="color:#75715e">// ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™Áâ©ÁêÜÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// ÊàêÂäüÂàõÂª∫ÊâÄÊúâÈ°µË°®Êù°ÁõÆÔºåËøîÂõû 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>arguments are <code>top PD</code>, <code>va</code>, <code>size</code>, <code>pa</code>, <code>perm</code>
adds mappings from a range of va&rsquo;s to corresponding pa&rsquo;s
rounds b/c some uses pass in non-page-aligned addresses
for each page-aligned address in the range
call <code>walkpgdir</code> to find address of PTE
need the PTE&rsquo;s address (not just content) b/c we want to modify
put the desired pa into the PTE
mark PTE as valid w/ PTE_P</p>
<ul>
<li><code>walk()</code> in vm.c</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walk</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, <span style="color:#66d9ef">int</span> alloc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ê£ÄÊü•ËôöÊãüÂú∞ÂùÄÊòØÂê¶Ë∂ÖËøáÊúÄÂ§ßËôöÊãüÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;walk&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ‰ªéÊúÄÈ´òÁ∫ßÂà´ÁöÑÈ°µË°®ÂºÄÂßãÔºåÈÄêÁ∫ßÂêë‰∏ãÊü•Êâæ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; level <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; level<span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçÁ∫ßÂà´ÁöÑÈ°µË°®Êù°ÁõÆÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(level, va)];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Â¶ÇÊûúÈ°µË°®Êù°ÁõÆÊúâÊïà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Ëé∑ÂèñÁâ©ÁêÜÂú∞ÂùÄÂπ∂ËøõÂÖ•‰∏ã‰∏ÄÂ±ÇÈ°µË°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>)<span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Â¶ÇÊûú‰∏çÂàÜÈÖçÔºåÊàñËÄÖÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>alloc <span style="color:#f92672">||</span> (pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pde_t</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ÂàùÂßãÂåñÊñ∞ÁöÑÈ°µË°®‰∏∫0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">memset</span>(pagetable, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ËÆæÁΩÆÈ°µË°®Êù°ÁõÆ‰∏∫Êñ∞ÂàÜÈÖçÁöÑÈ°µË°®ÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÊ†áËÆ∞‰∏∫ÊúâÊïà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pagetable) <span style="color:#f92672">|</span> PTE_V;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ËøîÂõûÊúÄ‰ΩéÁ∫ßÂà´È°µË°®‰∏≠ÂØπÂ∫îËôöÊãüÂú∞ÂùÄÁöÑÈ°µË°®Êù°ÁõÆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(<span style="color:#ae81ff">0</span>, va)];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mimics how the paging h/w finds the PTE for an address
PX extracts the 9 bits at Level level
<code>&amp;pagetable[PX(level, va)]</code> is the address of the relevant PTE</p>
<pre tabindex="0"><code>if PTE_V
  the relevant page-table page already exists
  PTE2PA extracts the PPN from the PDE
if not PTE_V
  alloc a page-table page
  fill in pte with PPN (using PA2PTE)
</code></pre><p>now the PTE we want is in the page-table page</p>
<ul>
<li><code>procinit()</code> in <code>proc.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Âú®ÂêØÂä®Êó∂ÂàùÂßãÂåñËøõÁ®ãË°®„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">procinit</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÂàùÂßãÂåñËøõÁ®ã ID ÈîÅÔºå‰ª•Á°Æ‰øùÂØπËøõÁ®ã ID ÁöÑÂÆâÂÖ®ËÆøÈóÆ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">initlock</span>(<span style="color:#f92672">&amp;</span>pid_lock, <span style="color:#e6db74">&#34;nextpid&#34;</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈÅçÂéÜËøõÁ®ãË°®‰∏≠ÁöÑÊØè‰∏™ËøõÁ®ã
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(p <span style="color:#f92672">=</span> proc; p <span style="color:#f92672">&lt;</span> <span style="color:#f92672">&amp;</span>proc[NPROC]; p<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ÂàùÂßãÂåñÊØè‰∏™ËøõÁ®ãÁöÑÈîÅÔºå‰ª•‰øùÊä§ËøõÁ®ãÁªìÊûÑÁöÑÂπ∂ÂèëËÆøÈóÆ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">initlock</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock, <span style="color:#e6db74">&#34;proc&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ‰∏∫ËøõÁ®ãÁöÑÂÜÖÊ†∏Ê†àÂàÜÈÖç‰∏ÄÈ°µÂÜÖÂ≠ò„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// Â∞ÜÂÖ∂Êò†Â∞ÑÂà∞È´òÂú∞ÂùÄÂÜÖÂ≠òÔºåÂπ∂Ë∑üÈöè‰∏Ä‰∏™Êó†ÊïàÁöÑ‰øùÊä§È°µ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>();  <span style="color:#75715e">// ÂàÜÈÖç‰∏ÄÈ°µÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(pa <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;kalloc&#34;</span>);  <span style="color:#75715e">// Â¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåËß¶ÂèëÁ≥ªÁªüÈîôËØØ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ËÆ°ÁÆóËØ•ËøõÁ®ãÂÜÖÊ†∏Ê†àÁöÑËôöÊãüÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      uint64 va <span style="color:#f92672">=</span> <span style="color:#a6e22e">KSTACK</span>((<span style="color:#66d9ef">int</span>) (p <span style="color:#f92672">-</span> proc));
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Âú®ÂÜÖÊ†∏È°µË°®‰∏≠Êò†Â∞ÑËôöÊãüÂú∞ÂùÄ va Âà∞Áâ©ÁêÜÂú∞ÂùÄ paÔºåÂ§ßÂ∞è‰∏∫ PGSIZEÔºåÊùÉÈôê‰∏∫ÂèØËØªÂíåÂèØÂÜô
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">kvmmap</span>(va, (uint64)pa, PGSIZE, PTE_R <span style="color:#f92672">|</span> PTE_W);
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Â∞ÜËÆ°ÁÆóÂá∫ÁöÑËôöÊãüÂú∞ÂùÄ‰øùÂ≠òÂà∞ËøõÁ®ãÁªìÊûÑ‰∏≠
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      p<span style="color:#f92672">-&gt;</span>kstack <span style="color:#f92672">=</span> va;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÂàùÂßãÂåñËôöÊãüÂÜÖÂ≠òÁÆ°ÁêÜÁõ∏ÂÖ≥ÁöÑÁ°¨‰ª∂ËÆæÁΩÆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">kvminithart</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>alloc a page for each kernel stack with a guard page</p>
<h3 id="setup-user-address-space">setup user address space<a hidden class="anchor" aria-hidden="true" href="#setup-user-address-space">#</a></h3>
<ul>
<li><code>allocproc()</code>: allocates empty top-level page table</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Âú®ËøõÁ®ãË°®‰∏≠Êü•Êâæ‰∏Ä‰∏™ UNUSED Áä∂ÊÄÅÁöÑËøõÁ®ã„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Â¶ÇÊûúÊâæÂà∞ÔºåÂàùÂßãÂåñÊâÄÈúÄÁöÑÁä∂ÊÄÅ‰ª•Âú®ÂÜÖÊ†∏‰∏≠ËøêË°åÔºåÂπ∂ËøîÂõûÊó∂ÊåÅÊúâ p-&gt;lock„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Â¶ÇÊûúÊ≤°ÊúâÁ©∫Èó≤ÁöÑËøõÁ®ãÔºåÊàñÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû 0„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> proc<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allocproc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈÅçÂéÜËøõÁ®ãË°®‰∏≠ÁöÑÊØè‰∏™ËøõÁ®ã
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(p <span style="color:#f92672">=</span> proc; p <span style="color:#f92672">&lt;</span> <span style="color:#f92672">&amp;</span>proc[NPROC]; p<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);  <span style="color:#75715e">// Ëé∑ÂèñËøõÁ®ãÁöÑÈîÅ‰ª•ÂÆâÂÖ®ËÆøÈóÆÂÖ∂Áä∂ÊÄÅ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> UNUSED) {  <span style="color:#75715e">// Ê£ÄÊü•ËøõÁ®ãÁä∂ÊÄÅÊòØÂê¶‰∏∫ UNUSED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">goto</span> found;  <span style="color:#75715e">// ÊâæÂà∞Á©∫Èó≤ËøõÁ®ãÔºåË∑≥ËΩ¨Âà∞ÂàùÂßãÂåñÈÉ®ÂàÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);  <span style="color:#75715e">// Â¶ÇÊûú‰∏çÊòØ UNUSEDÔºåÈáäÊîæÈîÅÂπ∂ÁªßÁª≠‰∏ã‰∏Ä‰∏™ËøõÁ®ã
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Á©∫Èó≤ËøõÁ®ãÔºåËøîÂõû 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>found:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑËøõÁ®ã ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">allocpid</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ‰∏∫ËøõÁ®ãÂàÜÈÖç‰∏Ä‰∏™ trapframe È°µÈù¢ÔºåÁî®‰∫éÂ§ÑÁêÜÁ≥ªÁªüË∞ÉÁî®Âíå‰∏≠Êñ≠
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);  <span style="color:#75715e">// ÂàÜÈÖçÂ§±Ë¥•ÔºåÈáäÊîæÈîÅ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// ËøîÂõû 0 Ë°®Á§∫Â§±Ë¥•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÂàõÂª∫‰∏Ä‰∏™Á©∫ÁöÑÁî®Êà∑È°µÈù¢Ë°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> <span style="color:#a6e22e">proc_pagetable</span>(p);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {  <span style="color:#75715e">// Ê£ÄÊü•È°µÈù¢Ë°®ÂàÜÈÖçÊòØÂê¶ÊàêÂäü
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">freeproc</span>(p);  <span style="color:#75715e">// Â¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåÈáäÊîæËøõÁ®ãËµÑÊ∫ê
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);  <span style="color:#75715e">// ÈáäÊîæÈîÅ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// ËøîÂõû 0 Ë°®Á§∫Â§±Ë¥•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ËÆæÁΩÆÊñ∞ÁöÑ‰∏ä‰∏ãÊñáÔºå‰ª•Âú® forkret Â§ÑÂºÄÂßãÊâßË°åÔºå
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// forkret ‰ºöËøîÂõûÂà∞Áî®Êà∑Á©∫Èó¥„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>context, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>context));  <span style="color:#75715e">// Ê∏ÖÈõ∂‰∏ä‰∏ãÊñáÁªìÊûÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>context.ra <span style="color:#f92672">=</span> (uint64)forkret;  <span style="color:#75715e">// ËÆæÁΩÆËøîÂõûÂú∞ÂùÄ‰∏∫ forkret ÂáΩÊï∞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>context.sp <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>kstack <span style="color:#f92672">+</span> PGSIZE;  <span style="color:#75715e">// ËÆæÁΩÆÂ†ÜÊ†àÊåáÈíàÂà∞ÂÜÖÊ†∏Ê†àÁöÑÈ°∂ÈÉ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> p;  <span style="color:#75715e">// ËøîÂõûÂàÜÈÖçÂíåÂàùÂßãÂåñÁöÑËøõÁ®ã
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><code>fork()</code>: <code>uvmcopy()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Ê†πÊçÆÁà∂ËøõÁ®ãÁöÑÈ°µË°®ÔºåÂ∞ÜÂÖ∂ÂÜÖÂ≠òÂ§çÂà∂Âà∞Â≠êËøõÁ®ãÁöÑÈ°µË°®„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Â§çÂà∂È°µË°®ÂíåÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÊàêÂäüËøîÂõû 0ÔºåÂ§±Ë¥•ËøîÂõû -1„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Âú®Â§±Ë¥•Êó∂ÈáäÊîæÂ∑≤ÂàÜÈÖçÁöÑÈ°µÈù¢„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmcopy</span>(<span style="color:#66d9ef">pagetable_t</span> old, <span style="color:#66d9ef">pagetable_t</span> new, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;            <span style="color:#75715e">// È°µË°®Êù°ÁõÆÁöÑÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 pa, i;          <span style="color:#75715e">// Áâ©ÁêÜÂú∞ÂùÄÂíåÂæ™ÁéØÂèòÈáè
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint flags;            <span style="color:#75715e">// È°µË°®Êù°ÁõÆÁöÑÊ†áÂøó‰Ωç
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈÅçÂéÜ‰ªé 0 Âà∞ sz ÁöÑÊâÄÊúâÈ°µÈù¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; i <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ëé∑ÂèñÊóßÈ°µË°®‰∏≠ÂØπÂ∫îËôöÊãüÂú∞ÂùÄÁöÑÈ°µË°®Êù°ÁõÆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(old, i, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmcopy: pte should exist&#34;</span>);  <span style="color:#75715e">// Â¶ÇÊûúÊú™ÊâæÂà∞È°µË°®Êù°ÁõÆÔºåËß¶ÂèëÈîôËØØ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ê£ÄÊü•È°µË°®Êù°ÁõÆÊòØÂê¶ÊúâÊïà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmcopy: page not present&#34;</span>);  <span style="color:#75715e">// Â¶ÇÊûúÈ°µÈù¢‰∏çÂ≠òÂú®ÔºåËß¶ÂèëÈîôËØØ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ëé∑ÂèñÁâ©ÁêÜÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ê∏ÖÈô§ÂÜôÊùÉÈôêÊ†áÂøóÔºå‰ª•‰æøËøõË°åÂÜôÊó∂Â§çÂà∂ÔºàCopy-On-WriteÔºâ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;=</span> (<span style="color:#f92672">~</span>PTE_W); <span style="color:#75715e">// Ê∏ÖÈô§ PTE_W
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">|=</span> (PTE_C);  <span style="color:#75715e">// ËÆæÁΩÆ PTE_CÔºåÊ†áËÆ∞Ê≠§È°µÈù¢‰∏∫ Copy-On-Write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçÈ°µË°®Êù°ÁõÆÁöÑÂÖ∂‰ªñÊ†áÂøó
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    flags <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE_FLAGS</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Âú®Êñ∞È°µË°®‰∏≠Êò†Â∞ÑÂéüÊù•ÁöÑÁâ©ÁêÜÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mappages</span>(new, i, PGSIZE, pa, flags) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> err;  <span style="color:#75715e">// Â¶ÇÊûúÊò†Â∞ÑÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Â¢ûÂä†Áâ©ÁêÜÈ°µÈù¢ÁöÑÂºïÁî®ËÆ°Êï∞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">kincre</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)pa);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// ÊàêÂäüÂÆåÊàêÂ§çÂà∂ÔºåËøîÂõû 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span> err:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈáäÊîæÂú®Êñ∞È°µË°®‰∏≠Â∑≤ÂàÜÈÖçÁöÑÈ°µÈù¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uvmunmap</span>(new, <span style="color:#ae81ff">0</span>, i <span style="color:#f92672">/</span> PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// ËøîÂõû -1 Ë°®Á§∫Â§±Ë¥•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><code>exec()</code>: replace proc&rsquo;s page table with a new one</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ÊâßË°åÊåáÂÆöË∑ØÂæÑÁöÑÁ®ãÂ∫èÔºåËÆæÁΩÆÊñ∞ÁöÑÁî®Êà∑Ê†àÂπ∂ÂáÜÂ§áÂèÇÊï∞„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÊàêÂäüËøîÂõûÁ®ãÂ∫èÁöÑÂèÇÊï∞‰∏™Êï∞ÔºåÂ§±Ë¥•ËøîÂõû -1„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exec</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s, <span style="color:#f92672">*</span>last;          <span style="color:#75715e">// Â≠óÁ¨¶‰∏≤ÊåáÈíàÔºåÁî®‰∫éÂ§ÑÁêÜË∑ØÂæÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> i, off;              <span style="color:#75715e">// Âæ™ÁéØÂèòÈáèÂíåÂÅèÁßªÈáè
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 argc, sz <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sp, ustack[MAXARG<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>], stackbase; <span style="color:#75715e">// ÂèÇÊï∞ËÆ°Êï∞„ÄÅÂÜÖÂ≠òÂ§ßÂ∞è„ÄÅÊ†àÊåáÈíà„ÄÅÁî®Êà∑Ê†àÊï∞ÁªÑÂíåÊ†àÂü∫Âú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> elfhdr elf;       <span style="color:#75715e">// ELF Â§¥ÁªìÊûÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>ip;        <span style="color:#75715e">// Êñá‰ª∂ËäÇÁÇπÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> proghdr ph;       <span style="color:#75715e">// Á®ãÂ∫èÂ§¥ÁªìÊûÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pagetable_t</span> pagetable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, oldpagetable; <span style="color:#75715e">// Êñ∞ÊóßÈ°µË°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>(); <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁªìÊûÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">begin_op</span>(); <span style="color:#75715e">// ÂºÄÂßãÊñá‰ª∂Êìç‰Ωú
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Êü•ÊâæÁ®ãÂ∫èË∑ØÂæÑÂØπÂ∫îÁöÑ inode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((ip <span style="color:#f92672">=</span> <span style="color:#a6e22e">namei</span>(path)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">end_op</span>(); <span style="color:#75715e">// ÁªìÊùüÊñá‰ª∂Êìç‰Ωú
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// Êâæ‰∏çÂà∞Êñá‰ª∂ÔºåËøîÂõû -1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ilock</span>(ip); <span style="color:#75715e">// ÈîÅÂÆö inode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ê£ÄÊü• ELF Â§¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">readi</span>(ip, <span style="color:#ae81ff">0</span>, (uint64)<span style="color:#f92672">&amp;</span>elf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(elf)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(elf))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// ËØªÂèñ ELF Â§¥Â§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(elf.magic <span style="color:#f92672">!=</span> ELF_MAGIC)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Ê£ÄÊü• ELF È≠îÊ≥ïÊï∞ÔºåËã•‰∏çÂåπÈÖçÂàôË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁöÑÈ°µË°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((pagetable <span style="color:#f92672">=</span> <span style="color:#a6e22e">proc_pagetable</span>(p)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Ëé∑ÂèñÈ°µË°®Â§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ‰ªé ELF Êñá‰ª∂Âä†ËΩΩÁ®ãÂ∫èÂà∞ÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, off <span style="color:#f92672">=</span> elf.phoff; i <span style="color:#f92672">&lt;</span> elf.phnum; i<span style="color:#f92672">++</span>, off <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(ph)){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ËØªÂèñÁ®ãÂ∫èÂ§¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">readi</span>(ip, <span style="color:#ae81ff">0</span>, (uint64)<span style="color:#f92672">&amp;</span>ph, off, <span style="color:#66d9ef">sizeof</span>(ph)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(ph))
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// ËØªÂèñÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(ph.type <span style="color:#f92672">!=</span> ELF_PROG_LOAD)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>; <span style="color:#75715e">// ‰ªÖÂ§ÑÁêÜÂä†ËΩΩÁ±ªÂûãÁöÑÁ®ãÂ∫èÂ§¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(ph.memsz <span style="color:#f92672">&lt;</span> ph.filesz)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// ÂÜÖÂ≠òÂ§ßÂ∞èÂ∞è‰∫éÊñá‰ª∂Â§ßÂ∞èÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(ph.vaddr <span style="color:#f92672">+</span> ph.memsz <span style="color:#f92672">&lt;</span> ph.vaddr)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Âú∞ÂùÄÊ∫¢Âá∫ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    uint64 sz1;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ‰∏∫Âä†ËΩΩÁöÑÊÆµÂàÜÈÖçÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((sz1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">uvmalloc</span>(pagetable, sz, ph.vaddr <span style="color:#f92672">+</span> ph.memsz)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// ÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sz <span style="color:#f92672">=</span> sz1; <span style="color:#75715e">// Êõ¥Êñ∞ÂàÜÈÖçÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ê£ÄÊü•ÊÆµÁöÑËôöÊãüÂú∞ÂùÄÊòØÂê¶ÂØπÈΩê
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(ph.vaddr <span style="color:#f92672">%</span> PGSIZE <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// ËôöÊãüÂú∞ÂùÄÊú™ÂØπÈΩêÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ‰ªéÊñá‰ª∂‰∏≠Âä†ËΩΩÊÆµÂà∞ÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">loadseg</span>(pagetable, ph.vaddr, ip, ph.off, ph.filesz) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Âä†ËΩΩÊÆµÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">iunlockput</span>(ip); <span style="color:#75715e">// Ëß£ÈîÅÂπ∂ÈáäÊîæ inode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">end_op</span>(); <span style="color:#75715e">// ÁªìÊùüÊñá‰ª∂Êìç‰Ωú
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ip <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// Ê∏ÖÁ©∫ inode ÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>(); <span style="color:#75715e">// ÂÜçÊ¨°Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁªìÊûÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 oldsz <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>sz; <span style="color:#75715e">// ‰øùÂ≠òÊóßÁöÑÁ®ãÂ∫èÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Âú®‰∏ã‰∏Ä‰∏™È°µËæπÁïåÂàÜÈÖç‰∏§‰∏™È°µÈù¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ‰ΩøÁî®Á¨¨‰∫å‰∏™È°µÈù¢‰Ωú‰∏∫Áî®Êà∑Ê†à
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sz <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDUP</span>(sz); <span style="color:#75715e">// Â∞ÜÂ§ßÂ∞èÂêë‰∏äÂØπÈΩêÂà∞È°µËæπÁïå
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 sz1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((sz1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">uvmalloc</span>(pagetable, sz, sz <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>PGSIZE)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// ÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sz <span style="color:#f92672">=</span> sz1; <span style="color:#75715e">// Êõ¥Êñ∞ÂàÜÈÖçÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uvmclear</span>(pagetable, sz <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> PGSIZE); <span style="color:#75715e">// Ê∏ÖÈô§Ê†àÂ∫ïÁöÑÈ°µÈù¢ÂÜÖÂÆπ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sp <span style="color:#f92672">=</span> sz; <span style="color:#75715e">// ËÆæÁΩÆÊ†àÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  stackbase <span style="color:#f92672">=</span> sp <span style="color:#f92672">-</span> PGSIZE; <span style="color:#75715e">// ËÆæÁΩÆÊ†àÂü∫Âú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â∞ÜÂèÇÊï∞Â≠óÁ¨¶‰∏≤Êé®ÂÖ•Ê†àÔºåÂπ∂ÂáÜÂ§áÊ†àÁöÑÂÖ∂‰ªñÈÉ®ÂàÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(argc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; argv[argc]; argc<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">&gt;=</span> MAXARG)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Ë∂ÖËøáÊúÄÂ§ßÂèÇÊï∞Êï∞ÈáèÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sp <span style="color:#f92672">-=</span> <span style="color:#a6e22e">strlen</span>(argv[argc]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// ‰∏∫ÂèÇÊï∞Â≠óÁ¨¶‰∏≤ÂàÜÈÖçÁ©∫Èó¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sp <span style="color:#f92672">-=</span> sp <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span>; <span style="color:#75715e">// Á°Æ‰øùÊ†àÊåáÈíàÊòØ 16 Â≠óËäÇÂØπÈΩê
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(sp <span style="color:#f92672">&lt;</span> stackbase)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Ê†àÊåáÈíàË∂ÖÂá∫Ê†àÂü∫ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">copyout</span>(pagetable, sp, argv[argc], <span style="color:#a6e22e">strlen</span>(argv[argc]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Â∞ÜÂèÇÊï∞Â≠óÁ¨¶‰∏≤Â§çÂà∂Âà∞Áî®Êà∑Ê†àÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ustack[argc] <span style="color:#f92672">=</span> sp; <span style="color:#75715e">// ‰øùÂ≠òÂèÇÊï∞Â≠óÁ¨¶‰∏≤ÁöÑÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  ustack[argc] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ‰ª• 0 ÁªìÊùüÂèÇÊï∞Êï∞ÁªÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â∞Ü argv[] ÊåáÈíàÊï∞ÁªÑÊé®ÂÖ•Ê†à
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sp <span style="color:#f92672">-=</span> (argc <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(uint64); <span style="color:#75715e">// ‰∏∫ argv ÊåáÈíàÊï∞ÁªÑÂàÜÈÖçÁ©∫Èó¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  sp <span style="color:#f92672">-=</span> sp <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span>; <span style="color:#75715e">// Á°Æ‰øùÊ†àÊåáÈíàÊòØ 16 Â≠óËäÇÂØπÈΩê
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(sp <span style="color:#f92672">&lt;</span> stackbase)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Ê†àÊåáÈíàË∂ÖÂá∫Ê†àÂü∫ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">copyout</span>(pagetable, sp, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)ustack, (argc <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(uint64)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> bad; <span style="color:#75715e">// Â§çÂà∂ argv ÊåáÈíàÊï∞ÁªÑÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÂáÜÂ§áÁî®Êà∑‰∏ªÂáΩÊï∞ÁöÑÂèÇÊï∞ (argc, argv)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// argc Â∞ÜÈÄöËøáÁ≥ªÁªüË∞ÉÁî®ËøîÂõûÂÄºÊîæÂÖ• a0 ‰∏≠
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>a1 <span style="color:#f92672">=</span> sp; <span style="color:#75715e">// Â∞ÜÊ†àÊåáÈíàËµãÂÄºÁªô trapframe
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ‰øùÂ≠òÁ®ãÂ∫èÂêçÁß∞‰ª•‰æøË∞ÉËØï
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(last <span style="color:#f92672">=</span> s <span style="color:#f92672">=</span> path; <span style="color:#f92672">*</span>s; s<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>s <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>      last <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// ÊâæÂà∞Ë∑ØÂæÑ‰∏≠ÁöÑÊúÄÂêé‰∏Ä‰∏™ÊñúÊù†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">safestrcpy</span>(p<span style="color:#f92672">-&gt;</span>name, last, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>name)); <span style="color:#75715e">// Â§çÂà∂Á®ãÂ∫èÂêçÁß∞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Êèê‰∫§Áî®Êà∑Êò†ÂÉè
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  oldpagetable <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>pagetable; <span style="color:#75715e">// ‰øùÂ≠òÊóßÁöÑÈ°µË°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> pagetable; <span style="color:#75715e">// Êõ¥Êñ∞ÂΩìÂâçËøõÁ®ãÁöÑÈ°µË°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> sz; <span style="color:#75715e">// Êõ¥Êñ∞ËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>epc <span style="color:#f92672">=</span> elf.entry; <span style="color:#75715e">// ËÆæÁΩÆÂàùÂßãÁ®ãÂ∫èËÆ°Êï∞Âô®‰∏∫ ELF ÂÖ•Âè£ÁÇπ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>sp <span style="color:#f92672">=</span> sp; <span style="color:#75715e">// ËÆæÁΩÆÂàùÂßãÊ†àÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">proc_freepagetable</span>(oldpagetable, oldsz); <span style="color:#75715e">// ÈáäÊîæÊóßÁöÑÈ°µË°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> argc; <span style="color:#75715e">// ËøîÂõûÂèÇÊï∞‰∏™Êï∞ÔºåÊîæÂÖ• a0Ôºå‰Ωú‰∏∫ main(argc, argv) ÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span> bad:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈîôËØØÂ§ÑÁêÜÈÉ®ÂàÜ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(pagetable)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proc_freepagetable</span>(pagetable, sz); <span style="color:#75715e">// ÈáäÊîæÂ∑≤ÂàÜÈÖçÁöÑÈ°µË°®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(ip){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">iunlockput</span>(ip); <span style="color:#75715e">// Ëß£ÈîÅÂπ∂ÈáäÊîæ inode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">end_op</span>(); <span style="color:#75715e">// ÁªìÊùüÊñá‰ª∂Êìç‰Ωú
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// ËøîÂõû -1 Ë°®Á§∫Â§±Ë¥•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><code>uvmalloc()</code></p>
<p><code>loadseg()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Â∞ÜÁ®ãÂ∫èÊÆµÂä†ËΩΩÂà∞ÊåáÂÆöÁöÑÈ°µË°®‰∏≠ÔºåËôöÊãüÂú∞ÂùÄ‰∏∫ va„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// va ÂøÖÈ°ªÊòØÈ°µÂØπÈΩêÁöÑÔºå‰∏î‰ªé va Âà∞ va+sz ÁöÑÈ°µÂøÖÈ°ªÂ∑≤ÁªèÊò†Â∞Ñ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÊàêÂäüÊó∂ËøîÂõû 0ÔºåÂ§±Ë¥•Êó∂ËøîÂõû -1„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">loadseg</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, <span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>ip, uint offset, uint sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint i, n;       <span style="color:#75715e">// Âæ™ÁéØÂèòÈáè i ÂíåÊØèÈ°µË¶ÅËØªÂèñÁöÑÂ≠óËäÇÊï∞ n
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 pa;      <span style="color:#75715e">// Êò†Â∞ÑÂà∞ÁöÑÁâ©ÁêÜÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ê£ÄÊü•ËôöÊãüÂú∞ÂùÄÊòØÂê¶ÊòØÈ°µÂØπÈΩêÁöÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((va <span style="color:#f92672">%</span> PGSIZE) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;loadseg: va must be page aligned&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ÈÅçÂéÜÊØè‰∏™È°µÔºå‰ªéËôöÊãüÂú∞ÂùÄ va ÂºÄÂßãÔºåÁõ¥Âà∞Âä†ËΩΩÁöÑÂ§ßÂ∞è sz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; i <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçËôöÊãüÂú∞ÂùÄÂØπÂ∫îÁöÑÁâ©ÁêÜÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">walkaddr</span>(pagetable, va <span style="color:#f92672">+</span> i);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Â¶ÇÊûúÁâ©ÁêÜÂú∞ÂùÄ‰∏∫ 0ÔºåË°®Á§∫ÂØπÂ∫îÁöÑÈ°µ‰∏çÂ≠òÂú®ÔºåËß¶Âèë panic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(pa <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;loadseg: address should exist&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Á°ÆÂÆöË¶ÅËØªÂèñÁöÑÂ≠óËäÇÊï∞
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(sz <span style="color:#f92672">-</span> i <span style="color:#f92672">&lt;</span> PGSIZE)
</span></span><span style="display:flex;"><span>      n <span style="color:#f92672">=</span> sz <span style="color:#f92672">-</span> i; <span style="color:#75715e">// Â¶ÇÊûúÂâ©‰ΩôÁöÑÂ≠óËäÇÊï∞Â∞è‰∫é‰∏ÄÈ°µÔºåÂàôÂè™ËØªÂèñÂâ©‰ΩôÁöÑÂ≠óËäÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      n <span style="color:#f92672">=</span> PGSIZE; <span style="color:#75715e">// Âê¶ÂàôËØªÂèñ‰∏ÄÊï¥È°µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ‰ªé inode ‰∏≠ËØªÂèñÊï∞ÊçÆÂà∞Áâ©ÁêÜÂÜÖÂ≠ò‰∏≠
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">readi</span>(ip, <span style="color:#ae81ff">0</span>, (uint64)pa, offset<span style="color:#f92672">+</span>i, n) <span style="color:#f92672">!=</span> n)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// Â¶ÇÊûúËØªÂèñÁöÑÂ≠óËäÇÊï∞‰∏çÁ≠â‰∫é nÔºåËøîÂõû -1 Ë°®Á§∫Â§±Ë¥•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ÊàêÂäüÂä†ËΩΩÊâÄÊúâÈ°µÔºåËøîÂõû 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>print user page table for <code>sh</code></p>
<p>Q: what is entry 2?</p>
<p>a process calls <code>sbrk(n)</code> to ask for n more bytes of heap memory
<code>user/umalloc.c</code> calls <code>sbrk()</code> to get memory for the allocator
each process has a size
kernel adds new memory at process&rsquo;s end, increases size
<code>sbrk()</code> allocates physical memory (RAM)
maps it into the process&rsquo;s page table
returns the starting address of the new memory</p>
<ul>
<li><code>growproc()</code> in <code>proc.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Â¢ûÂä†ÊàñÂáèÂ∞ëÁî®Êà∑ÂÜÖÂ≠ò n Â≠óËäÇ„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ÊàêÂäüÊó∂ËøîÂõû 0ÔºåÂ§±Ë¥•Êó∂ËøîÂõû -1„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">growproc</span>(<span style="color:#66d9ef">int</span> n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint sz; <span style="color:#75715e">// ÂΩìÂâçËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>(); <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁªìÊûÑ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  sz <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>sz; <span style="color:#75715e">// Ëé∑ÂèñÂΩìÂâçËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){ <span style="color:#75715e">// Â¶ÇÊûú n ‰∏∫Ê≠£ÔºåË°®Á§∫Â¢ûÂä†ÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Â∞ùËØïÂàÜÈÖçÊñ∞ÁöÑÂÜÖÂ≠òÁ©∫Èó¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((sz <span style="color:#f92672">=</span> <span style="color:#a6e22e">uvmalloc</span>(p<span style="color:#f92672">-&gt;</span>pagetable, sz, sz <span style="color:#f92672">+</span> n)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Â¶ÇÊûúÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû -1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){ <span style="color:#75715e">// Â¶ÇÊûú n ‰∏∫Ë¥üÔºåË°®Á§∫ÂáèÂ∞ëÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Â∞ùËØïÈáäÊîæÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sz <span style="color:#f92672">=</span> <span style="color:#a6e22e">uvmdealloc</span>(p<span style="color:#f92672">-&gt;</span>pagetable, sz, sz <span style="color:#f92672">+</span> n);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ê≥®ÊÑèÔºöÊ≠§Â§ÑÊ≤°ÊúâÊ£ÄÊü• uvmdealloc ÁöÑËøîÂõûÂÄºÔºåÂÅáËÆæÂÖ∂ÊàêÂäü
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> sz; <span style="color:#75715e">// Êõ¥Êñ∞ÂΩìÂâçËøõÁ®ãÁöÑÂÜÖÂ≠òÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ËøîÂõû 0 Ë°®Á§∫ÊàêÂäü
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><code>proc-&gt;sz</code> is the process&rsquo;s current size
<code>uvmalloc()</code> does most of the work
when switching to user space <code>satp</code> will be loaded with updated page table</p>
<ul>
<li><code>uvmalloc()</code> in <code>vm.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ‰∏∫ËøõÁ®ãÂàÜÈÖçÈ°µË°®È°πÂíåÁâ©ÁêÜÂÜÖÂ≠òÔºåÂ∞ÜËøõÁ®ã‰ªé oldsz Êâ©Â±ïÂà∞ newsz„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// newsz ‰∏çÈúÄË¶ÅÈ°µÂØπÈΩê„ÄÇÊàêÂäüÊó∂ËøîÂõûÊñ∞Â§ßÂ∞èÔºåÂ§±Ë¥•Êó∂ËøîÂõû 0„ÄÇ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmalloc</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 oldsz, uint64 newsz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem; <span style="color:#75715e">// Áî®‰∫éÂ≠òÂÇ®ÂàÜÈÖçÁöÑÂÜÖÂ≠òÊåáÈíà
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 a;  <span style="color:#75715e">// Âæ™ÁéØÂèòÈáèÔºåÁî®‰∫éÈÅçÂéÜÂàÜÈÖçÁöÑÂÜÖÂ≠òÂú∞ÂùÄ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â¶ÇÊûúÊñ∞ÁöÑÂ§ßÂ∞èÂ∞è‰∫éÊóßÁöÑÂ§ßÂ∞èÔºåÁõ¥Êé•ËøîÂõûÊóßÁöÑÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(newsz <span style="color:#f92672">&lt;</span> oldsz)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> oldsz;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â∞ÜÊóßÂ§ßÂ∞èÂêë‰∏äÂØπÈΩêÂà∞‰∏ã‰∏Ä‰∏™È°µËæπÁïå
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  oldsz <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDUP</span>(oldsz);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ‰ªéÊóßÂ§ßÂ∞èÂºÄÂßãÔºåÈÄêÈ°µÂàÜÈÖçÂÜÖÂ≠òÁõ¥Âà∞Êñ∞ÁöÑÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(a <span style="color:#f92672">=</span> oldsz; a <span style="color:#f92672">&lt;</span> newsz; a <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ÂàÜÈÖç‰∏ÄÈ°µÁâ©ÁêÜÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(mem <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Â¶ÇÊûúÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåÈáäÊîæÂ∑≤ÁªèÂàÜÈÖçÁöÑÂÜÖÂ≠òÂπ∂ËøîÂõû 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">uvmdealloc</span>(pagetable, a, oldsz);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Â∞ÜÂàÜÈÖçÁöÑÂÜÖÂ≠òÂàùÂßãÂåñ‰∏∫ 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(mem, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Â∞ÜÂàÜÈÖçÁöÑÁâ©ÁêÜÂÜÖÂ≠òÊò†Â∞ÑÂà∞ËøõÁ®ãÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, a, PGSIZE, (uint64)mem, PTE_W<span style="color:#f92672">|</span>PTE_X<span style="color:#f92672">|</span>PTE_R<span style="color:#f92672">|</span>PTE_U) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Â¶ÇÊûúÊò†Â∞ÑÂ§±Ë¥•ÔºåÈáäÊîæÁâ©ÁêÜÂÜÖÂ≠òÂπ∂ÈáäÊîæÂ∑≤ÂàÜÈÖçÁöÑÂÜÖÂ≠ò
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">uvmdealloc</span>(pagetable, a, oldsz);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Â¶ÇÊûúÊâÄÊúâÁöÑÂÜÖÂ≠òÈÉΩÊàêÂäüÂàÜÈÖçÂíåÊò†Â∞ÑÔºåËøîÂõûÊñ∞ÁöÑÂ§ßÂ∞è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> newsz;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>why PGROUNDUP?
arguments to <code>mappages()</code>&hellip;</p>
<h2 id="lab-page-tableshttpspdoscsailmitedu6s0812020labspgtblhtml"><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/pgtbl.html">Lab: page tables</a><a hidden class="anchor" aria-hidden="true" href="#lab-page-tableshttpspdoscsailmitedu6s0812020labspgtblhtml">#</a></h2>
<h3 id="print-a-page-table-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">Print a page table (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">easy</a>)<a hidden class="anchor" aria-hidden="true" href="#print-a-page-table-easyhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<p>Define a function called <code>vmprint()</code>. It should take a <code>pagetable_t</code> argument, and print that <code>pagetable</code> in the format described below. Insert <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code> in <code>exec.c</code> just before the <code>return argc</code>, to print the first process&rsquo;s page table. You receive full credit for this assignment if you pass the <code>pte printout</code> test of <code>make grade</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vmprint_rec</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, <span style="color:#66d9ef">int</span> level)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pte_t</span> pte <span style="color:#f92672">=</span> pagetable[i];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>            uint64 pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(pte);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;=</span> level; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(j <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;..&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d: pte %p pa %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, i, pte, pa);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((pte <span style="color:#f92672">&amp;</span> (PTE_R <span style="color:#f92672">|</span> PTE_W <span style="color:#f92672">|</span> PTE_X)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Recursively print next level page table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">vmprint_rec</span>((<span style="color:#66d9ef">pagetable_t</span>)pa, level <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vmprint</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;page table %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pagetable);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vmprint_rec</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>pid = 1</code>‰ª£Ë°®<code>init</code>ËøõÁ®ãÔºåÂç≥Á¨¨‰∏Ä‰∏™ÂêØÂä®ÁöÑÁî®Êà∑Á∫ßËøõÁ®ãÔºåÂÆÉË¥üË¥£Ê¥æÁîüÂÖ∂‰ªñËøõÁ®ãÂπ∂‰∏∫Á≥ªÁªüÊèê‰æõÂü∫Êú¨ÊúçÂä°„ÄÇ</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912100822246.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912100822246.png" alt="image-20240912100822246"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912095642463.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912095642463.png" alt="image-20240912095642463"  />
        </a>
    </div>
</p>
<h3 id="a-kernel-page-table-per-process-hardhttpspdoscsailmitedu6s0812020labsguidancehtml">A kernel page table per process (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)<a hidden class="anchor" aria-hidden="true" href="#a-kernel-page-table-per-process-hardhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<h4 id="proch">proc.h<a hidden class="anchor" aria-hidden="true" href="#proch">#</a></h4>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912101240078.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912101240078.png" alt="image-20240912101240078"  />
        </a>
    </div>
</p>
<h4 id="procc">proc.c<a hidden class="anchor" aria-hidden="true" href="#procc">#</a></h4>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102655957.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102655957.png" alt="image-20240912102655957"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102608937.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102608937.png" alt="image-20240912102608937"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102725496.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102725496.png" alt="image-20240912102725496"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102813256.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102813256.png" alt="image-20240912102813256"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102824791.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912102824791.png" alt="image-20240912102824791"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103723550.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103723550.png" alt="image-20240912103723550"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103745419.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103745419.png" alt="image-20240912103745419"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103836503.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103836503.png" alt="image-20240912103836503"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103932712.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103932712.png" alt="image-20240912103932712"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103948899.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912103948899.png" alt="image-20240912103948899"  />
        </a>
    </div>
</p>
<h4 id="vmc">vm.c<a hidden class="anchor" aria-hidden="true" href="#vmc">#</a></h4>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104113266.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104113266.png" alt="image-20240912104113266"  />
        </a>
    </div>
</p>
<h4 id="defsh">defs.h<a hidden class="anchor" aria-hidden="true" href="#defsh">#</a></h4>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104155220.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104155220.png" alt="image-20240912104155220"  />
        </a>
    </div>
</p>
<h3 id="simplify-copyincopyinstr-hardhttpspdoscsailmitedu6s0812020labsguidancehtml">Simplify <code>copyin/copyinstr</code> (<a href="https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html">hard</a>)<a hidden class="anchor" aria-hidden="true" href="#simplify-copyincopyinstr-hardhttpspdoscsailmitedu6s0812020labsguidancehtml">#</a></h3>
<h4 id="defsh-1">defs.h<a hidden class="anchor" aria-hidden="true" href="#defsh-1">#</a></h4>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104227988.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104227988.png" alt="image-20240912104227988"  />
        </a>
    </div>
</p>
<h4 id="vmc-1">vm.c<a hidden class="anchor" aria-hidden="true" href="#vmc-1">#</a></h4>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104249429.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104249429.png" alt="image-20240912104249429"  />
        </a>
    </div>
</p>
<p>






    <div class="post-img-view">
        <a data-fancybox="gallery" href="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104532024.png">
            <img src="https://raw.githubusercontent.com/Kennems/blog-image/main/image-20240912104532024.png" alt="image-20240912104532024"  />
        </a>
    </div>
</p>
<h2 id="q--a">Q &amp; A<a hidden class="anchor" aria-hidden="true" href="#q--a">#</a></h2>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kennems.github.io/tags/mit6.s081/">MIT6.S081</a></li>
    </ul>
        
    
    <ul id="categories">
      
        <li><a href="https://kennems.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">Êìç‰ΩúÁ≥ªÁªü</a> </li>
      
    </ul>
    
    
<nav class="paginav">
  <a class="prev" href="https://kennems.github.io/posts/tech/c-%E8%AF%AD%E8%A8%80%E6%8C%87%E9%92%88/">
    <span class="title">¬´ ‰∏ä‰∏ÄÈ°µ</span>
    <br>
    <span>C ËØ≠Ë®ÄÊåáÈíà</span>
  </a>
  <a class="next" href="https://kennems.github.io/posts/read/%E8%82%A1%E7%A5%A8/">
    <span class="title">‰∏ã‰∏ÄÈ°µ ¬ª</span>
    <br>
    <span>ËÇ°Á•®</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://kennems.github.io/">Kennem&#39;s Blog</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Â§çÂà∂';

        function copyingDone() {
            copybutton.innerHTML = 'Â∑≤Â§çÂà∂ÔºÅ';
            setTimeout(() => {
                copybutton.innerHTML = 'Â§çÂà∂';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
<footer class="footer">
    <script async src="https://busuanzi.sukap.cn/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        Visitors: <span id="busuanzi_value_page_uv"></span>
        Views: <span id="busuanzi_value_page_pv"></span>

        
    </span>
</footer>



</body>

</html>
