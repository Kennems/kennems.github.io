<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">

<meta name="msvalidate.01" content="DF5FE493CC759E62BFE073BEA8EFD472" />
<title>Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜ | Kennem&#39;s Blog</title>
<meta name="keywords" content="GoLang">
<meta name="description" content="Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">
<meta name="author" content="ShowGuan">
<link rel="canonical" href="https://kennems.github.io/posts/tech/go-3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.1a7bc7e6d01b82c8ca2b2e53cfcf7e33d2fd9058f6b28245f94da0d91447c6a0.css" integrity="sha256-GnvH5tAbgsjKKy5Tz89&#43;M9L9kFj2soJF&#43;U2g2RRHxqA=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://kennems.github.io/img/sun.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kennems.github.io/img/sun.png">
<link rel="apple-touch-icon" href="https://kennems.github.io/img/sun.png">
<link rel="mask-icon" href="https://kennems.github.io/img/sun.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://kennems.github.io/posts/tech/go-3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>


<link rel="stylesheet" href="https://fonts.cdnfonts.com/css/code-new-roman">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

<meta property="og:url" content="https://kennems.github.io/posts/tech/go-3/">
  <meta property="og:site_name" content="Kennem&#39;s Blog">
  <meta property="og:title" content="Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">
  <meta property="og:description" content="Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-01-25T15:37:01+08:00">
    <meta property="article:modified_time" content="2025-01-25T15:37:01+08:00">
    <meta property="article:tag" content="GoLang">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">
<meta name="twitter:description" content="Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://kennems.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ’»æŠ€æœ¯",
      "item": "https://kennems.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜",
      "item": "https://kennems.github.io/posts/tech/go-3/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜",
  "name": "Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜",
  "description": "Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜",
  "keywords": [
    "GoLang"
  ],
  "articleBody": "Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜ æœ¬æ–‡æ·±å…¥æ¢è®¨ Go è¯­è¨€çš„é«˜è´¨é‡ç¼–ç¨‹å’Œæ€§èƒ½è°ƒä¼˜ï¼Œç»“åˆå…·ä½“ç¤ºä¾‹ï¼Œå¸®åŠ©ä½ ç¼–å†™æ­£ç¡®å¯é ã€ç®€æ´æ¸…æ™°çš„ä»£ç ï¼Œå¹¶æŒæ¡æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ–¹æ³•ã€‚\n01 é«˜è´¨é‡ç¼–ç¨‹ é«˜è´¨é‡ä»£ç çš„ç›®æ ‡æ˜¯æ­£ç¡®å¯é ã€ç®€æ´æ¸…æ™°ã€‚ä»¥ä¸‹æ˜¯å®ç°é«˜è´¨é‡ç¼–ç¨‹çš„å…³é”®ç‚¹ã€‚\n1.1 ç¼–ç¨‹åŸåˆ™ ç®€å•æ€§ï¼šä»£ç é€»è¾‘ç®€å•ï¼Œæ˜“äºç†è§£ã€‚ å¯è¯»æ€§ï¼šä»£ç æ˜“äºé˜…è¯»ï¼Œå‘½åæ¸…æ™°ï¼Œç»“æ„åˆç†ã€‚ ç”Ÿäº§åŠ›ï¼šä»£ç æ˜“äºç»´æŠ¤å’Œæ‰©å±•ï¼Œå‡å°‘é‡å¤åŠ³åŠ¨ã€‚ 1.2 ç¼–ç è§„èŒƒ 1.2.1 ä»£ç æ ¼å¼ ä½¿ç”¨ gofmt å’Œ goimports è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ã€‚ ä¿æŒä¸€è‡´çš„ä»£ç é£æ ¼ã€‚ ç¤ºä¾‹ï¼šæ ¼å¼åŒ–ä»£ç \n# ä½¿ç”¨ gofmt æ ¼å¼åŒ–ä»£ç  gofmt -w main.go # ä½¿ç”¨ goimports è‡ªåŠ¨æ·»åŠ å’Œåˆ é™¤å¯¼å…¥ goimports -w main.go 1.2.2 æ³¨é‡Š æ³¨é‡Šå†…å®¹ï¼š è§£é‡Šä»£ç çš„ä½œç”¨ã€‚ è§£é‡Šä»£ç çš„å®ç°é€»è¾‘ã€‚ è§£é‡Šä»£ç çš„è®¾è®¡åŸå› ã€‚ è§£é‡Šä»£ç å¯èƒ½å‡ºé”™çš„æƒ…å†µã€‚ æ³¨é‡ŠåŸåˆ™ï¼š ä»£ç æ˜¯æœ€å¥½çš„æ³¨é‡Šã€‚ æ³¨é‡Šåº”æä¾›ä»£ç æœªè¡¨è¾¾çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ ç¤ºä¾‹ï¼šæ³¨é‡Š\n// CalculateSum è®¡ç®—ä¸¤ä¸ªæ•´æ•°çš„å’Œã€‚ // å¦‚æœè¾“å…¥ä¸ºè´Ÿæ•°ï¼Œè¿”å›é”™è¯¯ã€‚ func CalculateSum(a, b int) (int, error) { if a \u003c 0 || b \u003c 0 { return 0, fmt.Errorf(\"negative input not allowed\") } return a + b, nil } 1.2.3 å‘½åè§„èŒƒ å˜é‡åï¼š ç®€æ´èƒœäºå†—é•¿ã€‚ ç¼©ç•¥è¯å…¨å¤§å†™ï¼ˆå¦‚ HTTPï¼‰ï¼Œä½äºå˜é‡å¼€å¤´ä¸”ä¸éœ€è¦å¯¼å‡ºæ—¶ä½¿ç”¨å…¨å°å†™ï¼ˆå¦‚ httpClientï¼‰ã€‚ å˜é‡è·ç¦»ä½¿ç”¨å¤„è¶Šè¿œï¼Œå‘½ååº”åŒ…å«è¶Šå¤šä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ å‡½æ•°åï¼š å‡½æ•°ååº”ç®€çŸ­ï¼Œä¸æºå¸¦åŒ…åä¸Šä¸‹æ–‡ã€‚ å½“å‡½æ•°è¿”å›ç±»å‹ä¸åŒ…åç›¸åŒæ—¶ï¼Œå¯çœç•¥ç±»å‹ä¿¡æ¯ï¼ˆå¦‚ foo.New() è¿”å› Fooï¼‰ã€‚ å½“å‡½æ•°è¿”å›ç±»å‹ä¸åŒ…åä¸åŒæ—¶ï¼Œåº”åœ¨å‡½æ•°åä¸­åŠ å…¥ç±»å‹ä¿¡æ¯ï¼ˆå¦‚ foo.NewBar()ï¼‰ã€‚ åŒ…åï¼š åªä½¿ç”¨å°å†™å­—æ¯ï¼Œä¸åŒ…å«å¤§å†™å­—æ¯æˆ–ä¸‹åˆ’çº¿ã€‚ ç®€çŸ­ä¸”åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚ schemaã€taskï¼‰ã€‚ é¿å…ä¸æ ‡å‡†åº“åŒåï¼ˆå¦‚ syncã€stringsï¼‰ã€‚ ä½¿ç”¨å•æ•°å½¢å¼ï¼ˆå¦‚ log è€Œä¸æ˜¯ logsï¼‰ã€‚ è°¨æ…ä½¿ç”¨ç¼©å†™ã€‚ ç¤ºä¾‹ï¼šå‘½åè§„èŒƒ\n// å˜é‡å var maxRetryCount int var httpClient *http.Client // å‡½æ•°å func NewUser() *User { return \u0026User{} } func NewUserFromDB(db *DB) *User { return \u0026User{db: db} } // åŒ…å package user package task 1.2.4 æ§åˆ¶æµç¨‹ é¿å…åµŒå¥—ï¼Œä¿æŒæ­£å¸¸æµç¨‹æ¸…æ™°ã€‚ å°½é‡ä¿æŒæ­£å¸¸ä»£ç è·¯å¾„ä¸ºæœ€å°ç¼©è¿›ã€‚ ç¤ºä¾‹ï¼šæ§åˆ¶æµç¨‹ä¼˜åŒ–\n// ä¸æ¨èï¼šåµŒå¥—è¿‡æ·± func process(data []int) { if len(data) \u003e 0 { for _, item := range data { if item \u003e 10 { fmt.Println(item) } } } } // æ¨èï¼šå‡å°‘åµŒå¥— func process(data []int) { if len(data) == 0 { return } for _, item := range data { if item \u003c= 10 { continue } fmt.Println(item) } } 1.2.5 é”™è¯¯å’Œå¼‚å¸¸å¤„ç† ç®€å•é”™è¯¯ï¼šä½¿ç”¨ errors.New æˆ– fmt.Errorf åˆ›å»ºé”™è¯¯ã€‚ é”™è¯¯åŒ…è£…ï¼šä½¿ç”¨ fmt.Errorf å’Œ %w åŒ…è£…é”™è¯¯ï¼Œä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯ã€‚ é”™è¯¯åˆ¤å®šï¼šä½¿ç”¨ errors.Is å’Œ errors.As åˆ¤æ–­é”™è¯¯ç±»å‹ã€‚ Panicï¼šä¸å»ºè®®åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨ panicï¼Œä»…åœ¨ä¸å¯æ¢å¤çš„é”™è¯¯ä¸­ä½¿ç”¨ã€‚ Recoverï¼šåªèƒ½åœ¨ defer å‡½æ•°ä¸­ä½¿ç”¨ recoverï¼Œç”¨äºæ•è· panicã€‚ é”™è¯¯ä¿¡æ¯ï¼šé”™è¯¯åº”æä¾›ç®€æ˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯é“¾ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜ã€‚ ç¤ºä¾‹ï¼šé”™è¯¯å¤„ç†\nfunc readFile(filename string) ([]byte, error) { data, err := os.ReadFile(filename) if err != nil { return nil, fmt.Errorf(\"failed to read file: %w\", err) } return data, nil } func main() { defer func() { if r := recover(); r != nil { fmt.Println(\"Recovered from panic:\", r) } }() panic(\"something went wrong\") } 02 æ€§èƒ½è°ƒä¼˜å®æˆ˜ æ€§èƒ½è°ƒä¼˜çš„æ ¸å¿ƒåŸåˆ™æ˜¯ä¾é æ•°æ®ï¼Œå®šä½ç“¶é¢ˆï¼Œé¿å…è¿‡æ—©å’Œè¿‡åº¦ä¼˜åŒ–ã€‚\n2.1 æ€§èƒ½è°ƒä¼˜åŸåˆ™ ä¾é æ•°æ®ï¼šé€šè¿‡æ€§èƒ½åˆ†æå·¥å…·ï¼ˆå¦‚ pprofï¼‰è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯çŒœæµ‹ã€‚ å®šä½ç“¶é¢ˆï¼šä¼˜å…ˆä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆï¼Œè€Œä¸æ˜¯ç»†ææœ«èŠ‚ã€‚ é¿å…è¿‡æ—©ä¼˜åŒ–ï¼šåœ¨ä»£ç ç¨³å®šåå†è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚ é¿å…è¿‡åº¦ä¼˜åŒ–ï¼šä¼˜åŒ–åº”ä»¥æ»¡è¶³æ€§èƒ½éœ€æ±‚ä¸ºç›®æ ‡ï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–ä»£ç ã€‚ 2.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§ 2.2.1 Slice ä¼˜åŒ– é¢„åˆ†é…å†…å­˜ï¼šä½¿ç”¨ make åˆå§‹åŒ–åˆ‡ç‰‡æ—¶æä¾›å®¹é‡ä¿¡æ¯ï¼Œé¿å…å¤šæ¬¡å†…å­˜åˆ†é…ã€‚ ç¤ºä¾‹ï¼šSlice é¢„åˆ†é…\n// ä¸æ¨èï¼šæœªé¢„åˆ†é…å†…å­˜ var s []int for i := 0; i \u003c 100; i++ { s = append(s, i) } // æ¨èï¼šé¢„åˆ†é…å†…å­˜ s := make([]int, 0, 100) for i := 0; i \u003c 100; i++ { s = append(s, i) } 2.2.2 Map ä¼˜åŒ– é¢„åˆ†é…å†…å­˜ï¼šä½¿ç”¨ make åˆå§‹åŒ– map æ—¶æä¾›å®¹é‡ä¿¡æ¯ã€‚ ç¤ºä¾‹ï¼šMap é¢„åˆ†é…\n// ä¸æ¨èï¼šæœªé¢„åˆ†é…å†…å­˜ m := make(map[string]int) for i := 0; i \u003c 100; i++ { m[fmt.Sprintf(\"key%d\", i)] = i } // æ¨èï¼šé¢„åˆ†é…å†…å­˜ m := make(map[string]int, 100) for i := 0; i \u003c 100; i++ { m[fmt.Sprintf(\"key%d\", i)] = i } 2.2.3 å­—ç¬¦ä¸²å¤„ç† ä½¿ç”¨ strings.Builderï¼šstrings.Builder æ¯” + æ‹¼æ¥æ€§èƒ½æ›´å¥½ï¼Œä¸ bytes.Buffer æ€§èƒ½ç›¸è¿‘ä½†æ›´å¿«ã€‚ ç¤ºä¾‹ï¼šå­—ç¬¦ä¸²æ‹¼æ¥\n// ä¸æ¨èï¼šä½¿ç”¨ + æ‹¼æ¥ var s string for i := 0; i \u003c 100; i++ { s += fmt.Sprintf(\"%d\", i) } // æ¨èï¼šä½¿ç”¨ strings.Builder var builder strings.Builder for i := 0; i \u003c 100; i++ { builder.WriteString(fmt.Sprintf(\"%d\", i)) } result := builder.String() 2.2.4 ç©ºç»“æ„ä½“ èŠ‚çœå†…å­˜ï¼šä½¿ç”¨ç©ºç»“æ„ä½“ struct{} ä½œä¸ºå ä½ç¬¦ï¼Œä¸å ç”¨å†…å­˜ã€‚ ç¤ºä¾‹ï¼šç©ºç»“æ„ä½“\n// ä½¿ç”¨ç©ºç»“æ„ä½“ä½œä¸ºå ä½ç¬¦ set := make(map[string]struct{}) set[\"key1\"] = struct{}{} set[\"key2\"] = struct{}{} 2.2.5 Atomic åŒ… åŸå­æ“ä½œï¼šä½¿ç”¨ sync/atomic åŒ…å®ç°æ— é”å¹¶å‘æ“ä½œã€‚ ç¤ºä¾‹ï¼šAtomic æ“ä½œ\nvar counter int64 for i := 0; i \u003c 100; i++ { go func() { atomic.AddInt64(\u0026counter, 1) }() } time.Sleep(time.Second) fmt.Println(\"Counter:\", counter) 2.3 æ€§èƒ½åˆ†æå·¥å…· pprof pprof æ˜¯ Go å†…ç½®çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œæ”¯æŒä»¥ä¸‹ç»´åº¦çš„åˆ†æï¼š\n2.3.1 CPU åˆ†æ é‡‡æ ·å¯¹è±¡ï¼šå‡½æ•°è°ƒç”¨åŠå…¶è€—æ—¶ã€‚ é‡‡æ ·ç‡ï¼šæ¯ç§’ 100 æ¬¡ã€‚ é‡‡æ ·æ—¶é—´ï¼šæ‰‹åŠ¨å¯åŠ¨åˆ°æ‰‹åŠ¨ç»“æŸã€‚ ç¤ºä¾‹ï¼šCPU åˆ†æ\nimport ( \"os\" \"runtime/pprof\" ) func main() { f, _ := os.Create(\"cpu.prof\") pprof.StartCPUProfile(f) defer pprof.StopCPUProfile() // ä¸šåŠ¡ä»£ç  for i := 0; i \u003c 1000000; i++ { _ = i * i } } 2.3.2 Heap åˆ†æ é‡‡æ ·å¯¹è±¡ï¼šå †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚ é‡‡æ ·ç‡ï¼šæ¯åˆ†é… 512KB è®°å½•ä¸€æ¬¡ã€‚ é‡‡æ ·æŒ‡æ ‡ï¼š alloc_spaceï¼šåˆ†é…çš„å†…å­˜æ€»é‡ã€‚ alloc_objectsï¼šåˆ†é…çš„å¯¹è±¡æ•°é‡ã€‚ inuse_spaceï¼šæ­£åœ¨ä½¿ç”¨çš„å†…å­˜é‡ã€‚ inuse_objectsï¼šæ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡æ•°é‡ã€‚ ç¤ºä¾‹ï¼šHeap åˆ†æ\nimport ( \"os\" \"runtime/pprof\" ) func main() { f, _ := os.Create(\"heap.prof\") defer f.Close() // ä¸šåŠ¡ä»£ç  var s []int for i := 0; i \u003c 1000000; i++ { s = append(s, i) } pprof.WriteHeapProfile(f) } 2.3.3 Goroutine åˆ†æ é‡‡æ ·å¯¹è±¡ï¼šæ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ Goroutineã€‚ é‡‡æ ·æŒ‡æ ‡ï¼šGoroutine çš„æ•°é‡å’Œè°ƒç”¨æ ˆä¿¡æ¯ã€‚ ç¤ºä¾‹ï¼šGoroutine åˆ†æ\nimport ( \"os\" \"runtime/pprof\" ) func main() { f, _ := os.Create(\"goroutine.prof\") defer f.Close() // ä¸šåŠ¡ä»£ç  for i := 0; i \u003c 100; i++ { go func() { time.Sleep(time.Second) }() } pprof.Lookup(\"goroutine\").WriteTo(f, 1) } 2.3.4 Mutex åˆ†æ é‡‡æ ·å¯¹è±¡ï¼šé”ç«äº‰çš„æ¬¡æ•°å’Œè€—æ—¶ã€‚ é‡‡æ ·ç‡ï¼šåªè®°å½•å›ºå®šæ¯”ä¾‹çš„é”æ“ä½œã€‚ ç¤ºä¾‹ï¼šMutex åˆ†æ\nimport ( \"os\" \"runtime/pprof\" \"sync\" ) func main() { f, _ := os.Create(\"mutex.prof\") defer f.Close() var mu sync.Mutex var wg sync.WaitGroup for i := 0; i \u003c 100; i++ { wg.Add(1) go func() { defer wg.Done() mu.Lock() defer mu.Unlock() time.Sleep(time.Millisecond) }() } wg.Wait() pprof.Lookup(\"mutex\").WriteTo(f, 1) } 2.3.5 Block åˆ†æ é‡‡æ ·å¯¹è±¡ï¼šé˜»å¡æ“ä½œçš„æ¬¡æ•°å’Œè€—æ—¶ã€‚ é‡‡æ ·ç‡ï¼šé˜»å¡è€—æ—¶è¶…è¿‡é˜ˆå€¼çš„æ“ä½œæ‰ä¼šè¢«è®°å½•ã€‚ ç¤ºä¾‹ï¼šBlock åˆ†æ\nimport ( \"os\" \"runtime/pprof\" \"sync\" ) func main() { f, _ := os.Create(\"block.prof\") defer f.Close() var mu sync.Mutex var wg sync.WaitGroup for i := 0; i \u003c 100; i++ { wg.Add(1) go func() { defer wg.Done() mu.Lock() defer mu.Unlock() time.Sleep(time.Millisecond) }() } wg.Wait() pprof.Lookup(\"block\").WriteTo(f, 1) } 2.4 æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹ æ€§èƒ½è°ƒä¼˜çš„æ ¸å¿ƒåœ¨äºå®šä½ç“¶é¢ˆå¹¶é’ˆå¯¹æ€§åœ°ä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå…¸å‹çš„æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹ï¼Œç»“åˆå…·ä½“é—®é¢˜å’Œä¼˜åŒ–æ–¹æ³•ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨æ€§èƒ½è°ƒä¼˜æŠ€å·§ã€‚\n2.4.1 ä¸šåŠ¡æœåŠ¡ä¼˜åŒ– é—®é¢˜æè¿°\næŸä¸šåŠ¡æœåŠ¡çš„æ¥å£å“åº”æ—¶é—´è¾ƒé•¿ï¼Œç”¨æˆ·è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡ 500msï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸‹é™ã€‚\nåˆ†æè¿‡ç¨‹\nä½¿ç”¨ pprof è¿›è¡Œæ€§èƒ½åˆ†æï¼š\nå¯åŠ¨ pprof çš„ CPU å’Œ Heap åˆ†æï¼Œå‘ç°æ•°æ®åº“æŸ¥è¯¢å ç”¨äº† 70% çš„ CPU æ—¶é—´ã€‚ è¿›ä¸€æ­¥åˆ†æå‘ç°ï¼ŒæŸäº› SQL æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æ‰«æã€‚ å®šä½ç“¶é¢ˆï¼š\né€šè¿‡æ—¥å¿—å’Œ pprof æ•°æ®ï¼Œå®šä½åˆ°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š é«˜é¢‘æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•ã€‚ éƒ¨åˆ†æŸ¥è¯¢è¿”å›è¿‡å¤šæ— ç”¨æ•°æ®ã€‚ é‡å¤æŸ¥è¯¢ç›¸åŒæ•°æ®ã€‚ ä¼˜åŒ–æ–¹æ¡ˆ\nä¼˜åŒ– SQL æŸ¥è¯¢ï¼š\nä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•ã€‚ ä½¿ç”¨ SELECT åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œé¿å…è¿”å›è¿‡å¤šæ•°æ®ã€‚ ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼Œç¡®ä¿æŸ¥è¯¢æ•ˆç‡ã€‚ ç¤ºä¾‹ï¼šä¼˜åŒ– SQL æŸ¥è¯¢\n-- ä¼˜åŒ–å‰ SELECT * FROM users WHERE age \u003e 20; -- ä¼˜åŒ–å SELECT id, name FROM users WHERE age \u003e 20; CREATE INDEX idx_age ON users(age); å¼•å…¥ç¼“å­˜ï¼š\nä½¿ç”¨ Redis ç¼“å­˜é«˜é¢‘æŸ¥è¯¢ç»“æœï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ã€‚ è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ã€‚ ç¤ºä¾‹ï¼šä½¿ç”¨ Redis ç¼“å­˜\nfunc getUserFromCache(userID int) (*User, error) { var user User cacheKey := fmt.Sprintf(\"user:%d\", userID) err := redisClient.Get(cacheKey, \u0026user) if err == nil { return \u0026user, nil } // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ user, err := db.GetUser(userID) if err != nil { return nil, err } // å°†ç»“æœå†™å…¥ç¼“å­˜ redisClient.Set(cacheKey, user, time.Hour) return \u0026user, nil } ä¼˜åŒ–ç»“æœï¼š\næ¥å£å“åº”æ—¶é—´ä» 500ms é™ä½åˆ° 50msã€‚ æ•°æ®åº“ CPU ä½¿ç”¨ç‡ä» 70% é™ä½åˆ° 20%ã€‚ 2.4.2 åŸºç¡€åº“ä¼˜åŒ– é—®é¢˜æè¿°\næŸåŸºç¡€åº“åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½ä¸è¶³ï¼Œè¡¨ç°ä¸ºå†…å­˜åˆ†é…é¢‘ç¹ã€é”ç«äº‰æ¿€çƒˆï¼Œå¯¼è‡´æœåŠ¡ååé‡ä¸‹é™ã€‚\nåˆ†æè¿‡ç¨‹\nä½¿ç”¨ pprof è¿›è¡Œæ€§èƒ½åˆ†æï¼š\né€šè¿‡ Heap åˆ†æå‘ç°ï¼Œå¤§é‡å†…å­˜åˆ†é…æ¥è‡ªäºä¸´æ—¶å¯¹è±¡çš„åˆ›å»ºã€‚ é€šè¿‡ Mutex åˆ†æå‘ç°ï¼ŒæŸäº›é”çš„ç«äº‰éå¸¸æ¿€çƒˆã€‚ å®šä½ç“¶é¢ˆï¼š\né¢‘ç¹åˆ›å»ºå’Œé”€æ¯ä¸´æ—¶å¯¹è±¡ï¼Œå¯¼è‡´ GC å‹åŠ›å¤§ã€‚ é”ç«äº‰å¯¼è‡´ Goroutine é˜»å¡ï¼Œå½±å“å¹¶å‘æ€§èƒ½ã€‚ ä¼˜åŒ–æ–¹æ¡ˆ\nä½¿ç”¨ sync.Pool å‡å°‘å†…å­˜åˆ†é…ï¼š\né€šè¿‡å¯¹è±¡æ± å¤ç”¨ä¸´æ—¶å¯¹è±¡ï¼Œå‡å°‘å†…å­˜åˆ†é…å’Œ GC å‹åŠ›ã€‚ ç¤ºä¾‹ï¼šä½¿ç”¨ sync.Pool\nvar bufferPool = sync.Pool{ New: func() interface{} { return new(bytes.Buffer) }, } func getBuffer() *bytes.Buffer { return bufferPool.Get().(*bytes.Buffer) } func putBuffer(buf *bytes.Buffer) { buf.Reset() bufferPool.Put(buf) } ä½¿ç”¨ atomic å‡å°‘é”ç«äº‰ï¼š\nå°†éƒ¨åˆ†é”ä¿æŠ¤çš„æ“ä½œæ›¿æ¢ä¸ºåŸå­æ“ä½œï¼Œå‡å°‘é”ç«äº‰ã€‚ ç¤ºä¾‹ï¼šä½¿ç”¨ atomic\nvar counter int64 func incrementCounter() { atomic.AddInt64(\u0026counter, 1) } func getCounter() int64 { return atomic.LoadInt64(\u0026counter) } ä¼˜åŒ–ç»“æœï¼š\nå†…å­˜åˆ†é…å‡å°‘ 50%ï¼ŒGC å‹åŠ›æ˜¾è‘—é™ä½ã€‚ é”ç«äº‰å‡å°‘ï¼ŒæœåŠ¡ååé‡æå‡ 30%ã€‚ 2.4.3 Go è¯­è¨€ä¼˜åŒ– é—®é¢˜æè¿° æŸæœåŠ¡åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒGCï¼ˆåƒåœ¾å›æ”¶ï¼‰å‹åŠ›è¾ƒå¤§ï¼Œå¯¼è‡´æœåŠ¡å‡ºç°å‘¨æœŸæ€§å»¶è¿Ÿã€‚\nåˆ†æè¿‡ç¨‹\nä½¿ç”¨ pprof è¿›è¡Œæ€§èƒ½åˆ†æï¼š\né€šè¿‡ Heap åˆ†æå‘ç°ï¼Œå †å†…å­˜ä¸­å­˜åœ¨å¤§é‡çŸ­æœŸå¯¹è±¡ã€‚ é€šè¿‡ Goroutine åˆ†æå‘ç°ï¼ŒGoroutine æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´è°ƒåº¦å¼€é”€å¢åŠ ã€‚ å®šä½ç“¶é¢ˆï¼š\né¢‘ç¹åˆ›å»ºå’Œé”€æ¯çŸ­æœŸå¯¹è±¡ï¼Œå¯¼è‡´ GC é¢‘ç¹è§¦å‘ã€‚ Goroutine æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´è°ƒåº¦å™¨è´Ÿè½½è¿‡é«˜ã€‚ ä¼˜åŒ–æ–¹æ¡ˆ\nå‡å°‘å †å†…å­˜åˆ†é…ï¼š\nä½¿ç”¨æ ˆåˆ†é…ä»£æ›¿å †åˆ†é…ï¼Œå‡å°‘ GC å‹åŠ›ã€‚ å¤ç”¨å¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ã€‚ ç¤ºä¾‹ï¼šå¤ç”¨å¯¹è±¡\nvar userPool = sync.Pool{ New: func() interface{} { return new(User) }, } func getUser() *User { return userPool.Get().(*User) } func putUser(user *User) { user.Reset() userPool.Put(user) } æ§åˆ¶ Goroutine æ•°é‡ï¼š\nä½¿ç”¨ Goroutine æ± é™åˆ¶å¹¶å‘æ•°é‡ï¼Œé¿å… Goroutine æ•°é‡è¿‡å¤šã€‚ ç¤ºä¾‹ï¼šä½¿ç”¨ Goroutine æ± \nfunc workerPool(workerNum int, tasks \u003c-chan func()) { var wg sync.WaitGroup for i := 0; i \u003c workerNum; i++ { wg.Add(1) go func() { defer wg.Done() for task := range tasks { task() } }() } wg.Wait() } ä¼˜åŒ–ç»“æœï¼š\nGC é¢‘ç‡é™ä½ï¼ŒæœåŠ¡å»¶è¿Ÿå‡å°‘ã€‚ Goroutine æ•°é‡æ§åˆ¶åœ¨åˆç†èŒƒå›´ï¼Œè°ƒåº¦å¼€é”€é™ä½ã€‚ æ€»ç»“ é€šè¿‡ä»¥ä¸Šæ¡ˆä¾‹å¯ä»¥çœ‹å‡ºï¼Œæ€§èƒ½è°ƒä¼˜çš„å…³é”®åœ¨äºï¼š\nå®šä½ç“¶é¢ˆï¼šä½¿ç”¨ pprof ç­‰å·¥å…·åˆ†ææ€§èƒ½æ•°æ®ï¼Œæ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆã€‚ é’ˆå¯¹æ€§ä¼˜åŒ–ï¼šæ ¹æ®ç“¶é¢ˆç±»å‹ï¼ˆå¦‚ CPUã€å†…å­˜ã€é”ç«äº‰ç­‰ï¼‰é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–æ–¹æ³•ã€‚ éªŒè¯æ•ˆæœï¼šé€šè¿‡æ€§èƒ½æµ‹è¯•éªŒè¯ä¼˜åŒ–æ•ˆæœï¼Œç¡®ä¿ä¼˜åŒ–æ–¹æ¡ˆæœ‰æ•ˆã€‚ ",
  "wordCount" : "3462",
  "inLanguage": "zh",
  "datePublished": "2025-01-25T15:37:01+08:00",
  "dateModified": "2025-01-25T15:37:01+08:00",
  "author":{
    "@type": "Person",
    "name": "ShowGuan"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kennems.github.io/posts/tech/go-3/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Kennem's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kennems.github.io/img/sun.png"
    }
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>




</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kennems.github.io/" accesskey="h" title="Kennem&#39;s Blog (Alt + H)">
                <img src="https://kennems.github.io/img/sun.png" alt="" aria-label="logo"
                    height="35">Kennem&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://kennems.github.io/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/archives" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/categories" title="ğŸ—‚ï¸åˆ†ç±»">
                    <span>ğŸ—‚ï¸åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="https://kennems.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://kennems.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://kennems.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://kennems.github.io/posts/tech/">ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title entry-hint-parent">
      Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜
    </h1>
    <div class="post-description">
      Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜
    </div>
    <div class="post-meta"><span title='2025-01-25 15:37:01 +0800 CST'>2025-01-25</span>&nbsp;Â·&nbsp;7 åˆ†é’Ÿ&nbsp;Â·&nbsp;3462 å­—&nbsp;Â·&nbsp;updated:&nbsp;2025-01-25&nbsp;Â·&nbsp;ShowGuan

</div>
    
     <div class="post-password">
        
    </div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#go-%e9%ab%98%e8%b4%a8%e9%87%8f%e7%bc%96%e7%a8%8b%e4%b8%8e%e6%80%a7%e8%83%bd%e8%b0%83%e4%bc%98" aria-label="Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜</a><ul>
                            
                    <li>
                        <a href="#01-%e9%ab%98%e8%b4%a8%e9%87%8f%e7%bc%96%e7%a8%8b" aria-label="01 é«˜è´¨é‡ç¼–ç¨‹">01 é«˜è´¨é‡ç¼–ç¨‹</a><ul>
                            
                    <li>
                        <a href="#11-%e7%bc%96%e7%a8%8b%e5%8e%9f%e5%88%99" aria-label="1.1 ç¼–ç¨‹åŸåˆ™">1.1 ç¼–ç¨‹åŸåˆ™</a></li>
                    <li>
                        <a href="#12-%e7%bc%96%e7%a0%81%e8%a7%84%e8%8c%83" aria-label="1.2 ç¼–ç è§„èŒƒ">1.2 ç¼–ç è§„èŒƒ</a><ul>
                            
                    <li>
                        <a href="#121-%e4%bb%a3%e7%a0%81%e6%a0%bc%e5%bc%8f" aria-label="1.2.1 ä»£ç æ ¼å¼">1.2.1 ä»£ç æ ¼å¼</a></li>
                    <li>
                        <a href="#122-%e6%b3%a8%e9%87%8a" aria-label="1.2.2 æ³¨é‡Š">1.2.2 æ³¨é‡Š</a></li>
                    <li>
                        <a href="#123-%e5%91%bd%e5%90%8d%e8%a7%84%e8%8c%83" aria-label="1.2.3 å‘½åè§„èŒƒ">1.2.3 å‘½åè§„èŒƒ</a></li>
                    <li>
                        <a href="#124-%e6%8e%a7%e5%88%b6%e6%b5%81%e7%a8%8b" aria-label="1.2.4 æ§åˆ¶æµç¨‹">1.2.4 æ§åˆ¶æµç¨‹</a></li>
                    <li>
                        <a href="#125-%e9%94%99%e8%af%af%e5%92%8c%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="1.2.5 é”™è¯¯å’Œå¼‚å¸¸å¤„ç†">1.2.5 é”™è¯¯å’Œå¼‚å¸¸å¤„ç†</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#02-%e6%80%a7%e8%83%bd%e8%b0%83%e4%bc%98%e5%ae%9e%e6%88%98" aria-label="02 æ€§èƒ½è°ƒä¼˜å®æˆ˜">02 æ€§èƒ½è°ƒä¼˜å®æˆ˜</a><ul>
                            
                    <li>
                        <a href="#21-%e6%80%a7%e8%83%bd%e8%b0%83%e4%bc%98%e5%8e%9f%e5%88%99" aria-label="2.1 æ€§èƒ½è°ƒä¼˜åŸåˆ™">2.1 æ€§èƒ½è°ƒä¼˜åŸåˆ™</a></li>
                    <li>
                        <a href="#22-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e6%8a%80%e5%b7%a7" aria-label="2.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§">2.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§</a><ul>
                            
                    <li>
                        <a href="#221-slice-%e4%bc%98%e5%8c%96" aria-label="2.2.1 Slice ä¼˜åŒ–">2.2.1 Slice ä¼˜åŒ–</a></li>
                    <li>
                        <a href="#222-map-%e4%bc%98%e5%8c%96" aria-label="2.2.2 Map ä¼˜åŒ–">2.2.2 Map ä¼˜åŒ–</a></li>
                    <li>
                        <a href="#223-%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%a4%84%e7%90%86" aria-label="2.2.3 å­—ç¬¦ä¸²å¤„ç†">2.2.3 å­—ç¬¦ä¸²å¤„ç†</a></li>
                    <li>
                        <a href="#224-%e7%a9%ba%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="2.2.4 ç©ºç»“æ„ä½“">2.2.4 ç©ºç»“æ„ä½“</a></li>
                    <li>
                        <a href="#225-atomic-%e5%8c%85" aria-label="2.2.5 Atomic åŒ…">2.2.5 Atomic åŒ…</a></li></ul>
                    </li>
                    <li>
                        <a href="#23-%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%b7%a5%e5%85%b7-pprof" aria-label="2.3 æ€§èƒ½åˆ†æå·¥å…· pprof">2.3 æ€§èƒ½åˆ†æå·¥å…· pprof</a><ul>
                            
                    <li>
                        <a href="#231-cpu-%e5%88%86%e6%9e%90" aria-label="2.3.1 CPU åˆ†æ">2.3.1 CPU åˆ†æ</a></li>
                    <li>
                        <a href="#232-heap-%e5%88%86%e6%9e%90" aria-label="2.3.2 Heap åˆ†æ">2.3.2 Heap åˆ†æ</a></li>
                    <li>
                        <a href="#233-goroutine-%e5%88%86%e6%9e%90" aria-label="2.3.3 Goroutine åˆ†æ">2.3.3 Goroutine åˆ†æ</a></li>
                    <li>
                        <a href="#234-mutex-%e5%88%86%e6%9e%90" aria-label="2.3.4 Mutex åˆ†æ">2.3.4 Mutex åˆ†æ</a></li>
                    <li>
                        <a href="#235-block-%e5%88%86%e6%9e%90" aria-label="2.3.5 Block åˆ†æ">2.3.5 Block åˆ†æ</a></li></ul>
                    </li>
                    <li>
                        <a href="#24-%e6%80%a7%e8%83%bd%e8%b0%83%e4%bc%98%e6%a1%88%e4%be%8b" aria-label="2.4 æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹">2.4 æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹</a><ul>
                            
                    <li>
                        <a href="#241-%e4%b8%9a%e5%8a%a1%e6%9c%8d%e5%8a%a1%e4%bc%98%e5%8c%96" aria-label="2.4.1 ä¸šåŠ¡æœåŠ¡ä¼˜åŒ–">2.4.1 ä¸šåŠ¡æœåŠ¡ä¼˜åŒ–</a></li>
                    <li>
                        <a href="#242-%e5%9f%ba%e7%a1%80%e5%ba%93%e4%bc%98%e5%8c%96" aria-label="2.4.2 åŸºç¡€åº“ä¼˜åŒ–">2.4.2 åŸºç¡€åº“ä¼˜åŒ–</a></li>
                    <li>
                        <a href="#243-go-%e8%af%ad%e8%a8%80%e4%bc%98%e5%8c%96" aria-label="2.4.3 Go è¯­è¨€ä¼˜åŒ–">2.4.3 Go è¯­è¨€ä¼˜åŒ–</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h1 id="go-é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">Go é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜<a hidden class="anchor" aria-hidden="true" href="#go-é«˜è´¨é‡ç¼–ç¨‹ä¸æ€§èƒ½è°ƒä¼˜">#</a></h1>
<p>æœ¬æ–‡æ·±å…¥æ¢è®¨ Go è¯­è¨€çš„é«˜è´¨é‡ç¼–ç¨‹å’Œæ€§èƒ½è°ƒä¼˜ï¼Œç»“åˆå…·ä½“ç¤ºä¾‹ï¼Œå¸®åŠ©ä½ ç¼–å†™æ­£ç¡®å¯é ã€ç®€æ´æ¸…æ™°çš„ä»£ç ï¼Œå¹¶æŒæ¡æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ–¹æ³•ã€‚</p>
<hr>
<h2 id="01-é«˜è´¨é‡ç¼–ç¨‹">01 é«˜è´¨é‡ç¼–ç¨‹<a hidden class="anchor" aria-hidden="true" href="#01-é«˜è´¨é‡ç¼–ç¨‹">#</a></h2>
<p>é«˜è´¨é‡ä»£ç çš„ç›®æ ‡æ˜¯<strong>æ­£ç¡®å¯é ã€ç®€æ´æ¸…æ™°</strong>ã€‚ä»¥ä¸‹æ˜¯å®ç°é«˜è´¨é‡ç¼–ç¨‹çš„å…³é”®ç‚¹ã€‚</p>
<h3 id="11-ç¼–ç¨‹åŸåˆ™">1.1 ç¼–ç¨‹åŸåˆ™<a hidden class="anchor" aria-hidden="true" href="#11-ç¼–ç¨‹åŸåˆ™">#</a></h3>
<ul>
<li><strong>ç®€å•æ€§</strong>ï¼šä»£ç é€»è¾‘ç®€å•ï¼Œæ˜“äºç†è§£ã€‚</li>
<li><strong>å¯è¯»æ€§</strong>ï¼šä»£ç æ˜“äºé˜…è¯»ï¼Œå‘½åæ¸…æ™°ï¼Œç»“æ„åˆç†ã€‚</li>
<li><strong>ç”Ÿäº§åŠ›</strong>ï¼šä»£ç æ˜“äºç»´æŠ¤å’Œæ‰©å±•ï¼Œå‡å°‘é‡å¤åŠ³åŠ¨ã€‚</li>
</ul>
<h3 id="12-ç¼–ç è§„èŒƒ">1.2 ç¼–ç è§„èŒƒ<a hidden class="anchor" aria-hidden="true" href="#12-ç¼–ç è§„èŒƒ">#</a></h3>
<h4 id="121-ä»£ç æ ¼å¼">1.2.1 ä»£ç æ ¼å¼<a hidden class="anchor" aria-hidden="true" href="#121-ä»£ç æ ¼å¼">#</a></h4>
<ul>
<li>ä½¿ç”¨ <code>gofmt</code> å’Œ <code>goimports</code> è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ã€‚</li>
<li>ä¿æŒä¸€è‡´çš„ä»£ç é£æ ¼ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šæ ¼å¼åŒ–ä»£ç </strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨ gofmt æ ¼å¼åŒ–ä»£ç </span>
</span></span><span style="display:flex;"><span>gofmt -w main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨ goimports è‡ªåŠ¨æ·»åŠ å’Œåˆ é™¤å¯¼å…¥</span>
</span></span><span style="display:flex;"><span>goimports -w main.go
</span></span></code></pre></div><h4 id="122-æ³¨é‡Š">1.2.2 æ³¨é‡Š<a hidden class="anchor" aria-hidden="true" href="#122-æ³¨é‡Š">#</a></h4>
<ul>
<li><strong>æ³¨é‡Šå†…å®¹</strong>ï¼š
<ul>
<li>è§£é‡Šä»£ç çš„ä½œç”¨ã€‚</li>
<li>è§£é‡Šä»£ç çš„å®ç°é€»è¾‘ã€‚</li>
<li>è§£é‡Šä»£ç çš„è®¾è®¡åŸå› ã€‚</li>
<li>è§£é‡Šä»£ç å¯èƒ½å‡ºé”™çš„æƒ…å†µã€‚</li>
</ul>
</li>
<li><strong>æ³¨é‡ŠåŸåˆ™</strong>ï¼š
<ul>
<li>ä»£ç æ˜¯æœ€å¥½çš„æ³¨é‡Šã€‚</li>
<li>æ³¨é‡Šåº”æä¾›ä»£ç æœªè¡¨è¾¾çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šæ³¨é‡Š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// CalculateSum è®¡ç®—ä¸¤ä¸ªæ•´æ•°çš„å’Œã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å¦‚æœè¾“å…¥ä¸ºè´Ÿæ•°ï¼Œè¿”å›é”™è¯¯ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CalculateSum</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span> &lt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">b</span> &lt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;negative input not allowed&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="123-å‘½åè§„èŒƒ">1.2.3 å‘½åè§„èŒƒ<a hidden class="anchor" aria-hidden="true" href="#123-å‘½åè§„èŒƒ">#</a></h4>
<ul>
<li><strong>å˜é‡å</strong>ï¼š
<ul>
<li>ç®€æ´èƒœäºå†—é•¿ã€‚</li>
<li>ç¼©ç•¥è¯å…¨å¤§å†™ï¼ˆå¦‚ <code>HTTP</code>ï¼‰ï¼Œä½äºå˜é‡å¼€å¤´ä¸”ä¸éœ€è¦å¯¼å‡ºæ—¶ä½¿ç”¨å…¨å°å†™ï¼ˆå¦‚ <code>httpClient</code>ï¼‰ã€‚</li>
<li>å˜é‡è·ç¦»ä½¿ç”¨å¤„è¶Šè¿œï¼Œå‘½ååº”åŒ…å«è¶Šå¤šä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li><strong>å‡½æ•°å</strong>ï¼š
<ul>
<li>å‡½æ•°ååº”ç®€çŸ­ï¼Œä¸æºå¸¦åŒ…åä¸Šä¸‹æ–‡ã€‚</li>
<li>å½“å‡½æ•°è¿”å›ç±»å‹ä¸åŒ…åç›¸åŒæ—¶ï¼Œå¯çœç•¥ç±»å‹ä¿¡æ¯ï¼ˆå¦‚ <code>foo.New()</code> è¿”å› <code>Foo</code>ï¼‰ã€‚</li>
<li>å½“å‡½æ•°è¿”å›ç±»å‹ä¸åŒ…åä¸åŒæ—¶ï¼Œåº”åœ¨å‡½æ•°åä¸­åŠ å…¥ç±»å‹ä¿¡æ¯ï¼ˆå¦‚ <code>foo.NewBar()</code>ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>åŒ…å</strong>ï¼š
<ul>
<li>åªä½¿ç”¨å°å†™å­—æ¯ï¼Œä¸åŒ…å«å¤§å†™å­—æ¯æˆ–ä¸‹åˆ’çº¿ã€‚</li>
<li>ç®€çŸ­ä¸”åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚ <code>schema</code>ã€<code>task</code>ï¼‰ã€‚</li>
<li>é¿å…ä¸æ ‡å‡†åº“åŒåï¼ˆå¦‚ <code>sync</code>ã€<code>strings</code>ï¼‰ã€‚</li>
<li>ä½¿ç”¨å•æ•°å½¢å¼ï¼ˆå¦‚ <code>log</code> è€Œä¸æ˜¯ <code>logs</code>ï¼‰ã€‚</li>
<li>è°¨æ…ä½¿ç”¨ç¼©å†™ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šå‘½åè§„èŒƒ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// å˜é‡å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">maxRetryCount</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">httpClient</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‡½æ•°å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUser</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">User</span>{}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserFromDB</span>(<span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DB</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">db</span>: <span style="color:#a6e22e">db</span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŒ…å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">user</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">task</span>
</span></span></code></pre></div><h4 id="124-æ§åˆ¶æµç¨‹">1.2.4 æ§åˆ¶æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#124-æ§åˆ¶æµç¨‹">#</a></h4>
<ul>
<li>é¿å…åµŒå¥—ï¼Œä¿æŒæ­£å¸¸æµç¨‹æ¸…æ™°ã€‚</li>
<li>å°½é‡ä¿æŒæ­£å¸¸ä»£ç è·¯å¾„ä¸ºæœ€å°ç¼©è¿›ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šæ§åˆ¶æµç¨‹ä¼˜åŒ–</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ä¸æ¨èï¼šåµŒå¥—è¿‡æ·±
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">data</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">data</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">item</span> &gt; <span style="color:#ae81ff">10</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">item</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ¨èï¼šå‡å°‘åµŒå¥—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">data</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">data</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">item</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">item</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="125-é”™è¯¯å’Œå¼‚å¸¸å¤„ç†">1.2.5 é”™è¯¯å’Œå¼‚å¸¸å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#125-é”™è¯¯å’Œå¼‚å¸¸å¤„ç†">#</a></h4>
<ul>
<li><strong>ç®€å•é”™è¯¯</strong>ï¼šä½¿ç”¨ <code>errors.New</code> æˆ– <code>fmt.Errorf</code> åˆ›å»ºé”™è¯¯ã€‚</li>
<li><strong>é”™è¯¯åŒ…è£…</strong>ï¼šä½¿ç”¨ <code>fmt.Errorf</code> å’Œ <code>%w</code> åŒ…è£…é”™è¯¯ï¼Œä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯ã€‚</li>
<li><strong>é”™è¯¯åˆ¤å®š</strong>ï¼šä½¿ç”¨ <code>errors.Is</code> å’Œ <code>errors.As</code> åˆ¤æ–­é”™è¯¯ç±»å‹ã€‚</li>
<li><strong>Panic</strong>ï¼šä¸å»ºè®®åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨ <code>panic</code>ï¼Œä»…åœ¨ä¸å¯æ¢å¤çš„é”™è¯¯ä¸­ä½¿ç”¨ã€‚</li>
<li><strong>Recover</strong>ï¼šåªèƒ½åœ¨ <code>defer</code> å‡½æ•°ä¸­ä½¿ç”¨ <code>recover</code>ï¼Œç”¨äºæ•è· <code>panic</code>ã€‚</li>
<li><strong>é”™è¯¯ä¿¡æ¯</strong>ï¼šé”™è¯¯åº”æä¾›ç®€æ˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯é“¾ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šé”™è¯¯å¤„ç†</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">readFile</span>(<span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">filename</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to read file: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recovered from panic:&#34;</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    panic(<span style="color:#e6db74">&#34;something went wrong&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="02-æ€§èƒ½è°ƒä¼˜å®æˆ˜">02 æ€§èƒ½è°ƒä¼˜å®æˆ˜<a hidden class="anchor" aria-hidden="true" href="#02-æ€§èƒ½è°ƒä¼˜å®æˆ˜">#</a></h2>
<p>æ€§èƒ½è°ƒä¼˜çš„æ ¸å¿ƒåŸåˆ™æ˜¯<strong>ä¾é æ•°æ®ï¼Œå®šä½ç“¶é¢ˆï¼Œé¿å…è¿‡æ—©å’Œè¿‡åº¦ä¼˜åŒ–</strong>ã€‚</p>
<h3 id="21-æ€§èƒ½è°ƒä¼˜åŸåˆ™">2.1 æ€§èƒ½è°ƒä¼˜åŸåˆ™<a hidden class="anchor" aria-hidden="true" href="#21-æ€§èƒ½è°ƒä¼˜åŸåˆ™">#</a></h3>
<ul>
<li><strong>ä¾é æ•°æ®</strong>ï¼šé€šè¿‡æ€§èƒ½åˆ†æå·¥å…·ï¼ˆå¦‚ <code>pprof</code>ï¼‰è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯çŒœæµ‹ã€‚</li>
<li><strong>å®šä½ç“¶é¢ˆ</strong>ï¼šä¼˜å…ˆä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆï¼Œè€Œä¸æ˜¯ç»†ææœ«èŠ‚ã€‚</li>
<li><strong>é¿å…è¿‡æ—©ä¼˜åŒ–</strong>ï¼šåœ¨ä»£ç ç¨³å®šåå†è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚</li>
<li><strong>é¿å…è¿‡åº¦ä¼˜åŒ–</strong>ï¼šä¼˜åŒ–åº”ä»¥æ»¡è¶³æ€§èƒ½éœ€æ±‚ä¸ºç›®æ ‡ï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–ä»£ç ã€‚</li>
</ul>
<h3 id="22-æ€§èƒ½ä¼˜åŒ–æŠ€å·§">2.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§<a hidden class="anchor" aria-hidden="true" href="#22-æ€§èƒ½ä¼˜åŒ–æŠ€å·§">#</a></h3>
<h4 id="221-slice-ä¼˜åŒ–">2.2.1 Slice ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#221-slice-ä¼˜åŒ–">#</a></h4>
<ul>
<li><strong>é¢„åˆ†é…å†…å­˜</strong>ï¼šä½¿ç”¨ <code>make</code> åˆå§‹åŒ–åˆ‡ç‰‡æ—¶æä¾›å®¹é‡ä¿¡æ¯ï¼Œé¿å…å¤šæ¬¡å†…å­˜åˆ†é…ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šSlice é¢„åˆ†é…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ä¸æ¨èï¼šæœªé¢„åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span> []<span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> = append(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ¨èï¼šé¢„åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> = append(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="222-map-ä¼˜åŒ–">2.2.2 Map ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#222-map-ä¼˜åŒ–">#</a></h4>
<ul>
<li><strong>é¢„åˆ†é…å†…å­˜</strong>ï¼šä½¿ç”¨ <code>make</code> åˆå§‹åŒ– <code>map</code> æ—¶æä¾›å®¹é‡ä¿¡æ¯ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šMap é¢„åˆ†é…</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ä¸æ¨èï¼šæœªé¢„åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;key%d&#34;</span>, <span style="color:#a6e22e">i</span>)] = <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ¨èï¼šé¢„åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;key%d&#34;</span>, <span style="color:#a6e22e">i</span>)] = <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="223-å­—ç¬¦ä¸²å¤„ç†">2.2.3 å­—ç¬¦ä¸²å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#223-å­—ç¬¦ä¸²å¤„ç†">#</a></h4>
<ul>
<li><strong>ä½¿ç”¨ <code>strings.Builder</code></strong>ï¼š<code>strings.Builder</code> æ¯” <code>+</code> æ‹¼æ¥æ€§èƒ½æ›´å¥½ï¼Œä¸ <code>bytes.Buffer</code> æ€§èƒ½ç›¸è¿‘ä½†æ›´å¿«ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šå­—ç¬¦ä¸²æ‹¼æ¥</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ä¸æ¨èï¼šä½¿ç”¨ + æ‹¼æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ¨èï¼šä½¿ç”¨ strings.Builder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">builder</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Builder</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#a6e22e">i</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">String</span>()
</span></span></code></pre></div><h4 id="224-ç©ºç»“æ„ä½“">2.2.4 ç©ºç»“æ„ä½“<a hidden class="anchor" aria-hidden="true" href="#224-ç©ºç»“æ„ä½“">#</a></h4>
<ul>
<li><strong>èŠ‚çœå†…å­˜</strong>ï¼šä½¿ç”¨ç©ºç»“æ„ä½“ <code>struct{}</code> ä½œä¸ºå ä½ç¬¦ï¼Œä¸å ç”¨å†…å­˜ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šç©ºç»“æ„ä½“</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ä½¿ç”¨ç©ºç»“æ„ä½“ä½œä¸ºå ä½ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">set</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">struct</span>{})
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set</span>[<span style="color:#e6db74">&#34;key1&#34;</span>] = <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set</span>[<span style="color:#e6db74">&#34;key2&#34;</span>] = <span style="color:#66d9ef">struct</span>{}{}
</span></span></code></pre></div><h4 id="225-atomic-åŒ…">2.2.5 Atomic åŒ…<a hidden class="anchor" aria-hidden="true" href="#225-atomic-åŒ…">#</a></h4>
<ul>
<li><strong>åŸå­æ“ä½œ</strong>ï¼šä½¿ç”¨ <code>sync/atomic</code> åŒ…å®ç°æ— é”å¹¶å‘æ“ä½œã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šAtomic æ“ä½œ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">counter</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">counter</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Counter:&#34;</span>, <span style="color:#a6e22e">counter</span>)
</span></span></code></pre></div><h3 id="23-æ€§èƒ½åˆ†æå·¥å…·-pprof">2.3 æ€§èƒ½åˆ†æå·¥å…· pprof<a hidden class="anchor" aria-hidden="true" href="#23-æ€§èƒ½åˆ†æå·¥å…·-pprof">#</a></h3>
<p><code>pprof</code> æ˜¯ Go å†…ç½®çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œæ”¯æŒä»¥ä¸‹ç»´åº¦çš„åˆ†æï¼š</p>
<h4 id="231-cpu-åˆ†æ">2.3.1 CPU åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#231-cpu-åˆ†æ">#</a></h4>
<ul>
<li><strong>é‡‡æ ·å¯¹è±¡</strong>ï¼šå‡½æ•°è°ƒç”¨åŠå…¶è€—æ—¶ã€‚</li>
<li><strong>é‡‡æ ·ç‡</strong>ï¼šæ¯ç§’ 100 æ¬¡ã€‚</li>
<li><strong>é‡‡æ ·æ—¶é—´</strong>ï¼šæ‰‹åŠ¨å¯åŠ¨åˆ°æ‰‹åŠ¨ç»“æŸã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šCPU åˆ†æ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;runtime/pprof&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;cpu.prof&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">StartCPUProfile</span>(<span style="color:#a6e22e">f</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">StopCPUProfile</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸šåŠ¡ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">1000000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="232-heap-åˆ†æ">2.3.2 Heap åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#232-heap-åˆ†æ">#</a></h4>
<ul>
<li><strong>é‡‡æ ·å¯¹è±¡</strong>ï¼šå †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚</li>
<li><strong>é‡‡æ ·ç‡</strong>ï¼šæ¯åˆ†é… 512KB è®°å½•ä¸€æ¬¡ã€‚</li>
<li><strong>é‡‡æ ·æŒ‡æ ‡</strong>ï¼š
<ul>
<li><code>alloc_space</code>ï¼šåˆ†é…çš„å†…å­˜æ€»é‡ã€‚</li>
<li><code>alloc_objects</code>ï¼šåˆ†é…çš„å¯¹è±¡æ•°é‡ã€‚</li>
<li><code>inuse_space</code>ï¼šæ­£åœ¨ä½¿ç”¨çš„å†…å­˜é‡ã€‚</li>
<li><code>inuse_objects</code>ï¼šæ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡æ•°é‡ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šHeap åˆ†æ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;runtime/pprof&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;heap.prof&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸šåŠ¡ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span> []<span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">1000000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">s</span> = append(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">WriteHeapProfile</span>(<span style="color:#a6e22e">f</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="233-goroutine-åˆ†æ">2.3.3 Goroutine åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#233-goroutine-åˆ†æ">#</a></h4>
<ul>
<li><strong>é‡‡æ ·å¯¹è±¡</strong>ï¼šæ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ Goroutineã€‚</li>
<li><strong>é‡‡æ ·æŒ‡æ ‡</strong>ï¼šGoroutine çš„æ•°é‡å’Œè°ƒç”¨æ ˆä¿¡æ¯ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šGoroutine åˆ†æ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;runtime/pprof&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;goroutine.prof&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸šåŠ¡ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>        }()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">Lookup</span>(<span style="color:#e6db74">&#34;goroutine&#34;</span>).<span style="color:#a6e22e">WriteTo</span>(<span style="color:#a6e22e">f</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="234-mutex-åˆ†æ">2.3.4 Mutex åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#234-mutex-åˆ†æ">#</a></h4>
<ul>
<li><strong>é‡‡æ ·å¯¹è±¡</strong>ï¼šé”ç«äº‰çš„æ¬¡æ•°å’Œè€—æ—¶ã€‚</li>
<li><strong>é‡‡æ ·ç‡</strong>ï¼šåªè®°å½•å›ºå®šæ¯”ä¾‹çš„é”æ“ä½œã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šMutex åˆ†æ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;runtime/pprof&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;mutex.prof&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mu</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>        }()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">Lookup</span>(<span style="color:#e6db74">&#34;mutex&#34;</span>).<span style="color:#a6e22e">WriteTo</span>(<span style="color:#a6e22e">f</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="235-block-åˆ†æ">2.3.5 Block åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#235-block-åˆ†æ">#</a></h4>
<ul>
<li><strong>é‡‡æ ·å¯¹è±¡</strong>ï¼šé˜»å¡æ“ä½œçš„æ¬¡æ•°å’Œè€—æ—¶ã€‚</li>
<li><strong>é‡‡æ ·ç‡</strong>ï¼šé˜»å¡è€—æ—¶è¶…è¿‡é˜ˆå€¼çš„æ“ä½œæ‰ä¼šè¢«è®°å½•ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šBlock åˆ†æ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;runtime/pprof&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#e6db74">&#34;block.prof&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mu</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>        }()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">Lookup</span>(<span style="color:#e6db74">&#34;block&#34;</span>).<span style="color:#a6e22e">WriteTo</span>(<span style="color:#a6e22e">f</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="24-æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹">2.4 æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹<a hidden class="anchor" aria-hidden="true" href="#24-æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹">#</a></h3>
<p>æ€§èƒ½è°ƒä¼˜çš„æ ¸å¿ƒåœ¨äº<strong>å®šä½ç“¶é¢ˆ</strong>å¹¶<strong>é’ˆå¯¹æ€§åœ°ä¼˜åŒ–</strong>ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå…¸å‹çš„æ€§èƒ½è°ƒä¼˜æ¡ˆä¾‹ï¼Œç»“åˆå…·ä½“é—®é¢˜å’Œä¼˜åŒ–æ–¹æ³•ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨æ€§èƒ½è°ƒä¼˜æŠ€å·§ã€‚</p>
<hr>
<h4 id="241-ä¸šåŠ¡æœåŠ¡ä¼˜åŒ–">2.4.1 ä¸šåŠ¡æœåŠ¡ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#241-ä¸šåŠ¡æœåŠ¡ä¼˜åŒ–">#</a></h4>
<p><strong>é—®é¢˜æè¿°</strong><br>
æŸä¸šåŠ¡æœåŠ¡çš„æ¥å£å“åº”æ—¶é—´è¾ƒé•¿ï¼Œç”¨æˆ·è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡ 500msï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸‹é™ã€‚</p>
<p><strong>åˆ†æè¿‡ç¨‹</strong></p>
<ol>
<li>
<p><strong>ä½¿ç”¨ <code>pprof</code> è¿›è¡Œæ€§èƒ½åˆ†æ</strong>ï¼š</p>
<ul>
<li>å¯åŠ¨ <code>pprof</code> çš„ CPU å’Œ Heap åˆ†æï¼Œå‘ç°æ•°æ®åº“æŸ¥è¯¢å ç”¨äº† 70% çš„ CPU æ—¶é—´ã€‚</li>
<li>è¿›ä¸€æ­¥åˆ†æå‘ç°ï¼ŒæŸäº› SQL æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æ‰«æã€‚</li>
</ul>
</li>
<li>
<p><strong>å®šä½ç“¶é¢ˆ</strong>ï¼š</p>
<ul>
<li>é€šè¿‡æ—¥å¿—å’Œ <code>pprof</code> æ•°æ®ï¼Œå®šä½åˆ°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š
<ul>
<li>é«˜é¢‘æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•ã€‚</li>
<li>éƒ¨åˆ†æŸ¥è¯¢è¿”å›è¿‡å¤šæ— ç”¨æ•°æ®ã€‚</li>
<li>é‡å¤æŸ¥è¯¢ç›¸åŒæ•°æ®ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong></p>
<ol>
<li>
<p><strong>ä¼˜åŒ– SQL æŸ¥è¯¢</strong>ï¼š</p>
<ul>
<li>ä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•ã€‚</li>
<li>ä½¿ç”¨ <code>SELECT</code> åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œé¿å…è¿”å›è¿‡å¤šæ•°æ®ã€‚</li>
<li>ä½¿ç”¨ <code>EXPLAIN</code> åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼Œç¡®ä¿æŸ¥è¯¢æ•ˆç‡ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šä¼˜åŒ– SQL æŸ¥è¯¢</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- ä¼˜åŒ–å‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">WHERE</span> age <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ä¼˜åŒ–å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> id, name <span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">WHERE</span> age <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> idx_age <span style="color:#66d9ef">ON</span> users(age);
</span></span></code></pre></div></li>
<li>
<p><strong>å¼•å…¥ç¼“å­˜</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ Redis ç¼“å­˜é«˜é¢‘æŸ¥è¯¢ç»“æœï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ã€‚</li>
<li>è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šä½¿ç”¨ Redis ç¼“å­˜</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getUserFromCache</span>(<span style="color:#a6e22e">userID</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cacheKey</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;user:%d&#34;</span>, <span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redisClient</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">cacheKey</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">GetUser</span>(<span style="color:#a6e22e">userID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†ç»“æœå†™å…¥ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">redisClient</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">cacheKey</span>, <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>ä¼˜åŒ–ç»“æœ</strong>ï¼š</p>
<ul>
<li>æ¥å£å“åº”æ—¶é—´ä» 500ms é™ä½åˆ° 50msã€‚</li>
<li>æ•°æ®åº“ CPU ä½¿ç”¨ç‡ä» 70% é™ä½åˆ° 20%ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h4 id="242-åŸºç¡€åº“ä¼˜åŒ–">2.4.2 åŸºç¡€åº“ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#242-åŸºç¡€åº“ä¼˜åŒ–">#</a></h4>
<p><strong>é—®é¢˜æè¿°</strong><br>
æŸåŸºç¡€åº“åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½ä¸è¶³ï¼Œè¡¨ç°ä¸ºå†…å­˜åˆ†é…é¢‘ç¹ã€é”ç«äº‰æ¿€çƒˆï¼Œå¯¼è‡´æœåŠ¡ååé‡ä¸‹é™ã€‚</p>
<p><strong>åˆ†æè¿‡ç¨‹</strong></p>
<ol>
<li>
<p><strong>ä½¿ç”¨ <code>pprof</code> è¿›è¡Œæ€§èƒ½åˆ†æ</strong>ï¼š</p>
<ul>
<li>é€šè¿‡ Heap åˆ†æå‘ç°ï¼Œå¤§é‡å†…å­˜åˆ†é…æ¥è‡ªäºä¸´æ—¶å¯¹è±¡çš„åˆ›å»ºã€‚</li>
<li>é€šè¿‡ Mutex åˆ†æå‘ç°ï¼ŒæŸäº›é”çš„ç«äº‰éå¸¸æ¿€çƒˆã€‚</li>
</ul>
</li>
<li>
<p><strong>å®šä½ç“¶é¢ˆ</strong>ï¼š</p>
<ul>
<li>é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ä¸´æ—¶å¯¹è±¡ï¼Œå¯¼è‡´ GC å‹åŠ›å¤§ã€‚</li>
<li>é”ç«äº‰å¯¼è‡´ Goroutine é˜»å¡ï¼Œå½±å“å¹¶å‘æ€§èƒ½ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong></p>
<ol>
<li>
<p><strong>ä½¿ç”¨ <code>sync.Pool</code> å‡å°‘å†…å­˜åˆ†é…</strong>ï¼š</p>
<ul>
<li>é€šè¿‡å¯¹è±¡æ± å¤ç”¨ä¸´æ—¶å¯¹è±¡ï¼Œå‡å°‘å†…å­˜åˆ†é…å’Œ GC å‹åŠ›ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šä½¿ç”¨ <code>sync.Pool</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">bufferPool</span> = <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">New</span>: <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">interface</span>{} {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> new(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getBuffer</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">bufferPool</span>.<span style="color:#a6e22e">Get</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">putBuffer</span>(<span style="color:#a6e22e">buf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Reset</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bufferPool</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>ä½¿ç”¨ <code>atomic</code> å‡å°‘é”ç«äº‰</strong>ï¼š</p>
<ul>
<li>å°†éƒ¨åˆ†é”ä¿æŠ¤çš„æ“ä½œæ›¿æ¢ä¸ºåŸå­æ“ä½œï¼Œå‡å°‘é”ç«äº‰ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šä½¿ç”¨ <code>atomic</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">counter</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">incrementCounter</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">counter</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getCounter</span>() <span style="color:#66d9ef">int64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">counter</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>ä¼˜åŒ–ç»“æœ</strong>ï¼š</p>
<ul>
<li>å†…å­˜åˆ†é…å‡å°‘ 50%ï¼ŒGC å‹åŠ›æ˜¾è‘—é™ä½ã€‚</li>
<li>é”ç«äº‰å‡å°‘ï¼ŒæœåŠ¡ååé‡æå‡ 30%ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h4 id="243-go-è¯­è¨€ä¼˜åŒ–">2.4.3 Go è¯­è¨€ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#243-go-è¯­è¨€ä¼˜åŒ–">#</a></h4>
<p><strong>é—®é¢˜æè¿°</strong>
æŸæœåŠ¡åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒGCï¼ˆåƒåœ¾å›æ”¶ï¼‰å‹åŠ›è¾ƒå¤§ï¼Œå¯¼è‡´æœåŠ¡å‡ºç°å‘¨æœŸæ€§å»¶è¿Ÿã€‚</p>
<p><strong>åˆ†æè¿‡ç¨‹</strong></p>
<ol>
<li>
<p><strong>ä½¿ç”¨ <code>pprof</code> è¿›è¡Œæ€§èƒ½åˆ†æ</strong>ï¼š</p>
<ul>
<li>é€šè¿‡ Heap åˆ†æå‘ç°ï¼Œå †å†…å­˜ä¸­å­˜åœ¨å¤§é‡çŸ­æœŸå¯¹è±¡ã€‚</li>
<li>é€šè¿‡ Goroutine åˆ†æå‘ç°ï¼ŒGoroutine æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´è°ƒåº¦å¼€é”€å¢åŠ ã€‚</li>
</ul>
</li>
<li>
<p><strong>å®šä½ç“¶é¢ˆ</strong>ï¼š</p>
<ul>
<li>é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çŸ­æœŸå¯¹è±¡ï¼Œå¯¼è‡´ GC é¢‘ç¹è§¦å‘ã€‚</li>
<li>Goroutine æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´è°ƒåº¦å™¨è´Ÿè½½è¿‡é«˜ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong></p>
<ol>
<li>
<p><strong>å‡å°‘å †å†…å­˜åˆ†é…</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨æ ˆåˆ†é…ä»£æ›¿å †åˆ†é…ï¼Œå‡å°‘ GC å‹åŠ›ã€‚</li>
<li>å¤ç”¨å¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šå¤ç”¨å¯¹è±¡</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userPool</span> = <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">New</span>: <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">interface</span>{} {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> new(<span style="color:#a6e22e">User</span>)
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getUser</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">userPool</span>.<span style="color:#a6e22e">Get</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">putUser</span>(<span style="color:#a6e22e">user</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Reset</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userPool</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>æ§åˆ¶ Goroutine æ•°é‡</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ Goroutine æ± é™åˆ¶å¹¶å‘æ•°é‡ï¼Œé¿å… Goroutine æ•°é‡è¿‡å¤šã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼šä½¿ç”¨ Goroutine æ± </strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">workerPool</span>(<span style="color:#a6e22e">workerNum</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">tasks</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">func</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">workerNum</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">task</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tasks</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">task</span>()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>ä¼˜åŒ–ç»“æœ</strong>ï¼š</p>
<ul>
<li>GC é¢‘ç‡é™ä½ï¼ŒæœåŠ¡å»¶è¿Ÿå‡å°‘ã€‚</li>
<li>Goroutine æ•°é‡æ§åˆ¶åœ¨åˆç†èŒƒå›´ï¼Œè°ƒåº¦å¼€é”€é™ä½ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h3 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h3>
<p>é€šè¿‡ä»¥ä¸Šæ¡ˆä¾‹å¯ä»¥çœ‹å‡ºï¼Œæ€§èƒ½è°ƒä¼˜çš„å…³é”®åœ¨äºï¼š</p>
<ol>
<li><strong>å®šä½ç“¶é¢ˆ</strong>ï¼šä½¿ç”¨ <code>pprof</code> ç­‰å·¥å…·åˆ†ææ€§èƒ½æ•°æ®ï¼Œæ‰¾åˆ°çœŸæ­£çš„ç“¶é¢ˆã€‚</li>
<li><strong>é’ˆå¯¹æ€§ä¼˜åŒ–</strong>ï¼šæ ¹æ®ç“¶é¢ˆç±»å‹ï¼ˆå¦‚ CPUã€å†…å­˜ã€é”ç«äº‰ç­‰ï¼‰é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–æ–¹æ³•ã€‚</li>
<li><strong>éªŒè¯æ•ˆæœ</strong>ï¼šé€šè¿‡æ€§èƒ½æµ‹è¯•éªŒè¯ä¼˜åŒ–æ•ˆæœï¼Œç¡®ä¿ä¼˜åŒ–æ–¹æ¡ˆæœ‰æ•ˆã€‚</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kennems.github.io/tags/golang/">GoLang</a></li>
    </ul>
        
    
    <ul id="categories">
      
        <li><a href="https://kennems.github.io/categories/go">Go</a> </li>
      
    </ul>
    
    
<nav class="paginav">
  <a class="prev" href="https://kennems.github.io/posts/tech/go-2/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Go å¹¶å‘ä¸ä¾èµ–ç®¡ç†</span>
  </a>
  <a class="next" href="https://kennems.github.io/posts/tech/go-4/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Go å†…å­˜ç®¡ç†ä¸ç¼–è¯‘å™¨ä¼˜åŒ–</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://kennems.github.io/">Kennem&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
<footer class="footer">
    <script async src="https://busuanzi.sukap.cn/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        Visitors: <span id="busuanzi_value_page_uv"></span>
        Views: <span id="busuanzi_value_page_pv"></span>

        
    </span>
</footer>



</body>

</html>
